define("MSG/model_8c0b0872",["require","exports","./vendor_a1b6b414"],(function(t,e,n){"use strict";function r(t){return("undefined"!=typeof window?window:self)[t]}var s=r("Map"),i=r("Set"),o="okMessenger",a=!1,c=0;function u(){try{return window.caches&&"function"==typeof window.caches.open&&!a}catch(t){return!1}}function d(t){return new Promise((function(e,n){if(!u())return e(null);window.caches.open(o).catch((function(){a=!0})).then((function(e){return e&&e.match(f(t))})).then((function(t){return t?t.json():null})).then(e,n)})).catch((function(){return null}))}function h(t,e){if(u()){var n;try{n=new Response(JSON.stringify(e),{headers:{"Content-Type":"application/json"}})}catch(t){++c>=3&&(a=!0)}n&&window.caches.open(o).catch((function(){a=!0})).then((function(e){return e&&e.put(f(t),n)})).catch((function(){++c>=3&&(a=!0)}))}}function f(t){return"https://ok.ru/ok-messages/".concat(t,".json")}var l={__proto__:null,supportsCache:u,getCache:d,putCache:h},p=function(t,e){return p=Object.setPrototypeOf||{__proto__:[]}instanceof Array&&function(t,e){t.__proto__=e}||function(t,e){for(var n in e)e.hasOwnProperty(n)&&(t[n]=e[n])},p(t,e)};
/*! *****************************************************************************
    Copyright (c) Microsoft Corporation. All rights reserved.
    Licensed under the Apache License, Version 2.0 (the "License"); you may not use
    this file except in compliance with the License. You may obtain a copy of the
    License at http://www.apache.org/licenses/LICENSE-2.0

    THIS CODE IS PROVIDED ON AN *AS IS* BASIS, WITHOUT WARRANTIES OR CONDITIONS OF ANY
    KIND, EITHER EXPRESS OR IMPLIED, INCLUDING WITHOUT LIMITATION ANY IMPLIED
    WARRANTIES OR CONDITIONS OF TITLE, FITNESS FOR A PARTICULAR PURPOSE,
    MERCHANTABLITY OR NON-INFRINGEMENT.

    See the Apache Version 2.0 License for specific language governing permissions
    and limitations under the License.
    ***************************************************************************** */function g(t,e){function n(){this.constructor=t}p(t,e),t.prototype=null===e?Object.create(e):(n.prototype=e.prototype,new n)}var v=function(){return v=Object.assign||function(t){for(var e,n=arguments,r=1,s=arguments.length;r<s;r++)for(var i in e=n[r])Object.prototype.hasOwnProperty.call(e,i)&&(t[i]=e[i]);return t},v.apply(this,arguments)};function m(t,e,n,r){return new(n||(n=Promise))((function(s,i){function o(t){try{c(r.next(t))}catch(t){i(t)}}function a(t){try{c(r.throw(t))}catch(t){i(t)}}function c(t){t.done?s(t.value):new n((function(e){e(t.value)})).then(o,a)}c((r=r.apply(t,e||[])).next())}))}function y(t,e){var n,r,s,i,o={label:0,sent:function(){if(1&s[0])throw s[1];return s[1]},trys:[],ops:[]};return i={next:a(0),throw:a(1),return:a(2)},"function"==typeof Symbol&&(i[Symbol.iterator]=function(){return this}),i;function a(i){return function(a){return function(i){if(n)throw new TypeError("Generator is already executing.");for(;o;)try{if(n=1,r&&(s=2&i[0]?r.return:i[0]?r.throw||((s=r.return)&&s.call(r),0):r.next)&&!(s=s.call(r,i[1])).done)return s;switch(r=0,s&&(i=[2&i[0],s.value]),i[0]){case 0:case 1:s=i;break;case 4:return o.label++,{value:i[1],done:!1};case 5:o.label++,r=i[1],i=[0];continue;case 7:i=o.ops.pop(),o.trys.pop();continue;default:if(!(s=o.trys,(s=s.length>0&&s[s.length-1])||6!==i[0]&&2!==i[0])){o=0;continue}if(3===i[0]&&(!s||i[1]>s[0]&&i[1]<s[3])){o.label=i[1];break}if(6===i[0]&&o.label<s[1]){o.label=s[1],s=i;break}if(s&&o.label<s[2]){o.label=s[2],o.ops.push(i);break}s[2]&&o.ops.pop(),o.trys.pop();continue}i=e.call(t,o)}catch(t){i=[6,t],r=0}finally{n=s=0}if(5&i[0])throw i[1];return{value:i[0]?i[1]:void 0,done:!0}}([i,a])}}}function _(){for(var t=arguments,e=0,n=0,r=arguments.length;n<r;n++)e+=t[n].length;var s=Array(e),i=0;for(n=0;n<r;n++)for(var o=arguments[n],a=0,c=o.length;a<c;a++,i++)s[i]=o[a];return s}var I="App init",k="WebSocket transport connected to server",E="WebSocket transport disconnected from server",S="Chats are being loaded",w="Group chats are being loaded",C="Chats are ready",M="Set app interactive true",b="Set app interactive false",T="Session authorized (login)";function O(t,e){return{type:w,groupId:t,filter:e}}function A(t,e){return t.assign("interactive",e)}function R(t,e){return t.assign("online",e)}var P=3e4,L={websocket:5e3,"long-polling":3e5};function N(t,e,n){var r;void 0===n&&(n=1500);var s=!1,i=function(){if(!s&&!t.paused){clearTimeout(r);var o=L[t.transportType]||n,a=Date.now();(function(t,e,n){var r=t.request(1,e),s=setTimeout((function(){return t.cancel(D)}),n);return r.then((function(){return clearTimeout(s)})).catch((function(t){return clearTimeout(s),Promise.reject(t)}))})(t,{interactive:!!e.getState().interactive},o).then((function(){return r=window.setTimeout(i,P)})).catch((function(){console.log("no ping response for %d, reconnect",Date.now()-a),t.reopen()}))}},o=function(){e.dispatch({type:k}),i()},a=function(){e.dispatch({type:E}),clearTimeout(r)};return t.on("connect",o),t.on("resume",o),t.on("disconnect",a),t.on("pause",a),i.dispose=function(){s=!0,clearTimeout(r),t.off("connect",o),t.off("resume",o),t.off("disconnect",a),t.off("pause",a)},i.setActive=function(){e.dispatch({type:M})},i.setInactive=function(){e.dispatch({type:b})},t.flowing&&i(),i}function D(t){return 1===t.command}function U(t){return"uid"in t?t.uid:t.cid&&t.sender?("object"==typeof t.sender?t.sender.id:t.sender)+"-"+t.cid:""+(t.id||t.cid)}function x(t){return t.photoId||t.videoId||t.audioId||t.fileId||t.shareId||t.contactId||t.trackId}function j(t,e){var n=x(e);return n?U(t)+"--"+n:null}var q,F=4294967296,H=["A","B","C","D","E","F","G","H","I","J","K","L","M","N","O","P","Q","R","S","T","U","V","W","X","Y","Z","a","b","c","d","e","f","g","h","i","j","k","l","m","n","o","p","q","r","s","t","u","v","w","x","y","z","0","1","2","3","4","5","6","7","8","9","-","_"];function V(t,e,n){t[e+3]=255&n,n>>=8,t[e+2]=255&n,n>>=8,t[e+1]=255&n,n>>=8,t[e]=255&n}function G(t){var e=[],n=function(t){var e=new Array(8),n=0,r=t.length,s=0,i=0;"-"===t[0]&&n++;for(var o=n;n<r;){var a=parseInt(t[n++],10);if(!(a>=0))break;i=10*i+a,s=10*s+Math.floor(i/F),i%=F}return o&&(s=~s,i?i=F-i:s++),V(e,0,s),V(e,4,i),e.slice(0,8)}(t);return function(t,e){for(var n=3*Math.floor(t.length/3),r=0,s=0;s<n;s+=3,r+=4){var i=(255&t[s])<<16|(255&t[s+1])<<8|255&t[s+2];e[r]=H[i>>>18],e[r+1]=H[i>>>12&63],e[r+2]=H[i>>>6&63],e[r+3]=H[63&i]}switch(t.length-n){case 1:e[r]=H[(255&t[n])>>2],e[r+1]=H[(3&t[n])<<4],r+3<e.length&&(e[r+2]="=",e[r+3]="=");break;case 2:e[r]=H[(255&t[n])>>2],e[r+1]=H[(3&t[n])<<4|(255&t[n+1])>>4],e[r+2]=H[(15&t[n+1])<<2],r+3<e.length&&(e[r+3]="=")}}(n,e),e.join("")}function K(t,e){return"PUBLIC"===t.access&&e?t.link+"/"+G(e):null}e.LoadState=void 0,(q=e.LoadState||(e.LoadState={})).idle="idle",q.loading="loading",q.error="error",q.processing="processing",q.completed="completed",q.complete="complete",q.chatsLoading="chats-loading";var B=new i(["INCOMING_CALL","CHATS_PUSH_NOTIFICATION","CHATS_PUSH_SOUND","PUSH_DETAILS","HIDDEN","PUSH_SOUND","CHATS_INVITE","PUSH_NEW_CONTACTS","INACTIVE_TTL","DONT_DISTURB_UNTIL","SHOW_READ_MARK","ALT_KEYBOARD","GROWL","AUDIO_TRANSCRIPTION_ENABLED"]);function z(t,e){var n={};return Object.keys(t).forEach((function(r){var s,i;n[r]=(s=e,i=t[r],(s&i)>0)})),n}var W=Object.freeze({hideEdit:1,isLive:2});function J(t){if(t)return"object"==typeof t?t:z(W,t)}var Y={manageMessages:1,manageParticipants:2,manageAdmins:4,manageChat:8,pinMessage:16,readMessages:32,callChat:64},X=59;function Q(t){return z(Y,t)}function $(t){void 0===t&&(t=Q(0));var e=0;return Object.keys(Y).forEach((function(n){t[n]&&(e|=Y[n])})),0===e?X:e}function Z(t,e,n){var r,s,i=null,o=0;n||(n={leading:!1,trailing:!1});var a=function(){o=!1===n.leading?0:Date.now(),i=null,s=t.apply(void 0,r),i||(r=null)};return function(){for(var c=arguments,u=[],d=0;d<arguments.length;d++)u[d]=c[d];var h=Date.now();o||!1!==n.leading||(o=h);var f=e-(h-o);return r=u,f<=0||f>e?(i&&(window.clearTimeout(i),i=null),o=h,s=t.apply(void 0,r),i||(r=null)):i||!1===n.trailing||(i=window.setTimeout(a,f)),s}}function tt(t,e){var n=2147483648,r=2147483647;return(~~(t/n)^~~(e/n))*n+(t&r^e&r)}function et(t){return t.reduce((function(t,e){return t.concat(Array.isArray(e)?et(e):e)}),[])}function nt(t,e,n){return null!=t&&n.indexOf(t)===e}function rt(t){return t&&"object"==typeof t?t.id:t}function st(t){return new Promise((function(e){return setTimeout(e,t)}))}function it(t,e,n){var r=new Error(e||t);return r.code=t,n&&Object.assign(r,n),r}function ot(t,e,n){if(void 0===n&&(n=function(t){return t}),!t||!e)return!1;if(t!==e){var r=t.length;if(r!==e.length)return!1;for(;r--;)if(n(t[r])!==n(e[r]))return!1}return!0}function at(){var t=new Error("Request aborted");return t.code="EABORT",t}function ct(t){return t&&"EABORT"===t.code}function ut(t,e){return e+1e3*t}function dt(t){return"[object Object]"===Object.prototype.toString.call(t)}function ht(t,e){return dt(t)||dt(e)?ft(t,e):e}function ft(t,e){if(e=dt(e)?e:{},null==t)return e;t=dt(t)?t:{};for(var n=Object.keys(e),r=t,s=0,i=void 0,o=void 0,a=void 0;s<n.length;s++)(o=t[i=n[s]])!==(a=e[i])&&(dt(o)||dt(a))&&(a=ft(o,a)),o!==a&&(r===t&&(r=v({},t)),r[i]=a);return r}function lt(t){if("_type"in t)return t._type;var e=t.type||"";return/^image\//.test(e)&&!/svg/.test(e)?"PHOTO":/^video\//.test(e)?t._photo?"PHOTO":"VIDEO":/^audio\/(mpeg|m4a)/.test(e)?"AUDIO":!e&&/\.(dv|rm|dat|wm|qt|divx|m2v|ogm|avi|vob|mpg|mpe|mpeg|m2p|mp4|mov|3gp|asf|wmv|flv|m4v|m2ts|mts|3g2|evo|f4v|mkv|mcf|ts|mxf|ogg|rmvb|webm|vcd|svcd|3gpp|m4a|torrent)$/.test(t.name)?"VIDEO":"FILE"}function pt(t,e){t=Array.isArray(t)?t.filter(nt):[t];for(var n=[],r=0;r<t.length;)n.push(t.slice(r,r+e)),r+=e;return n}function gt(t,e,n){void 0===e&&(e=1e4),void 0===n&&(n=1e3);var r=Math.min(e,n*Math.pow(2,t))/2;return Math.round(Math.random()*r+r)}var vt=new i(["STICKER","CONTROL","CALL","FILE","CONTACT","AUDIO","LOCATION","DAILY_MEDIA","MUSIC"]);function mt(t,e,n){var r,s=Array.isArray(n.attaches)&&n.attaches[0];if("CONTROL"===(s&&s._type))return[];if(!n.id)return[_t("remove")];var i,o=[];e.admins&&e.admins.some((function(e){if("number"!=typeof e&&yt(t,e.user))return i=e,!0}));var a,c=t.get("config.server.show-rm-limits")||0,u=e.participantsCount>c[1],d=function(t){return"OKWEB"===t||"OK_MOB_WEB"===t}(t.get("userAgent")),h="DIALOG"!==e.type,f="GROUP_CHAT"===e.type,l="CHANNEL"===n.type||"CHANNEL_ADMIN"===n.type,p=i&&i.permissions||{},g=!!i,v=e.pinnedMessage&&e.pinnedMessage.id===n.id,m=n.sender&&yt(t,n.sender)||function(t,e){var n,r,s,i="number"==typeof e.sender?e.sender:null===(n=e.sender)||void 0===n?void 0:n.id;return(null===(r=t.groupChatInfo)||void 0===r?void 0:r.isModerator)&&(null===(s=t.groupChatInfo)||void 0===s?void 0:s.groupId)===i}(e,n),y=l?g&&p.manageMessages:m,_=g&&p.manageMessages||!l,I=m||"DIALOG"===e.type,k=d&&!t.get("config.server.remove-in-chats")?I:_,E=d&&!t.get("config.server.settings-use")?!f&&h&&yt(t,e.owner):!f&&(e.options&&e.options.ALL_CAN_PIN_MESSAGE||h&&g&&p.pinMessage),S=!d&&h&&!l&&!m&&t.get("config.server.experimental"),w=d&&!m,C=!It(n)&&n.text||kt(n)||n.link&&n.link.message&&!It(n.link.message)&&(n.link.message.text||kt(n.link.message));if(l&&!g||o.push(_t("reply")),function(t,e){var n,r=t.get("config.server.disable-forward-for-attach-types")||[];return(null===(n=e.attaches)||void 0===n?void 0:n.some((function(t){return r.includes(t._type)})))||!1}(t,n)||o.push(_t("forward")),S&&o.push(_t("privateReply")),"CHANNEL"===e.type&&!_e(e,Fe(t).id)||(null===(r=e.groupChatInfo)||void 0===r?void 0:r.isModerator)||o.push(_t("unread",ut(t.get("config.server.set-unread-timeout"),n.time))),y&&function(t){return!t.link||"FORWARD"!==t.link.type}(n)&&!function(t){var e;if(null===(e=t.attaches)||void 0===e?void 0:e.length){var n=t.attaches[0];return!!vt.has(n._type)||n.gif&&!t.text}return!1}(n)){var M=void 0;l||(M=ut(t.get("config.server.edit-timeout"),n.time)),o.push(_t("edit",M))}return d&&!t.get("config.server.copy")||!C||o.push(_t("copy")),!d&&n.id&&"PUBLIC"===e.access&&e.link&&o.push(_t("url")),E&&o.push(_t(v?"unpin":"pin")),!h||l||u||o.push(_t("showRead")),s&&"VIDEO"===s._type&&(s.urlData&&(a=s.urlData,!Object.keys(a).some((function(t){return/^MP4_/.test(t)})))||o.push(_t("downloadVideo"))),w&&o.push(_t("report")),k&&o.push(_t("remove")),o}function yt(t,e){var n=je(t,e);return!!n&&!!n.current}function _t(t,e){return{type:t,timeout:e}}function It(t){return!!(t&&t.attaches&&t.attaches.length>0)&&"STICKER"===t.attaches[0]._type}function kt(t){var e;return(null===(e=t.attaches)||void 0===e?void 0:e.some(Et))||!1}function Et(t){return"AUDIO"===t._type&&!!t.transcription}function St(t,e,n){void 0===n&&(n=null);var r=ee(t,e);if(!r)return t;var s=t.get(r);return null!==n&&0!==n||null!==(n=wt(t,s))&&0!==n?(s.messages&&s.messages.forEach((function(e,i){Mt(t,s,r.concat("messages",i),n)})),s.lastMessage&&Mt(t,s,r.concat("lastMessage"),n),t):t}function wt(t,e){if(!e||!e.participants)return null;if(Array.isArray(e.participants)){for(var n=0,r=e.participants.length;n<r;n++)if(e.participants[n].user.current)return e.participants[n].time}else{var s=Fe(t).id,i=Object.keys(e.participants).find((function(t){return Number(t)===s}));if(i)return e.participants[i]}return Date.now()}function Ct(t,e,n,r){return null==r&&(r=wt(t,e)),null!=r&&n.time>r}function Mt(t,e,n,r){var s=t.get(n);if(s){var i=Ct(t,e,s,r);if(i!==s.unread)return t.assign(n,{unread:i})}return t}var bt={mixed:function(t){return"PHOTO"===t._type||"VIDEO"===t._type},file:function(t){return"FILE"===t._type},share:function(t){return"SHARE"===t._type},audio:function(t){return"AUDIO"===t._type},music:function(t){return"MUSIC"===t._type}};function Tt(t,e,n){if(!t.get("config.server.media"))return t;var r=ee(t,e);if(r){var i=te(t,r);if(!Yt(n))return"EDITED"===n.status&&At(t,e,n.id),t;var o=!1,a=new s(i.media),c=qt(e,n);Object.keys(c).forEach((function(t){var e=a.get(t),r=Ot(i,n.id,e.items,c[t]);r!==e.items&&(o=!0,a.set(t,Jt(e,r)))})),o&&t.set(r.concat("media"),a)}return t}function Ot(t,e,n,r,s){var i,o,a,c=Ft(n,e);if(-1!==c[0]){if(!r.length){var u=n[c[0]-1],d=n[c[1]+1];u&&d&&Ht(u)&&Ht(d)&&c[1]++}n=_(n.slice(0,c[0]),r,n.slice(c[1]))}else if(r.length&&(a=Bt(t,e))){var h=zt(t,n,a.time);0!==h||!(null===(i=s)||void 0===i?void 0:i.noDelimiters)&&(null===(o=t.lastMessage)||void 0===o?void 0:o.id)!==e?(r=_(r),Vt(n,h-1)&&r.unshift({id:"delimiter"}),Vt(n,h)&&r.push({id:"delimiter"}),n=_(n.slice(0,h),r,n.slice(h))):n=_(r,n)}return n}function At(t,e,n){var r=ee(t,e);if(r){var i=!1,o=te(t,r),a=new s(o.media);a.forEach((function(t,e){var r=Ot(o,n,t.items,[]);r!==t.items&&(i=!0,a.set(e,Jt(t,r)))})),i&&t.set(r.concat("media"),a)}return t}function Rt(t,e,n,r){var s=ee(t,e);if(s){var i=te(t,s),o=i.media.get(n),a=Lt(o.items,r);if(-1!==a){var c=o.items[a];return function(t,e,n,r){var s=ee(t,e);if(s){var i=te(t,s).media.get(n);t.assign(s.concat("media",n),Dt(i.items,n,r))}return t}(t,e,n,c.id)}if("object"==typeof r){var u=[],d=o.items,h=-1,f=-1;if(Qt(i,r)){i.messages.forEach((function(t){Nt(e,t,bt[n],u)})),u.reverse();var l=u[0],p=Kt(u);if(!l||!p)return t;var g=Ft(d,l.messageId),v=Ft(d,p.messageId);-1!==g[0]?h=g[0]:Vt(d,(h=Pt(i,n,l))-1)&&u.unshift({id:"delimiter"}),-1!==v[1]?f=v[1]:Vt(d,f=Pt(i,n,p))&&u.push({id:"delimiter"})}if(-1===h||-1===f||h>f)return console.warn("неправильный диапазон для вставки: from "+h+", to "+f),t;var m=h+Lt(u,r),y=_(o.items.slice(0,h),u,o.items.slice(f)),I=y[m];I&&!Ht(I)?t.assign(s.concat("media",n),Jt(o,y,{selected:I.id})):console.warn("Invalid selected item location:",m,y)}else t.assign(s.concat("media",n),jt(-1,-1,-1))}return t}function Pt(t,e,n){for(var r=Qt(t,n),s=t.media.get(e).items,i=0;i<s.length;i++){var o=s[i];if(!Ht(o)){var a=Qt(t,o);if(!a||a.time<r.time)return i}}return s.length}function Lt(t,e){if("number"==typeof e){var n=t[e];return n&&!Ht(n)?e:-1}return"string"==typeof e?t.findIndex((function(t){return t.id===e})):e?t.findIndex((function(t){return!Ht(t)&&t.id===e.mediaId})):-1}function Nt(t,e,n,r){var s,i;void 0===r&&(r=[]);var o=function(e,s){if(!s.deleted&&n(s)){var i=e.id;r.push({id:j(e,s),attach:v(v({},s),{chatId:t,messageId:i,mediaId:j(e,s)}),messageId:i,time:e.time,sender:$t(e.sender)})}};return e.attaches&&e.attaches.forEach((function(t){return o(e,t)})),"FORWARD"===(null===(s=e.link)||void 0===s?void 0:s.type)&&(null===(i=e.link.message)||void 0===i?void 0:i.attaches)&&e.link.message.attaches.forEach((function(t){return o(e,t)})),r}function Dt(t,e,n){if(n){var r=t.findIndex((function(t){return t.id===n}));if(-1!==r){var s=r+1,i=r-1;return"file"===e?(s=xt(t,s,"next"),i=xt(t,i,"previous")):((s>=t.length||Ht(t[s]))&&(s=-1),(i<0||Ht(t[i]))&&(i=-1)),jt(r,s,i)}}return jt(-1,-1,-1)}function Ut(t){return!Ht(t)&&"FILE"===t.attach._type&&t.attach.preview&&("PHOTO"===t.attach.preview._type||"VIDEO"===t.attach.preview._type)}function xt(t,e,n){if(e<0||e>=t.length||Ht(t[e]))return-1;if("next"===n){for(var r=e;r<t.length;++r)if(Ut(t[r]))return r;return-1}for(r=e;r>=0;--r)if(Ut(t[r]))return r;return-1}function jt(t,e,n){return{current:t,next:e,previous:n}}function qt(t,e,n){void 0===n&&(n={mixed:[],audio:[],file:[],share:[],music:[]});var r=Object.keys(bt);return Array.isArray(e)?e.forEach((function(e){r.forEach((function(r){return Nt(t,e,bt[r],n[r])}))})):r.forEach((function(r){return Nt(t,e,bt[r],n[r])})),r.forEach((function(t){return n[t].reverse()})),n}function Ft(t,e){for(var n,r=-1,s=-1,i=0;i<t.length;)if(!Ht(n=t[i++])&&n.messageId===e){for(r=i-1,s=t.length;i<t.length;)if(Ht(n=t[i++])||n.messageId!==e){s=i-1;break}break}return[r,s]}function Ht(t){return"delimiter"===t.id}function Vt(t,e){var n=t[e];return!n||!Ht(n)}function Gt(t,e){var n=t[e];return n&&Ht(n)?_(t.slice(0,e),t.slice(e+1)):t}function Kt(t){if(t.length)return t[t.length-1]}function Bt(t,e){var n="";return"string"==typeof e||"number"==typeof e?n=e:null!=e&&(n="messageId"in e?e.messageId:e.id),ie(t,n)}function zt(t,e,n){for(var r=0;r<e.length;){var s=e[r];if(!Ht(s)&&s.time<=n)break;r++}return r}function Wt(t,e,n){for(var r=e.length-1;r>=0;){var s=e[r];if(!Ht(s)&&s.time>=n){r++;break}r--}return-1===r?0:r}function Jt(t,e,n){var r,s,i,o=-1!==t.current?t.items[t.current]:void 0,a=e.filter((function(t){return!Ht(t)})),c=a.length;return t=v(v({},t),{items:e}),null!=(null===(r=n)||void 0===r?void 0:r.total)?t.total=n.total:Xt(t)&&(t.total+=c-t.count),t.count=c,0===c?(t.items=[],t.total=-1):Xt(t)&&c>=t.total&&(t.items=a),Object.assign(t,Dt(t.items,t.id,(null===(s=n)||void 0===s?void 0:s.selected)||(null===(i=o)||void 0===i?void 0:i.id))),t}function Yt(t){var e,n;return!!t&&(!!(null===(e=t.attaches)||void 0===e?void 0:e.length)||"FORWARD"===(null===(n=t.link)||void 0===n?void 0:n.type)&&Yt(t.link.message))}function Xt(t){return-1!==t.total}function Qt(t,e){if(t.messages){var n=t.messages.get(e.messageUid||e.messageId);if(!n&&e.mediaId){var r=e.mediaId.replace(/--\d+$/,"");n=t.messages.get(r)}return!n&&e.messageId&&t.messages.forEach((function(t){var r,s;t.id!==e.messageId&&(null===(s=null===(r=t.link)||void 0===r?void 0:r.message)||void 0===s?void 0:s.id)!==e.messageId||(n=t)})),n}}function $t(t){return"number"==typeof t?t:t?t.id:void 0}var Zt="chats";function te(t,e){var n=Array.isArray(e)?e:ee(t,e);return n?t.get(n):null}function ee(t,e){if(null!=e){if(0===e)return["newChat"];var n=[Zt,e];return t.has(n)?n:t.get(["peekChat","id"])===e?["peekChat"]:void 0}}function ne(t,e,n){var r=Fe(t),i=t.get([Zt,e.id]);if(i&&"REMOVED"===e.status&&"DIALOG"===e.type&&i.posting)return v(v({},i),{messages:new s});var o=t.get(["posting",e.id]),a=qe(t,e.owner),c=!1;if("DIALOG"===e.type){var u=He(t,e).filter((function(t){return!t.current}));u.length&&(c=Boolean(u[0].official))}else c=Boolean(e.options&&e.options.OFFICIAL);var d=t.get("config.server.settings");return v(v({},e),{admins:fe(e,d),participants:he(e,r),pinnedMessage:e.pinnedMessage&&re(t,e,e.pinnedMessage),selected:!1,unreadCount:e.newMessages||0,owner:a,placeholder:ge(t,e),messages:null,media:ce(),lastMessage:e.lastMessage&&re(t,e,e.lastMessage),settings:v({chatId:e.id,dontDisturbUntil:0},n),official:c,group:e.groupChatInfo?e.groupChatInfo.groupId:void 0,sortTime:o?o.updated:0,lastReactedMessageId:e.lastReactedMessageId,lastReaction:e.lastReaction,lastMentionMessage:e.lastMentionMessage&&re(t,e,e.lastMentionMessage)})}function re(t,e,n){var r,s=n.attaches&&n.attaches.map((function(t){return se(e.id,n,t)})),i=n.link,o=n.sender;if("GROUP"===n.type&&e.groupChatInfo&&(o=pe(e.groupChatInfo.groupId),n.sender=o.id),i&&i.message){var a=[],c=i.message.sender;if(i.message.attaches&&(a=i.message.attaches.map((function(t){return se(e.id,n,t)}))),"GROUP"===i.message.type){var u=null===(r=e.groupChatInfo)||void 0===r?void 0:r.groupId;"REPLY"===i.type&&u&&!c&&(c=u),c=pe(c)}i=v(v({},i),{message:v(v({},i.message),{attaches:a,sender:c})})}var d=v(v({},n),{status:n.status||"ACTIVE",sender:o,link:i,attaches:s,chatId:e.id,uid:U(n),unread:Ct(t,e,n),actions:mt(t,e,n),publicLink:K(e,n.id),options:J(n.options)});return n.reactionInfo&&(d.reactionInfo=n.reactionInfo),Tt(t,e.id,d),d}function se(t,e,n){var r=v(v({},n),{chatId:t,messageId:e.id,mediaId:j(e,n)});return n=v(v({},n),{chatId:t,messageId:e.id}),r.media&&(r.media=v(v({},n.media),{chatId:t,messageId:e.id})),r.url&&!/https?:/.test(n.url)&&(r.url=""),"fileId"in n&&(r.download=n.fileId),("userId"in n||"contactId"in n)&&(r.user=n.userId||n.contactId),"userIds"in n&&(r.users=n.userIds),"DAILY_MEDIA"===n._type&&(r.dailyMediaId=n.mediaId,r.user=n.ownerId),r}function ie(t,e){var n,r=t.lastMessage;if(r&&(r.id===e||r.uid===e||r.cid===e))return r;var s=function(t){!t.message||t.message.id!==e&&t.message.uid!==e&&t.message.cid!==e||(n=t.message)};if(t.messages&&(t.messages.has(e)?n=t.messages.get(e):t.messages.forEach((function(t){t.id!==e&&t.cid!==e&&t.uid!==e||(n=t)}))),!n&&t.mediaList)for(var i=Object.keys(t.mediaList),o=0,a=void 0,c=void 0;o<i.length&&!n;o++)c=(a=t.mediaList[i[o]])&&a.items,Array.isArray(c)&&c.forEach(s);return n}function oe(t,e,n){var r=ee(t,e),s=r&&te(t,r),i=[];return r&&s&&s.messages&&s.messages.forEach((function(t,e){n(t)&&i.push(r.concat("messages",e)),t.link&&t.link.message&&n(t.link.message)&&i.push(r.concat("messages",e,"link","message"))})),i}function ae(t,e){var n=t.get(e),r=[];return n&&n.attaches&&(n.attaches.forEach((function(t,n){r.push(e.concat("attaches",n))})),n.link&&(r=r.concat(ae(t,e.concat("link","message"))))),r}function ce(){var t=new s;return["mixed","share","file","audio","music"].forEach((function(n){t.set(n,{id:n,loadState:e.LoadState.idle,selected:"mixed"===n,items:[],total:-1,count:0,current:-1,previous:-1,next:-1})})),t}function ue(t,e,n){var r=ee(t,e);if(r){var s=(t.get(r.concat("pending"))||[]).findIndex((function(t){return t.cid===n}));if(-1!==s)return r.concat("pending",s)}}function de(t,e){var n=[],r=ee(t,e);if(r){var s=te(t,r);if(s.pending){var i={};s.messages&&s.messages.forEach((function(t,e){t.id||(i[t.cid]=e)})),s.pending.forEach((function(t,e){n.push({primary:r.concat("pending",e),secondary:t.cid in i?r.concat("messages",i[t.cid]):void 0})}))}s.posting&&s.posting.preview&&s.posting.preview.forEach((function(t,r){n.push({primary:["posting",e,"preview",r],secondary:void 0})}))}return n}function he(t,e){var n=t.participants;return Object.keys(n).map((function(r){var s=Number(r),i=n[r];return e&&s===e.id&&(i=Math.max(i,t.joinTime||0))<10&&(i=t.lastMessage&&t.lastMessage.time||Date.now()),{user:s,time:i}}))}function fe(t,e){var n=t.adminParticipants;if(n){var r=t.options&&t.options.OK;return Object.keys(n).map((function(t){var s=n[Number(t)],i=Q(null!=s.permissions?s.permissions:X);return r&&!e&&(i.manageAdmins=!1),{permissions:i,user:s.id,inviter:s.inviterId}}))}return[]}function le(t){if(t instanceof s)return t;var e=new s;return t.forEach((function(t){var n=t.uid,r=e.get(n);r&&(t=t.updateTime>r.updateTime||t.time>r.time||!r.id&&t.id?v(v({},r),t):v(v({},t),r)),e.set(n,t)})),e}function pe(t){return{id:t,type:"GROUP"}}function ge(t,e){if(1===e.participantsCount)return"";var n=He(t,e).filter((function(t){return!t.current}));if("DIALOG"===e.type&&n.length)return n.length?n[0].name:"";var r=n.slice(0,4).map((function(t){return t.name})).join(", ");return n.length>4&&(r+="..."),r}function ve(t,e){if(e){var n=ge(t,t.get(e));return t.set(e.concat("placeholder"),n)}return t}function me(t,e){return t&&("ACTIVE"===t.status||"HIDDEN"===t.status)&&!ye(t,e)}function ye(t,e){return"CLOSED"===t.status||"ACTIVE"===t.status?!_e(t,e):"REMOVED"===t.status}function _e(t,e){if(Array.isArray(t.participants)){var n=t.owner;return n&&n.id===e||t.participants.some((function(t){return t.user.id===e}))}return t.owner===e||t.participants&&e in t.participants}function Ie(t){return!function(t){return Array.isArray(t.participants)}(t)}var ke="Enter new contact mode",Ee="Exit new contact mode",Se="Update new contact data",we="Update single contact",Ce="Updates list of contacts",Me="Update contact presence",be="Update contacts presence",Te="Remove contact",Oe="Block contact",Ae="Unblock contact",Re="Update contact black list",Pe="Set contact photos",Le="Clear contact photos",Ne="Set contact error",De="Fill contact stubs",Ue="idle",xe="loading";function je(t,e){return e&&"object"==typeof e?e:t.get(["contacts",e])}function qe(t,e){var n=je(t,e);if(!n)throw new Error("Отсутствует информация о пользователе с ID: "+e);return n}function Fe(t){return t.get("auth.profile")}function He(t,e){return Array.isArray(e.participants)?e.participants.map((function(t){return t.user})):e.participants?Object.keys(e.participants).map((function(e){return qe(t,Number(e))})):[]}function Ve(t,e,n){if(Array.isArray(e)){var r=[];e.forEach((function(e){Ge(t,e,n),r.push(e.id)})),We(t,r)}return t}function Ge(t,e,n){var r=["contacts",e.id],s=t.get(r);if(e.link&&!/^\w+:/.test(e.link)){var i=s&&s.link;e=v(v({},e),{link:(i?new URL(i).origin:"https://tt.me")+"/"+e.link})}var o=ze(e);return t=n||!s||"REMOVED"===s.status?t.set(r,o):t.assign(r,o)}function Ke(t,e,n){var r=Number(e);return t.has(["contacts",r])&&t.set(["contacts",r,"presence"],n),t}function Be(t,e){return Object.keys(e).forEach((function(n){return Ke(t,Number(n),e[n])})),t}function ze(t){return v(v({},t),{name:t.name||t.names&&t.names[0].name||"#"+t.id,official:!!t.options&&t.options.includes("OFFICIAL"),stub:!0===t.stub})}function We(t,e){var n=function(t,e){var n=[];return t.get("chats").forEach((function(t){t.participants&&t.participants.find((function(t){return e.includes(t.user.id)}))&&n.push(t.id)})),n}(t,e);e.length&&function(t,e){e.forEach((function(e){var n=ee(t,e);if(n){var r=t.get(n);t.set(n.concat("placeholder"),ge(t,r))}}))}(t,n)}function Je(t,e){var n=["contacts",0],r=t.get("contacts");return e.forEach((function(e){r.has(e)||(n[1]=e,t.set(n,Qe(e)))})),t}var Ye=[{name:"🤖",type:"CUSTOM"}],Xe=[];function Qe(t){return{id:t,name:Ye[0].name,names:Ye,updateTime:Date.now(),gender:0,options:Xe,stub:!0}}var $e="Set loading state of auth section",Ze="Set auth error",tn="Update suggested OK user profile",en="Set auth verification data",nn="Set location",rn="Set phone",sn="Set auth confirmation data",on="Save auto-login token",an="Save tokens",cn="Set current user as logged in",un="Set current user as logged out",dn="Reset auth state",hn="Change recovery data",fn="Start creating new profile",ln="Set profile link status",pn="Set loading state of sessions",gn="Update sessions",vn="Set verification info",mn={idle:"idle",loading:"loading"};function yn(t,e){return t.assign("auth",{loadState:mn[e]})}function _n(t,e,n){return n&&(t=yn(t,mn.idle)),e?t.set("auth.lastError",e.error||e.code||e):t.delete("auth.lastError")}function In(t,e){var n;if(null==e)throw new Error("Указан пустой профиль пользователя");if("object"!=typeof e&&!(e=t.get(["contacts",e])))throw new Error('В ветке "contacts" отсутствуют данные о пользователе '+n);if(n=e){t.assign("auth",{profile:n});var r=["contacts",n.id];t.get("contacts")instanceof s&&t.set(r,ze(n)),t.assign(["contacts",n.id],{current:!0})}return t}function kn(t,e){return t.assign("auth",{state:e,loadState:mn.idle,verification:null,recovery:null,lastError:null,token:null})}var En="Add participants to chat",Sn="Remove participant from chat",wn="Block chat participant",Cn="Unblock chat participant",Mn="Manage admins",bn="Remove chat admin",Tn="Update chat members load state",On="Add chat members",An="Reset chat participants",Rn={idle:"idle",loading:"loading"};function Pn(t,e,n){var r=ee(t,e);return r&&(t=Nn(t,r,n)),t}function Ln(t,e,n){var r=ee(t,e);return r&&(t=Un(t=Dn(t,r,n),r,n)),t}function Nn(t,e,n){var r=t.get(e);if("CHANNEL"===r.type){var s=e.concat(["members","items"]);if(t.has(s)){var o=t.get(s),a=new i(o.map(rt));n.map(Number).forEach((function(e){if(!a.has(e)){var n=t.get(["contacts",e]);n&&(a.add(e),o.push(n))}})),t=t.set(s,o)}}else{var c=r.participants.slice(),u=c.length,d=new i(c.map((function(t){return rt(t.user)})));n.map(Number).forEach((function(t){d.has(t)||(d.add(t),c.push({time:0,user:t}))})),t=ve(t=t.assign(e,{participants:c,participantsCount:r.participantsCount+c.length-u}),e)}return t}function Dn(t,e,n){var r=t.get(e);if("CHANNEL"===r.type){var s=e.concat(["members","items"]),i=t.get(s);i&&(t=t.set(s,i.filter((function(t){return rt(t)!==n}))))}else if(r.participants){var o=r.participants.length,a=r.participants.filter((function(t){return rt(t.user)!==n}));t=ve(t=t.assign(e,{participants:a,participantsCount:r.participantsCount+a.length-o}),e)}return t}function Un(t,e,n){var r=e.concat("admins"),s=t.get(r);return s&&s.some((function(e,s){return("object"==typeof e?e.user.id:e)===n&&(t=t.delete(r.concat([s])),!0)})),t}var xn="Store chats",jn="Update chat",qn="Next chats loaded",Fn="Groups chats loaded",Hn="Oldest chats loaded",Vn="Add chats to list",Gn="Update chat messages",Kn="Reset chat messages",Bn="Reset focused chat message",zn="Add new chat message",Wn="Update last mention message",Jn="Add new chat message as pending",Yn="Remove chat message as pending",Xn="Edit chat message",Qn="Remove chat message",$n="Select chat",Zn="Reset selected chat",tr="Set chat load state",er="Update chat read mark",nr="Commit chat posting message",rr="Confirm chat posting message",sr="Cancel chat posting message",ir="Set optimistic posting message error",or="Remove chat messages",ar="Select chat message",cr="Unselect chat message",ur="Reset selected chat messages",dr="Add typing participant in chat",hr="Remove typing participant from chat",fr="Clear chat history",lr="Remove chat",pr="Leave chat",gr="Set chat icon",vr="Set chat message video url data",mr="Set chat message music url",yr="Set next link",_r="Set created channel",Ir="Set attachment download URL",kr="Show or hide pinned message",Er="Remove pinned message",Sr="Pin message",wr="Clean messages with removed status in selected chat",Cr="Update chat bot commands list",Mr="Update keyboard status",br="Remove isSuspended flag from chat",Tr="Save location image",Or="Hide friendship status bar",Ar="Hide friendship status important bar",Rr="Add reason why left column should be open",Pr="Remove reason why left column should be open";function Lr(t){return{type:xn,chats:t}}function Nr(t,e,n,r){return{type:Fn,groupId:t,chats:e,filter:n,marker:r}}function Dr(t){return{type:Vn,chats:t}}function Ur(t){return{type:jn,chat:t}}function xr(t){return{type:Kn,chatId:t}}function jr(t,e,n){return void 0===n&&(n={}),v({type:zn,chatId:t,message:e},n)}function qr(t,e){return{type:tr,chatId:t,loadState:e}}function Fr(t,e,n){return{type:nr,chatId:t,message:e,keep:n}}function Hr(t,e,n){return{type:ir,chatId:t,messageId:e,error:n}}function Vr(t,e){return{type:lr,chatId:t,message:e}}function Gr(t,e){return{type:yr,chatId:t,data:e}}function Kr(t,e){return{type:Mr,data:t,loading:e}}var Br={START:"Notify chat file upload started",PROGRESS:"Update chat upload file progress",COMPLETE:"Complete chat file upload",ERROR:"Set error to chat upload"},zr={idle:"idle",loading:"loading",processing:"processing",completed:"completed",error:"error"};function Wr(t){switch(t.type){case Br.START:return{status:zr.loading,promise:t.promise};case Br.PROGRESS:return{progress:t.progress};case Br.COMPLETE:return v(v({},t.payload),{status:t.payload.status||zr.completed,error:null});case Br.ERROR:return{error:t.error,status:zr.error}}}function Jr(t,e,n){return t.has(e)&&n?(n.progress&&(n={status:n.status||zr.loading,progress:v(v({},t.get(e.concat("progress"))),n.progress),error:null}),t.assign(e,n)):t}var Yr=["PHOTO","VIDEO","AUDIO"];function Xr(t){return"PHOTO"===t?"photoToken":"token"}function Qr(t){return{PHOTO:"photoId",VIDEO:"videoId",FILE:"fileId",AUDIO:"videoId",STICKER:"stickerId"}[t]}function $r(t){return Boolean(t.text||t.upload||t.link&&("FORWARD"===t.link.type||"EDIT"===t.type)||t.voiceMessage&&!t.voiceMessage.recording)}function Zr(t){return Yr.includes(lt(t))}function ts(t){var e=[];if("EDIT"===t.type&&t.link){var n=t.link;e=e.concat(n.attaches)}Array.isArray(t.attaches)&&(e=e.concat(t.attaches)),t.upload&&(e=e.concat(function(t){if(!t.upload)return[];var e=Array.from(t.upload.values()).filter(Boolean),n=e[0];t.voiceMessage&&n&&(n.url=t.voiceMessage.url,n.wave=t.voiceMessage.wave,n.duration=t.voiceMessage.duration);return e}(t)));var r=ns(t.shares);return r&&!e.length&&(e=e.concat([r])),e}function es(t,e){for(var n=[],r=Array.from(t),i=r.length,o=Math.floor(i/Math.ceil(i/e)),a=i%o,c=0,u=o;c<i;c=u,u+=o)a&&(u++,a--),n.push(new s(r.slice(c,u)));return n}function ns(t){return t&&!t.disabled&&t.items[t.selected]}function rs(t,e){if(t){if(t.length<=e)return[t];var n=t.match(new RegExp("(?=\\S)([^]{1,"+(e-1)+"}|[^\\s,;]*)(.$|[\\s,;])","g"));return n||[]}return[]}function ss(t,e){var n=[];return t&&is(t).forEach((function(t){if(t.attaches)for(var e=0;e<t.attaches.length;e++)t.attaches[e].file&&n.push(t.attaches[e])})),e&&e.upload&&e.upload.forEach((function(t){return n.push(t)})),n}function is(t){return t&&t.pending||[]}function os(t){var e;return"CHANNEL"===t.type&&t.options&&t.options.SIGN_ADMIN?"CHANNEL_ADMIN":"GROUP_CHAT"===t.type&&(null===(e=t.groupChatInfo)||void 0===e?void 0:e.isModerator)?"GROUP":"CHANNEL"===t.type?"CHANNEL":"USER"}function as(t){return!!t&&!t.trim()}function cs(t){return as(t.text)||!$r(t)&&!t.shares&&!t.attaches}function us(t,e){if(!t||"EDIT"!==t.type)return!1;var n=t.link,r=t.upload&&t.upload.size||n&&n.attaches&&n.attaches.length||t.shares&&t.shares.items&&t.shares.items.length&&!t.shares.disabled,s=t.text&&t.text.length>e.server["max-msg-length"];return!r&&(s||as(t.text))}function ds(t){return(t||"").trim().split("\n").map((function(t){return t.replace(/\s*$/g,"")})).join("\n")}function hs(t){return t&&t.disabled?void 0:t}function fs(t){return"detectShare"in t?!!t.detectShare:!(t.shares&&t.shares.disabled)}function ls(t,e){var n=new Error(e||t);return n.code=t,n.localizedMessage=e,n}function ps(t){var e={cid:t.cid,text:t.text||"",detectShare:!!t.posting.detectShare,elements:t.elements};return t.attaches&&t.attaches.length&&(e.attaches=t.attaches.map(gs)),t.link&&(e.link=v({},t.link),t.link.message&&t.link.message.id&&(e.link.messageId=t.link.message.id,delete e.link.message)),e}function gs(t){var e,n=t._type,r=t.file;if(r){if("_type"in r){if("PHOTO"===r._type)return{_type:r._type,photoId:r.photoId};if("VIDEO"===r._type)return{_type:r._type,videoId:r.videoId}}var s=Xr(n);return(e={_type:n})[s]=t.token||t[s],e}return"STICKER"===n?{_type:n,stickerId:t.stickerId,stickerToken:t.token}:"CONTACT"===n?{_type:n,contactId:t.contactId}:"INLINE_KEYBOARD"===n?{_type:t._type,buttons:t.keyboard.buttons}:t}function vs(t,e,n){var r,s;if(cs(e))return null;var i=e.upload?null:ns(e.shares);i&&"SHARE"===i._type&&i.url===e.text&&(e.text="",e.messageElements&&(e.messageElements=[]));var o,a=os(t),c={cid:e.cid||Date.now(),text:e.text,attaches:ts(e),sender:n,time:Date.now(),elements:e.messageElements,type:a};return"EDIT"===e.type?delete(c=v(v(v({},e.link),c),{status:"EDITED",time:null===(r=e.link)||void 0===r?void 0:r.time})).actions:(c.posting={notify:!e.notifyDisabled,type:a,detectShare:!!e.detectShare,attachMEL:!(null===(s=e.shares)||void 0===s?void 0:s.disabled)},e.link&&(c.link=(o=e.link)&&"message"in o?e.link:{type:e.type,message:e.link})),c}function ms(t,e){return v({id:Date.now(),chatId:t,type:"NEW",text:"",urls:[],notifyDisabled:!1},e)}function ys(t,e,n,r){return void 0===r&&(r="FILE"),ms(t,{cid:n,upload:(new s).set(e,{file:e,_type:r,status:zr.idle})})}function _s(t){return!!t&&!("message"in t)}var Is="posting",ks="forward",Es="Update chat posting message",Ss="Reset chat posting message",ws="Set posting message preview";function Cs(t,e){return"messageElements"in e&&(t=Hs(t,"messageElements",e.messageElements)),t}function Ms(t,e,n){var r=t.get([Is,e]),s=[Ps,Ls,Ns,Ds,Us,js,Rs,xs,Cs].reduce((function(e,r){return r(e,n,t)}),r||ms(e));return r!==s&&($r(s)||s.shares||s.notifyDisabled||s.link||s.forward||s.voiceMessage?(s.updated=Date.now(),t=Os(t,e,s)):t=Ts(t,e)),n.removeAttach&&(t=function(t,e,n){return n=Gs(n).filter(Boolean),de(t,e).forEach((function(e){t=qs(t,e.primary,n),e.secondary&&(t=qs(t,e.secondary,n))})),t}(t,e,n.removeAttach)),t}function bs(t){var e=t.get(Is);return e&&e.forEach((function(e,n){var r=te(t,n);r&&r.posting&&r.posting.forward&&!r.selected&&(t=function(t,e){var n=[Is,e,ks];return t.delete(n)}(t,n)),!function(t){return!t||!$r(t)&&!t.link&&!t.shares&&!t.forward}(e)||r&&r.selected||(t=Ts(t,n))})),t}function Ts(t,e,n){return Os(t,e,null,n)}function Os(t,e,n,r){var s=[Is,e];if(null==n){var i=te(t=t.delete(s),e);if(r&&i&&i.posting&&i.posting.forward&&i.selected)t=Os(t,e,ms(e,{forward:i.posting.forward}))}else t=t.set(s,n);return As(t,e)}function As(t,e){var n=ee(t,e);if(n){var r=n.concat(Is),s=t.get([Is,e]);t=t.set(r,s)}return t}function Rs(t,e){var n="forward";if(null===e.forward)return Hs(t,"forward",null);if(!e.forward)return t;t.forward||(t=Hs(t,n,{}));["text","type","chatId"].forEach((function(r){var s,i=e.forward[r];void 0!==i&&(t=Hs(t,n,Vs(t.forward,((s={})[r]=i,s))))}));var r=t.forward.targetChatIds,s=void 0===r?[]:r,i=e.forward,o=i.addChatId,a=i.removeChatId,c=_(s);o&&!s.includes(o)&&(c=s.concat(o)),a&&s.includes(a)&&(c=s.filter((function(t){return t!==a}))),ot(s,c)||(t=Hs(t,ks,Vs(t.forward,{targetChatIds:c})));var u=t.forward.messageIds,d=void 0===u?[]:u,h=e.forward,f=h.addMessageId,l=h.removeMessageId,p=_(d);return f&&!p.includes(f)&&p.push(f),l&&p.includes(l)&&(p=p.filter((function(t){return t!==l}))),e.forward.messageIds&&(p=e.forward.messageIds),ot(p,d)||(t=Hs(t,ks,Vs(t.forward,{messageIds:p}))),t.forward.type||(t=Hs(t,"forward",null)),t}function Ps(t,e,n){if("text"in e){var r=null==e.text?"":String(e.text),s=n.get("config.server.max-msg-length");s&&(r=r.slice(0,Math.round(5*s))),t=Hs(t,"text",r)}if("urls"in e){var o=Array.from(new i((e.urls||[]).map((function(t){return t.trim()})))).slice(0,10);t.urls&&ot(o,t.urls)||(t=Hs(t,"urls",o))}return t}function Ls(t,e){var n=t.upload;if(e.addAttach&&(n=new s(n),Gs(e.addAttach).forEach((function(t){!n.has(t)&&lt(t)&&n.set(t,Fs(t))}))),e.removeAttach){var r=Gs(e.removeAttach);n=new s(n);var i=t.link;r.forEach((function(e){var r;"EDIT"===t.type&&(null===(r=i)||void 0===r?void 0:r.attaches)&&(t=function(t,e){if(!t.link)return t;var n=t.link;n&&n.attaches&&(n.attaches=n.attaches.filter((function(t){return t!==e||"file"in t&&e instanceof Blob&&t.file!==e})));return v({},t)}(t,e)),n.delete(e)}))}if(e.replaceAttach&&n){var o=new s;n.forEach((function(t,n){n===e.replaceAttach.from?o.set(e.replaceAttach.to,Fs(e.replaceAttach.to)):o.set(n,t)})),n=o}return n&&!n.size&&(n=null),Hs(t,"upload",n)}function Ns(t,e,n){var r;e.edit&&((r=Ks(n,t.chatId,e.edit))&&(t=Vs(t,{type:"EDIT",link:v({},r),text:r.text||"",messageElements:r.elements})));e.reply&&((r=Ks(n,t.chatId,e.reply))&&(t=Vs(t,{type:"REPLY",link:r})));return e.resetLink&&(t=Vs(t,{type:"NEW",link:null,text:"EDIT"===t.type?"":t.text})),t}function Ds(t,e){var n=t.shares||{items:[],selected:-1,disabled:!1};return"setShares"in e&&(n=e.setShares?Vs(n,{items:e.setShares,selected:n.selected<0||n.selected>=e.setShares.length?0:n.selected}):null),"selectShare"in e&&(n=Hs(n,"selected",Math.max(0,Math.min(e.selectShare,n.items.length-1)))),"disableShares"in e&&(n=Hs(n,"disabled",!!e.disableShares)),("urls"in e&&!t.urls.length||n&&!n.items.length&&!n.disabled||n&&n.disabled&&!t.text)&&(n=null),Hs(t,"shares",n)}function Us(t,e){return"disableNotify"in e&&(t=Hs(t,"notifyDisabled",!!e.disableNotify)),t}function xs(t,e){var n=(e||{}).voiceMessage;return null===n&&(t=Hs(t,"voiceMessage",null)),n?t=Hs(t,"voiceMessage",v(v({},t.voiceMessage),n)):t}function js(t,e){return"chunks"in e&&(t=Hs(t,"chunks",e.chunks)),t}function qs(t,e,n){var r=t.get(e);if(r&&r.attaches){var s=r.attaches.filter((function(t){return!n.includes(t.file)}));if(!s.length&&!r.text)return t.delete(e);if(s.length!==r.attaches.length)return t.set(e.concat("attaches"),s)}return t}function Fs(t){return{file:t,_type:lt(t),status:"_type"in t?"completed":"idle"}}function Hs(t,e,n){return t[e]===n||((t=v({},t))[e]=n),t}function Vs(t,e){return Object.keys(e).reduce((function(t,n){return Hs(t,n,e[n])}),t)}function Gs(t){return null==t?[]:Array.isArray(t)?t:[t]}function Ks(t,e,n){var r=te(t,e);return r&&ie(r,n)}var Bs="chats";function zs(t,e,n){return e.forEach((function(e){return Ws(t,e,n&&n[e.id])})),t}function Ws(t,e,n){var r=ne(t,e,n),i=[Bs,e.id],o=te(t,i);if(o&&(o.selected&&(r.selected=o.selected),o.lastEventTime!==r.lastEventTime&&(r.selected||(r.messages=null)),!r.link&&o.link&&(r.link=void 0),!r.admins&&o.admins&&(r.admins=void 0),!r.videoConversation&&o.videoConversation&&(r.videoConversation=void 0),o.blockedParticipantsCount&&!r.blockedParticipantsCount&&(r.blockedParticipantsCount=0),o.media&&r.media&&o.lastMessage&&r.lastMessage&&(r.media=o.media),r.isSuspended||(r.isSuspended=!1),t=ei(t,i,o)),r.messages?r.messages=le(r.messages):o&&o.messages&&(r.messages=le(o.messages)),o&&r.created!==o.created)if(o.selected){if(r.messages){var a=new s;r.messages.forEach((function(t,e){t.time>=r.created&&a.set(e,t)})),r.messages=a}}else r.messages=null;return t=function(t,e){var n=te(t,e);n.messages&&n.messages.size&&n.messages.forEach((function(r,s){t=t.set(e.concat(["messages",s,"actions"]),mt(t,n,r))}));return t}(t=t.assign(i,r),i),o&&r.link!==o.link&&(t=function(t,e){var n=te(t,e);n.messages&&n.messages.size&&n.messages.forEach((function(r,s){t=t.set(e.concat(["messages",s,"publicLink"]),K(n,r.id))}));return t}(t,i)),St(t,e.id)}function Js(t,e){var n=ee(t,e);return n&&(t=(t=t.set(n.concat("messages"),new s)).set(n.concat("media"),ce())),di(t,e)}function Ys(t,e,n,r){void 0===r&&(r={});var i=ee(t,e);if(!i)return t;var o=te(t,i),a=je(t,n.sender);if(a&&a.current){hi(t,e,!1);var c=Array.isArray(n.attaches)&&n.attaches.find((function(t){return"CONTROL"===t._type}));if(c&&"leave"===c.event&&a.current)return fi(t,e)}var u=re(t,o,n);t=function(t,e,n){ee(t,e)&&n.attaches&&n.attaches.forEach((function(r){if("CONTROL"===r._type)switch(r.event){case"title":return function(t,e,n){var r=ee(t,e);return r?t.set(r.concat("title"),n):t}(t,e,r.title);case"icon":return li(t,e,r.url,r.fullUrl);case"add":return Pn(t,e,r.userIds);case"remove":return Ln(t,e,r.userId);case"leave":return pi(t,e,n.sender);case"joinByLink":return Pn(t,e,[r.userId])}}));return t}(t,e,u),t=Zs(t,e,n.sender),(!o.lastMessage||o.messages&&function(t,e){return!!t.messages&&(!!t.lastMessage&&t.messages.has(t.lastMessage.uid)||t.messages.has(t.lastMessage.id)||0===t.messages.size||!!e&&Array.from(t.messages.values()).some((function(t){return t.id===e})))}(o,r.prevMessageId))&&(t=function(t,e){var n=ee(t,e);if(n){var r=te(t,n);if(!r.messages)return console.warn("Chat %d has empty messages",e),t.set(n.concat("messages"),new s);if(!(r.messages instanceof s)){console.warn("Chat %d has non-map messages: %o",e,r.messages);var i=Object.keys(r.messages).reduce((function(t,e){return/^[-\d]+$/.test(e)&&t.set(Number(e),r.messages[e]),t}),new s);return t.set(n.concat("messages"),i)}}return t}(t,e),t=t.set(i.concat("messages",u.uid),u)),function(t,e,n){var r=n&&n.current;if(r||e.status&&"ACTIVE"!==e.status)return!1;var s=t.participants.find((function(t){return t.user.current}));if(s)return s.time<e.time;return!0}(o,u,a)&&(t=t.set(i.concat("unreadCount"),(o.unreadCount||0)+1));var d=r.lastMentionMessageId;return d&&"DIALOG"!==o.type&&Xs(t=t.set(i.concat("lastMentionMessageId"),d),e,u),(!o.lastMessage||o.lastMessage.time<=n.time)&&n.id&&_i(t=t.assign(i,{lastEventTime:n.time,lastMessage:u}),[o.id],!0),t}function Xs(t,e,n){var r=ee(t,e);return r?t=t.set(r.concat("lastMentionMessage"),n):t}function Qs(t,e,n){var r=ee(t,e);if(!r)return t;var s=te(t=gi(t=Ys(t,e,n),e,n.sender,n.time),r);return t=s.pending?t.set(r.concat("pending",s.pending.length),n):t.set(r.concat("pending"),[n])}function $s(t,e,n,r){var i=ee(t,e);if(!i)return t;var o=te(t,i),a=wt(t,o),c=ie(o,n);if(!c||"REMOVED"===c.status)return t;if(t=ai(t,e,c.uid),o.selectedMessages&&o.selectedMessages.find((function(t){return t.id===c.id}))&&o.posting&&o.posting.forward&&o.posting.forward.messageIds&&o.posting.forward.messageIds.includes(c.id)){var u={removeMessageId:c.id};t=Ms(t,o.id,{forward:u})}if(t=o.selected?t.assign(i.concat(["messages",c.uid]),{status:"REMOVED",actions:null,error:null}):t.delete(i.concat("messages",c.uid)),o.lastMessage&&c.id===o.lastMessage.id){var d=i.concat("lastMessage"),h=function(t,e){var n=te(t,e);if(n&&n.messages)for(var r=n.messages instanceof s?Array.from(n.messages.values()):n.messages,i=r.length-1;i>=0;i--)if("REMOVED"!==r[i].status)return r[i]}(t,o.id);t=h?t.set(d,h):t.delete(d)}o.lastMentionMessageId===n&&Xs(t=t.set(i.concat("lastMentionMessageId"),null),e,null);var f=je(t,c.sender);return!(a&&a<c.time&&o.unreadCount)||f&&f.current||(t=t.set(i.concat("unreadCount"),o.unreadCount-1)),r&&vi(t),t}function Zs(t,e,n){var r=ee(t,e);if(r){var s=te(t,r);if(s.typingParticipants){var i=r.concat("typingParticipants"),o=s.typingParticipants.filter((function(t){return rt(t.user)!==n}));t=o&&o.length?t.set(i,o):t.set(i,null)}}return t}function ti(t,e){var n=ee(t,e);if(!n)return t;var r=te(t,n);return ei(t=(t=t.set(n.concat("pinnedMessage"),0)).set(n.concat("pinnedMessage"),null),n,r)}function ei(t,e,n){var r=te(t,e),s=r&&r.pinnedMessage,i=n&&n.pinnedMessage;if(s===i||s&&i&&s.id===i.id)return t;if(s){var o=e.concat("messages",s.uid);t.has(o)&&(t=t.set(o.concat("actions"),mt(t,r,s)))}else i&&(t=ti(t,r.id));return t}function ni(t,e,n,r){var i=ee(t,e);if(i){var o=te(t,i),a=function(e){ae(t,e).forEach(r)};if(oe(t,e,n).forEach(a),o.pinnedMessage&&n(o.pinnedMessage)&&a(i.concat("pinnedMessage")),o.media){var c=i.concat("media");o.media.forEach((function(t,e){t.items.forEach((function(t,s){"messageId"in t&&n({id:t.messageId})&&r(c.concat(e,"items",s,"attach"))}))}))}if(o.mediaList){var u=i.concat("mediaList");Object.keys(o.mediaList).forEach((function(t){var e=o.mediaList&&o.mediaList[t];e&&e.items instanceof s&&e.items.forEach((function(e,n){r(u.concat(t,"items",n,"attach"))}))}))}}}function ri(t,e,n){var r=function(t,e,n){var r=ee(t,e);if(r){var s=(t.get(r.concat("pending"))||[]).findIndex((function(t){return t.cid===n}));if(-1!==s)return r.concat("pending",s)}}(t,e,n);if(r){var s=r.slice(0,-1);return t.delete(1===t.get(s).length?s:r)}return t}function si(t){var e=t.get("selectedChat");if(e){!function(t,e){var n=te(t,e);n&&n.messages&&n.messages.forEach((function(n,r){t=ii(t,e,r)}))}(t,e.id);var n=e.posting;n&&n.forward||(t=ci(t,e.id)),t.set("selectedChat",null),t.assign(ee(t,e.id),{selected:!1,blockedParticipants:void 0,participantsSearch:void 0,members:void 0,sortTime:n?n.updated:0}),vi(t)}return t}function ii(t,e,n){var r=te(t,e);if(r&&r.messages){var s=ie(r,n);if(s&&"REMOVED"===s.status)return t.delete([Bs,e,"messages",s.uid])}return t}function oi(t,e,n){var r=ee(t,e);if(r){var s=te(t,r),i=ie(s,n);if(i){var o=r.concat("selectedMessages"),a=U(i);s.selectedMessages?s.selectedMessages.find((function(t){return t.id===i.id}))||(t=t.set(o,s.selectedMessages.concat(a))):t=t.set(o,[a])}}return t}function ai(t,e,n){var r=ee(t,e),s=r?te(t,r):null;if(s&&s.selectedMessages){var i=r.concat("selectedMessages"),o=s.selectedMessages.filter((function(t){return t.id!==n&&U(t)!==n}));t=o.length?t.set(i,o):ci(t,e)}return t}function ci(t,e){var n=ee(t,e);return n&&(t=t.set(n.concat("selectedMessages"),null)),t}function ui(t,e,n){var r=ee(t,e);if(!r)return t;var s,i=t.get(r.concat("messages"));if(i&&n){var o,a=t.get(r);i.forEach((function(t){if(void 0===s){var e=t.time===n,r=t.time>n&&o&&o.time<n,i=void 0===o&&(a.created>=n||t.time>n);(e||r||i)&&(s=t),o=t}}))}return s?t.set(r.concat("focusedMessage"),U(s)):di(t,e)}function di(t,e){var n=ee(t,e);return n?t.set(n.concat("focusedMessage"),null):t}function hi(t,e,n){var r=ee(t,e);return t.set(r.concat("readMarkLock"),n)}function fi(t,e,n){var r=t.get("chatList");if(r){var s=!1;r=t.get("chatList").filter((function(t){return("number"==typeof t?t:t.id)!==e||(s=!0,!1)})),s&&t.set("chatList",r)}var i=t.get("selectedChat");i&&i.id===e&&t.set("selectedChat",null);var o=ee(t,e);return o&&(t.assign(o,{status:"REMOVED",selected:!1,messages:null,lastMessage:null}),n&&Ys(t,e,n)),t}function li(t,e,n,r){var s=ee(t,e);return s?t.assign(s,{iconUrl:n,fullIconUrl:r}):t}function pi(t,e,n){n||(n=Fe(t));var r=n&&"object"==typeof n?n.id:n,s=ee(t,e);if(s){var i=te(t,s),o=i.participants.filter((function(t){return t.user.id!==r}));t=ve(t=t.assign(s,{participants:o,participantsCount:i.participantsCount?i.participantsCount-1:o.length}),s)}return t}function gi(t,e,n,r,s,i){var o=ee(t,e);if(!o)return t;var a=te(t,o),c=o.concat("participants"),u=t.get(c),d=Fe(t);if(null==r&&(r=d.id),u)for(var h=0;h<u.length;h++)if(u[h].user.id===r){t=t.set(c.concat(h,"time"),n);break}if(r===d.id&&(t=St(t,e,n),a.lastMentionMessageId)){var f=ie(a,a.lastMentionMessageId);f&&f.time<=n&&(t.set(o.concat("lastMentionMessageId"),null),Xs(t,e,null))}return null!=s&&(t=t.set(o.concat("unreadCount"),s)),i&&a.selected&&(t=hi(t,e,!0)),t}function vi(t){var e=t.get("chatList").slice().filter((function(t){return!function(t){return Boolean(t.options&&t.options.SENT_BY_PHONE&&!t.lastMessage)}(t)})).sort(mi);return t.set("chatList",e)}function mi(t,e){var n=t.settings.favIndex||0;return(e.settings.favIndex||0)-n||yi(e)-yi(t)||e.id-t.id}function yi(t){if(t.sortTime)return t.sortTime;var e=t.lastMessage?t.lastMessage.time:0;return Math.max(t.joinTime,e)||t.lastEventTime}function _i(t,e,n){var r=t.get("chatList"),s=new i(r.map((function(t){return t.id})));return e=e.filter((function(t){var e="number"==typeof t?t:t.id;return!s.has(e)})),e.length?(function(t,e,n){if(e&&e.length){var r=e.map((function(t){return"number"==typeof t?t:t.id})),s=t.get("chatList")||[];t.set("chatList",s.concat(r)),vi(t)}null!=n&&t.set("chatMarker",n)}(t,e),!0):(n&&vi(t),!1)}function Ii(t,e){return t.assign("state",e)}function ki(t,e){var n=["moderatedGroups","chatLists"],r=t.get(n);r||(r=new s,t.set(n,r));var i=r.get(e);i||(i=new s,t.set(["moderatedGroups","chatLists",e],i))}function Ei(t,e,n,r){return void 0===n&&(n="NONE"),ki(t,e),t.set(["moderatedGroups","chatLists",e,n,"state"],r)}var Si="Update configuration",wi="Update chat configuration",Ci="Update forward info",Mi="config";function bi(t,e,n){var r=[Mi,"chats"],s=r.concat(e);return t.has(r)||(t=t.set(r,{})),t.set(s,ht(t.get(s),n))}var Ti="Start file upload",Oi="Set file upload URL",Ai="Update file upload progress",Ri="Complete file upload",Pi="Remove file upload",Li="File upload error",Ni="Mark file as local",Di={loading:"loading",complete:"complete",error:"error"};function Ui(t,e,n){return t.assign(["download",e],{status:Di.complete,file:n,localUrl:URL.createObjectURL(n)})}var xi="Update single group",ji="Updates list of groups",qi="Remove group from store",Fi="Set group error",Hi="Set moderated list",Vi="Set moderated groups counters";function Gi(t,e){return Array.isArray(e)&&e.forEach((function(e){return Ki(t,e)})),t}function Ki(t,e){var n=["groups",e.id],r=t.get(n);return e=Bi(e),t=r&&"REMOVED"===r.status?t.set(n,e):t.assign(n,e)}function Bi(t){return v(v({},t),{name:t.name||t.names&&t.names[0].name||"#"+t.id,official:!!t.options&&t.options.indexOf("OFFICIAL")>-1,type:"GROUP"})}var zi="SAVE_ONBOARDING_ADDITIONAL",Wi="SAVE_LEFTCOL_ADDITIONAL",Ji="SAVE_USER_SMILES",Yi="UPDATE_HELLO_STICKERS",Xi="okWeb";var Qi="Update search data",$i="Append search results",Zi="Reset search",to='Set search state as "loading"',eo='Set search state as "idle"',no="Reset message search",ro="idle",so="loading";function io(t,e,n){return n?t.assign(e,n):oo(t,e)}function oo(t,e){return void 0===e&&(e=["search"]),t.set(e,null)}var ao="Store stickers sections",co="Update stickers",uo="Update emoji stickers suggestion",ho="Update recently used emoji",fo="Update recently used stickers",lo="Update recently used gif",po="Update postcards",go="Set stickers loading state",vo="Set stickers sync time",mo="Store sticker sets",yo="Add sticker or stickerset to collection",_o="Rearrange sticker or stickerset in collection",Io="Remove sticker or stickerset from collection",ko="Clear recent history",Eo="Clear favorite stickers",So="assets.stickerSections.POSTCARDS",wo="assets.stickerSections.FAVORITE_STICKER_SETS",Co="assets.stickerSections.FAVORITE_STICKERS",Mo="assets.stickerSections.RECENT",bo="stickers",To=30,Oo=16,Ao=["🏻","🏼","🏽","🏾","🏿"];function Ro(t,e){return Array.isArray(e)&&e.forEach((function(e){return function(t,e){return e.localUpdateTime=Date.now(),e.id=e.id||e.stickerId,t.assign([bo,e.id],e)}(t,e)})),t}function Po(t,e,n){var r=_(t),s=r[n];return r.splice(n,1),r.splice(e,0,s),r}function Lo(t,e){return e.filter((function(t){return"EMOJI"!==t.type||-1===Ao.indexOf(t.value)})).map((function(t){if("EMOJI"===t.type)switch(t.value){case":-\\$":return v(v({},t),{value:":-$"});case"(\\$)":return v(v({},t),{value:"($)"})}return t}))}var No="ALL",Do="react",Uo="Update detailed reactions",xo="Last reaction update",jo="Reaction load state",qo="Update reactions";function Fo(t,e,n,r,s){return t=function(t,e,n){var r=Vo(t,e,n,!0);if(null==r)return t;var s=t.get(r);if(s){var i=Bo({current:s});i.filter&&(Object.entries(i.filter).forEach((function(t){var e=t[0],n=t[1];i.filter[e]=v(v({},n),{inconsistent:!0})})),t=t.set(r,i))}return t}(t,e,n),t=t.set(r,s)}function Ho(t,e,n){var r,s=te(t,e);return s&&s.messages&&s.messages.forEach((function(t){t.id===n&&(r=t)})),r}function Vo(t,e,n,r){var s=Ho(t,e,n);return s?["chats",e,"messages",U(s),r?"reactionsDetailed":"reactionInfo"]:null}var Go=function(){return{byUserIds:new s,filter:{},total:new s}},Ko=function(){return{items:[],loadState:e.LoadState.idle}};function Bo(t){var e,n=t.reaction,r=t.loadState,i=t.reactions,o=t.marker,a=t.reactionInfo,c=t.resetInconsistency,u=t.current,d=n||No;u&&!c||(u=Go());var h={};u.filter&&Object.entries(u.filter).forEach((function(t){var e=t[0],n=t[1];h[e]=zo(n)})),h[d]=zo(h[d],r,i,o);var f=new s(u.byUserIds);!n&&i&&i.forEach((function(t){return f.set(t.userId,t.reaction)}));var l=new s(u.total);return a&&(l.set(No,a.totalCount),null===(e=a.counters)||void 0===e||e.forEach((function(t){return l.set(t.reaction,t.count)}))),{byUserIds:f,filter:h,total:l}}function zo(t,e,n,r){return void 0===t&&(t=Ko()),void 0===n&&(n=[]),{items:_(t.items,n),marker:null!=r?r:t.marker,loadState:e||t.loadState}}var Wo="INIT_CONGRATS_LIST",Jo="GET_CONGRATS_LIST",Yo="EXTEND_CONGRATS_LIST",Xo="EXTEND_USER",Qo="UPDATE_COUNTER",$o="DELETE_USER";var Zo="Store animoji",ta="Store animoji sets",ea="Set animoji sections for animoji-sets order",na="Set animoji sync time",ra="animojis",sa=[ra,"animoji"],ia=[ra,"animojiSets"],oa=[ra,"animojiSections"],aa=[ra,"sync"];function ca(t,e){if(Array.isArray(e)){var n=new s(t.get(sa));e.forEach((function(t){return n.set(t.id,t)})),t.set(sa,n)}return t}var ua=[function(t,e){switch(e.type){case k:return R(t,!0);case E:return R(t,!1);case M:return A(t,!0);case b:return A(t,!1)}return t},function(t,e){switch(e.type){case I:return function(t){var e=[Mi,"user"],n=t.get(e);if(n&&!("UI_NOTIFICATIONS"in n)){var r=t.get([Mi,"server"]),s=!!r&&r["browser-notif-fix"];t=t.set(e.concat("UI_NOTIFICATIONS"),s)}return t}(t);case T:case Si:return function(t,e){return Object.keys(e).forEach((function(n){if("chats"===n)t=function(t,e){e&&Object.keys(e).map(Number).forEach((function(n){t=bi(t,n,e[n])}));return t}(t,e[n]);else if("server"===n)t=function(t,e){e&&(t=t.assign([Mi,"server"],e));return t}(t,e[n]);else{var r=[Mi,n],s=t.get(r);t=t.set(r,ht(s,e[n]))}})),t}(t,e.config);case wi:return bi(t,e.chatId,e.config);case Ci:return function(t,e){var n=t.get([Mi,"server"]),r=n&&n["quick-forward-limit"]||5,s=[Mi,"user","FORWARDED"],i=t.get(s)||[],o=[],a=_(e);i.forEach((function(t){var e=t.id,n=t.count,r=a.indexOf(e);r>-1&&(n++,a.splice(r,1)),o.push({id:e,count:n})}));var c=a.map((function(t){return{id:t,count:1}})),u=_(o,c).sort((function(t,e){return e.count-t.count})).slice(0,10*r);return t.set(s,u)}(t,e.chatIds)}return t},function(t,e){switch(e.type){case I:return function(t){var e=t.get(Is);if(!e)return t.set(Is,new s);"object"!=typeof e||e instanceof s||(t=t.set([Is],new s),Object.keys(e).forEach((function(n){t=Os(t,Number(n),e[n])})));return t}(t);case Es:return Ms(t,e.chatId,e.actions);case nr:return e.keep?t:Ts(t,e.chatId,!0);case Xn:case Ss:return Ts(t,e.chatId);case $n:return As(bs(t),e.chatId);case Zn:return bs(t);case ws:return function(t,e,n){return t=n?t.set([Is,e,"preview"],n):t.delete([Is,e,"preview"]),As(t,e)}(t,e.chatId,e.messages)}return function(t,e){var n=Wr(e);if(n){var r=e.chatId,s=e.file;return As(Jr(t,[Is,r,"upload",s],n),r)}return t}(t,e)},function(t,n){switch(n.type){case I:return function(t){var e=t.get(Bs);if(Array.isArray(e)){var n=new s;return e.forEach((function(e){var r=ne(t,e);Array.isArray(e.messages)&&(r.messages=new s,e.messages.forEach((function(e){var n=re(t,r,e);r.messages.set(e.id,n)}))),n.set(e.id,r)})),t.set(Bs,n)}return t}(t);case T:return function(t,e,n,r,s){var i=Fe(t).id;Array.isArray(e)&&(e=e.filter((function(e){var n=t.get([Bs,e.id]);return n&&(n.posting||n.isFake)||!ye(e,i)?!(n&&n.isFake&&"REMOVED"===e.status):(t=fi(t,e.id),!1)})));n&&Object.keys(n).forEach((function(e){e=Number(e);var r=t.get([Bs,e]);r&&n[e].forEach((function(n){var s=re(t,r,n),i=[Bs,e,"messages",U(s)];"REMOVED"===s.status?t=t.delete(i):"EDITED"===s.status&&t.has(i)&&(t=t.set(i,s)),r.lastMessage&&r.lastMessage.id===s.id&&(t=t.set([Bs,e,"lastMessage"],s))}))}));t=zs(t,e,r);var o=e.filter((function(t){return!ye(t,i)}));_i(t,o,!0),s&&t.set("chatMarker",s);return e.forEach((function(e){var n=te(t,e.id);n&&!n.selected&&(t=function(t,e){var n=ee(t,e);if(n){var r=te(t,n);if(r.lastMessage&&r.messages&&!r.messages.has(U(r.lastMessage)))return t.set(n.concat("messages"),null)}return t}(t,e.id))})),t}(t,n.chats,n.messages,n.config.chats,n.chatMarker);case S:return Ii(t,e.LoadState.chatsLoading);case w:return Ei(t,n.groupId,n.filter,e.LoadState.chatsLoading);case C:return Ii(t,e.LoadState.idle);case xn:return zs(t,n.chats,n.config),vi(t);case qn:return function(t,n,r){return n.forEach((function(e){return Ws(t,e)})),_i(t,n,!0),Ii(t,e.LoadState.idle),t.set("chatMarker",r)}(t,n.chats,n.marker);case Fn:return function(t,n,r,s,i){void 0===s&&(s="NONE");return r.forEach((function(e){return Ws(t,e)})),_i(t,r,!0),Ei(t,n,s,e.LoadState.idle),function(t,e,n,r){void 0===n&&(n="NONE");void 0===r&&(r=0);ki(t,e);var s=["moderatedGroups","chatLists",e,n,"marker"],i=t.get(s);(null==i||r<i)&&(t=t.set(s,r));return t}(t,n,s,i)}(t,n.groupId,n.chats,n.filter,n.marker);case Hn:return function(t){return t.set("oldestChatLoaded",!0)}(t);case Vn:return function(t,e){return zs(t,e),_i(t,e),t}(t,n.chats);case jn:return Ws(t,n.chat);case Gn:return function(t,e,n,r){var i=ee(t,e);if(!i)return console.warn("Отсутствует чат с id",e),t;if(n&&n.length){var o=te(t,i),a=function(t,e){if(!t||!t.messages||!function(t,e){for(var n=0,r=e.length;n<r;n++)if(t.messages.has(U(e[n])))return!0;return!1}(t,e))return e;var n=Array.from(t.messages.values()),r=e[0];return r&&r.time<=n[0].time?e.concat(n):n.concat(e)}(o,n.map(re.bind(null,t,o)));t=function(t,e,n){var r=ee(t,e);if(!r)throw new Error("Не могу записать сообщения чата "+e+": объект чата отсутствует в хранилище");for(var s=te(t,r),i=null,o=n.length-1;o>=0;o--)if(n[o].id){i=n[o];break}return t=t.assign(r,{lastMessage:!s.lastMessage||s.lastMessage.time<i.time?i:s.lastMessage,messages:le(n)}),St(t,e)}(t,e,a)}else{var c=i.concat("messages");t.get(c)||(t=t.set(c,new s))}return ui(t,e,r)}(t,n.chatId,n.messages,n.focus);case Kn:return Js(t,n.chatId);case Bn:return di(t,n.chatId);case zn:return Ys(t,n.chatId,n.message,n);case Wn:return Xs(t,n.chatId,n.message);case Jn:return Qs(t,n.chatId,n.message);case Yn:return ri(t,n.chatId,n.cid);case Xn:return function(t,e,n){var r=ee(t,e),s=r&&te(t,r),i=function(t){return t.id||t.cid}(n);if(!s||!s.messages||!i)return t;return s.messages.forEach((function(e,o){if(o===i||e.id===i||e.cid===i){var a=function(t){return!function(t){return"chatId"in t&&(!t.sender||"number"!=typeof t.sender)}(t)}(n)?v(v(v({},e),re(t,s,n)),{status:"EDITED"}):v(v({},n),{status:"EDITED"});t=t.assign(r.concat("messages",o),a)}})),t}(t,n.chatId,n.message);case Qn:return $s(t,n.chatId,n.messageId,!0);case tr:return function(t,e,n){var r=ee(t,e);return r?t.assign(r,{loadState:n}):t}(t,n.chatId,n.loadState);case"Set chat error":return function(t,e,n){var r=ee(t,e);return r?t.assign(r,{lastError:n}):t}(t,n.chatId,n.error);case er:return gi(t,n.chatId,n.mark,n.userId,n.unread,n.setAsUnread);case $n:return function(t,e,n){var r=ee(t,e);if(!r)return console.warn("No chat with id",e),t;var s=te(t,r);if(!s.selected){if(si(t),t=hi(t,e,!1),s.messages){var i=s.posting;!i||!i.forward||"MESSAGES"!==i.forward.type||s.selectedMessages&&s.selectedMessages.length||i.forward.messageIds.forEach((function(n){t=oi(t,e,n)}))}t.set(r.concat("selected"),!0),t.set("selectedChat",s.id)}return ui(t,e,n)}(t,n.chatId,n.focusedTime);case Zn:return si(t);case nr:return function(t,e,n){return Qs(t,e,n)}(t,n.chatId,n.message);case rr:return function(t,e,n){var r=ee(t,e);if(!r)throw new Error("Не могу записать сообщения чата "+e+": объект чата отсутствует в хранилище");var s=Fe(t).id,i=te(t,r);(n.sender===s||function(t,e){var n;return!("GROUP"!==t.type||!(null===(n=e.groupChatInfo)||void 0===n?void 0:n.isModerator))}(n,i))&&(t=gi(t,e,s,n.time));t=ri(t,e,n.cid);var o=re(t,i,n),a=U(o),c=r.concat("messages",a);if(i.messages&&i.messages.has(a)){var u=i.messages.get(a);o.attaches&&u.attaches&&(o.attaches=o.attaches.map((function(t,e){var n=u.attaches[e];return n&&n.file&&!("_type"in n.file)?v({file:n.file},t):t})));var d=Array.from(i.messages.keys());t=d[d.length-1]!==a&&"EDITED"!==o.status?(t=t.delete(c)).set(c,o):t.assign(c,o),o.error||(t=t.delete(c.concat("error")))}return t=t.assign(r,{lastEventTime:o.time,lastMessage:"EDITED"!==o.status?o:i.lastMessage,sortTime:0}),_i(t,[e],!0),St(t,e)}(t,n.chatId,n.message);case sr:return function(t,e,n){return de(t,e).forEach((function(e){t.get(e.primary.concat("cid"))===n&&(t=t.delete(e.primary),e.secondary&&(t=t.delete(e.secondary)))})),t}(t,n.chatId,n.messageCid);case ir:return function(t,e,n,r){var s=ee(t,e),i=s?te(t,s):null;if(!i||!i.messages)return console.warn("Отсутствует чат или сообщения в чате",e),t;t=ri(t,e,n);var o=Fe(t).id;return i.messages.forEach((function(e,i){if(e.cid===n&&e.sender.id===o){var a=s.concat("messages",i,"error");t=r?t.set(a,r):t.delete(a)}})),t}(t,n.chatId,n.messageId,n.error);case or:return function(t,e,n){te(t,e)&&(n.forEach((function(n){return $s(t,e,n)})),vi(t));return t}(t,n.chatId,n.messageIds);case ar:return oi(t,n.chatId,n.messageId);case cr:return ai(t,n.chatId,n.messageId);case ur:return ci(t,n.chatId);case dr:return function(t,e,n,r){void 0===r&&(r="TEXT");var s=ee(t,e);if(s&&n!==Fe(t).id){var o=te(t,s);if(o.typingParticipants){var a=o.typingParticipants.slice(),c=new i(a.map((function(t){return rt(t.user)})));c.has(n)||(c.add(n),a.push({user:n,type:r})),t=t.set(s.concat("typingParticipants"),a)}else t=t.set(s.concat("typingParticipants"),[{user:n,type:r}])}return t}(t,n.chatId,n.userId,n.attachType);case hr:return Zs(t,n.chatId,n.userId);case fr:return function(t,e){var n=ee(t,e);if(n)return Xs(t=t.set(n.concat("media"),ce()).set(n.concat("lastMentionMessageId"),null).delete(n.concat("lastMessage")),e,null),Js(t,e);return t}(t,n.chatId);case lr:return fi(t,n.chatId);case pr:return pi(t,n.chatId);case"Update all chats":return function(t){return t.delete("peekChat").set(Bs,new s)}(t);case gr:return li(t,n.chatId,n.url,n.fullUrl);case"Set chat message URL":return function(t,e,n,r){var s=ee(t,e),i=s.concat("messages",n),o=t.get(i);return o?t.set(i.concat("url"),r):t}(t,n.chatId,n.messageUid,n.messageUrl);case vr:return function(t,e,n,r,s){s=v({},s),Object.keys(s).forEach((function(t){var e=s[t];"string"==typeof e&&(e=e.replace(/^http:/,"https:")),s[t]=e}));var i={urlData:s};return ni(t,e,(function(t){return t.id===n}),(function(e){var n=t.get(e);"VIDEO"===n._type&&n.videoId===r&&(t=t.assign(e,i)),"SHARE"===n._type&&n.media&&n.media.videoId===r&&(t=t.assign(e.concat("media"),i))})),t}(t,n.chatId,n.messageId,n.videoId,n.urlData);case mr:return function(t,e,n,r,s){var i={url:s};return ni(t,e,(function(t){return t.id===n}),(function(e){var n=t.get(e);"MUSIC"===n._type&&n.trackId===r&&(t=t.assign(e,i))})),t}(t,n.chatId,n.messageId,n.trackId,n.url);case yr:return function(t,e,n){return t.set(ee(t,e).concat("nextLink"),n)}(t,n.chatId,n.data);case _r:return function(t,e){return t.set(["createdChannel"],e)}(t,n.chatId);case Ir:return function(t,e,n,r){var s=ee(t,e),i=s&&te(t,e);s&&i&&i.messages&&i.messages.forEach((function(e,i){e.attaches&&e.attaches.forEach((function(e,o){if(e.fileId===n){var a=s.concat("messages",i,"attaches",o);t=t.assign(a,{downloadUrl:r})}}))}));return t}(t,n.chatId,n.fileId,n.url);case kr:return function(t,e,n){var r=ee(t,e);return r?t.assign(r,{hidePinnedMessage:n}):t}(t,n.chatId,n.hidden);case Er:return ti(t,n.chatId);case Sr:return function(t,e,n){var r=ee(t,e);if(!r)return t;var s=te(t,r),i=oe(t,e,(function(t){return t.id===n}))[0];i&&(t=t.delete(r.concat("hidePinnedMessage")).assign(r,{pinnedMessage:t.get(i)}));return ei(t,r,s)}(t,n.chatId,n.messageId);case"Toggle read mark lock":return hi(t,n.chatId,n.locked);case wr:return ii(t,n.chatId,n.messageId);case Cr:return function(t,e,n){return t.set(ee(t,e).concat("commands"),n)}(t,n.chatId,n.commands);case Mr:return function(t,e,n){var r=e.chatId,s=e.messageId,i=e.row,o=e.column,a=oe(t,r,(function(t){return t.id===s}))[0];if(a){var c=t.get(a);c.attaches&&c.attaches.forEach((function(e,r){"INLINE_KEYBOARD"===e._type&&(t=t.set(a.concat(["attaches",r,"keyboard","buttons",i,o,"loading"]),n))}))}return t}(t,n.data,n.loading);case br:return function(t,e,n){n&&Ys(t,e,n);return t.set(ee(t,e).concat("isSuspended"),!1)}(t,n.chatId,n.message);case Tr:return function(t,e,n,r){var s=ee(t,e),i=te(t,s),o=ie(i,n);if(!o)return t;var a=s.concat(["messages",o.uid]);(!o.attaches||!o.attaches.some((function(t){return"LOCATION"===t._type}))&&o.link&&"FORWARD"===o.link.type)&&(a=a.concat(["link","message"]));if(o=t.get(a),o&&o.attaches){var c=o.attaches.findIndex((function(t){return"LOCATION"===t._type}));if(-1!==c)return t.set(a.concat(["attaches",c,"image"]),r)}return t}(t,n.chatId,n.messageId,n.image);case Or:return function(t,e){return t.set(ee(t,e).concat("hideAlert"),!0)}(t,n.chatId);case Ar:return function(t,e){return t.set(ee(t,e).concat("hideAlertImportant"),!0)}(t,n.chatId);case Rr:return function(t,e){var n=t.get("asideActive")||[];n.includes(e)||t.set("asideActive",_(n,[e]));return t}(t,n.reason);case Pr:return function(t,e){var n=t.get("asideActive")||[];n.includes(e)&&t.set("asideActive",n.filter((function(t){return t!==e})));return t}(t,n.reason)}return t},function(t,e){switch(e.type){case En:return Pn(t,e.chatId,e.userIds);case Sn:return Ln(t,e.chatId,e.userId);case wn:return function(t,e,n){var r=ee(t,e);if(r){var s=t.get(r.concat("blockedParticipantsCount"));if(s){var i=r.concat(["blockedParticipants","items"]);if((t=t.set(r.concat("blockedParticipantsCount"),s+1)).has(i)){var o=t.get(i);if(!o.some((function(t){return t.id===n}))){var a=t.get(["contacts",n]),c=o.length;t=t.set(i.concat(c),a)}}}else t=t.assign(r,{blockedParticipantsCount:1,blockedParticipants:{items:[n]}});t=Dn(t=Un(t,r,n),r,n)}return t}(t,e.chatId,e.userId);case Cn:return function(t,e,n){var r=ee(t,e);if(r){var s=r.concat(["blockedParticipants","items"]),i=t.get(r.concat("blockedParticipantsCount"));if(1===i)t=t.assign(r,{blockedParticipantsCount:0,blockedParticipants:{items:[]}});else if((t=t.set(r.concat("blockedParticipantsCount"),i-1)).has(s)){var o=t.get(s).findIndex((function(t){return t.id===n}));t=t.delete(s.concat([o]))}t=Nn(t,r,[n])}return t}(t,e.chatId,e.userId);case Mn:return function(t,e,n,r){var i=ee(t,e);if(i){var o=i.concat("admins"),a=t.get(o),c=new s(a.map((function(t,e){return[rt(t.user),e]}))),u=0;n.forEach((function(e){c.has(e)?t=t.assign(o.concat(c.get(e)),{permissions:r}):(t=t.set(o.concat(a.length+u),{user:e,inviter:t.get("auth.profile.id"),permissions:r}),u++)})),t=Nn(t,i,n)}return t}(t,e.chatId,e.userIds,e.permissions);case bn:return function(t,e,n){var r=ee(t,e);r&&(t=Un(t,r,n));return t}(t,e.chatId,e.userId);case Tn:return function(t,e,n,r){var s=ee(t,e);s&&t.has(s)&&(t=t.set(s.concat(n,"loadState"),r));return t}(t,e.chatId,e.branch,e.loadState);case On:return function(t,e,n,r,s){var o=ee(t,e);if(o&&r){var a=o.concat(n),c=t.get(a),u=c&&c.items?c.items:[],d=new i(u.map((function(t){return t.id}))),h=t.get("auth.profile.id");r.forEach((function(t){var e=t.contact.id;d.has(e)||u.push(v(v({},t.contact),{name:t.contact.names[0].name,presence:t.presence,current:t.contact.id===h}))})),t=t.assign(a,{loadState:"idle",marker:s,items:u})}return t}(t,e.chatId,e.branch,e.members,e.marker);case An:return function(t,e){var n=ee(t,e);n&&(t=t.delete(n.concat("blockedParticipants")).delete(n.concat("members")));return t}(t,e.chatId)}return t},function(t,e){var n=Wr(e);return n?e.key?Jr(t,e.key,n):function(t,e,n,r){return function(t,e,n){var r=[];return de(t,e).forEach((function(e){var s=t.get(e.primary);s.attaches&&s.attaches.forEach((function(t,s){t.file===n&&(r.push(e.primary.concat("attaches",s)),e.secondary&&r.push(e.secondary.concat("attaches",s)))}))})),r}(t,e,n).forEach((function(e){return t=Jr(t,e,r)})),t}(t,e.chatId,e.file,n):t},function(t,e){switch(e.type){case I:return function(t){var e=t.get("auth.state");(!e||"verify"===e&&t.get("auth.verification.nextAttempt")<Date.now())&&(t=kn(t));var n=t.get("auth.profile");n&&(t=In(t,n));return t}(t);case $e:return yn(t,e.state);case Ze:return _n(t,e.error,e.resetLoadState);case tn:return function(t,e){"string"==typeof e&&(e={state:e});return t.set("auth.okProfile",e)}(t,e.data);case en:return function(t,e){return e?t.assign("auth",{state:"verify",verification:v(v({},e),{nextAttempt:Date.now()+1e3*e.codeDelay})}):t.delete("auth.verification")}(t,e.data);case vn:return function(t,e){return e?t.assign("auth",{state:"verify",verificationInfo:e}):t.delete("auth.verificationInfo")}(t,e.data);case an:return function(t,e){return t.assign("auth",{tokens:e})}(t,e.tokens);case sn:return function(t,e){return In(t,e).set("auth.state","confirm")}(t,e.profile);case on:return function(t,e){return t.assign("auth",{token:e})}(t,e.token);case dn:return kn(t,e.state||"unauthorized");case cn:return function(t,e,n){if(!e)throw new Error("Отсутствует профиль пользователя");return t=In(t,e),t=_n(t,null),t.assign("auth",{state:"authorized",verification:null,token:n})}(t,e.profile,e.token);case"Logout":case un:return function(t){var e=t.get("auth");return t.set("assets",{}).set("chats",new s).set("contacts",new s).set("config",{}).set("auth",{loadState:mn.idle,state:"unauthorized",phone:e.phone,okProfile:e.okProfile})}(t);case nn:return function(t,e){return t.assign("auth",{location:e})}(t,e.location);case rn:return function(t,e){return t.set("auth.phone",e)}(t,e.phone);case hn:return function(t,e){return t.set("auth.recovery",e)}(t,e.data);case fn:return function(t){return t=_n(t,null),t.set("auth.state","create")}(t);case ln:return function(t,e){return t.set("auth.profile.linkStatus",e)}(t,e.data);case pn:return function(t,e){return t.set("auth.sessions.loadState",e)}(t,e.state);case gn:return function(t,e){return t.set("auth.sessions",{loadState:mn.idle,items:e})}(t,e.sessions)}return t},function(t,n){switch(n.type){case Qi:return io(t,n.key,n.data);case $i:return function(t,n,r){var s=t.get(n);if(!s)return t;var i=r.result?(s.result||[]).concat(r.result):s.result;return io(t,n,{result:i,total:"total"in r?r.total:s.total,marker:"marker"in r?r.marker:void 0,loadState:e.LoadState.idle})}(t,n.key,n.data);case un:return oo(t,["search"]);case eo:return io(t,n.key,{loadState:e.LoadState.idle});case to:return io(t,n.key,{loadState:e.LoadState.loading});case Zi:case nr:case lr:case pr:return oo(t,n.key);case no:var r=ee(t,n.chatId);return r?oo(t,r.concat(["search"])):t}return t},function(t,e){switch(e.type){case I:return function(t){var e=t.get(bo),n=t.get("stickerSets");e instanceof s||(t.set(bo,new s),Array.isArray(e)&&e.forEach((function(e){return t.set([bo,e.id],e)})));n instanceof s||t.set("stickerSets",new s);return t}(t);case ao:return function(t,e,n){void 0===n&&(n=[]);var r=t.get("assets.stickerSectionsOrder")||[];return e.forEach((function(e,n){"RECENT"===n&&"recentEmojiList"in e&&(e.recentEmojiList=Lo(t,e.recentEmojiList)),t=t.set(["assets","stickerSections",n],e)})),t.set(["assets","stickerSectionsOrder"],_(n,r).filter(nt))}(t,e.sections,e.sectionsOrder);case co:return Ro(t,e.stickers);case uo:return function(t,e,n){var r="assets.stickerSuggestions",i=t.get(r);if(!i||!i.has(e)||i.get(e).size<n.size){var o=new s(i);o.set(e,n),t.set(r,o)}return t}(t,e.query,e.suggestion);case ho:return function(t,e){var n=t.get("assets.stickerSections.RECENT.recentEmojiList")||[],r=function(t,e){void 0===e&&(e=function(t){return t});var n=new i;return t.filter((function(t){var r=e(t);if(!n.has(r))return n.add(r),!0}))}(Lo(t,e).concat(n),(function(t){switch(t.type){case"ANIMOJI":return t.id;case"EMOJI":return t.value;default:return t}}));if(!ot(r,n,(function(t){return"EMOJI"===t.type?t.value:t.id})))return t.set("assets.stickerSections.RECENT.recentEmojiList",r.slice(0,To));return t}(t,e.emoji);case fo:return function(t,e){var n=t.get("assets.stickerSections.RECENT.result")||[],r=[e].concat(n.filter((function(t){return t.id!==e})));return t.set("assets.stickerSections.RECENT.result",r.slice(0,Oo))}(t,e.stickerId);case lo:return function(t,e){var n=t.get("assets.stickerSections.RECENT.result")||[],r=e.map((function(t){return t.id})),s=_(e).concat(n.filter((function(t){return!r.includes(t.id)})));return t.set("assets.stickerSections.RECENT.result",s.slice(0,Oo))}(t,e.recents);case po:return function(t,e){Ro(t,e);var n=e.map((function(t){return t.id})),r=n.length>0?n[n.length-1]:null,s=t.get(So+".result")||[];return t.set(So,{result:s.concat(n),marker:r})}(t,e.stickers);case mo:return function(t,e){return e.forEach((function(e){return t.set(["stickerSets",e.id],v(v({},e),{result:e.stickers}))})),t}(t,e.sets);case yo:return function(t,e,n){var r="FAVORITE_STICKER"===e?Co+".stickers":wo+".stickerSets",s="FAVORITE_STICKER"===e?Co+".result":wo+".result",i=_([n],t.get(r)||[]),o=_([n],t.get(s)||[]);return t=t.set(r,i),t.set(s,o)}(t,e.assetType,e.id);case _o:return function(t,e,n,r){var s="FAVORITE_STICKER"===e?Co+".stickers":wo+".stickerSets",i="FAVORITE_STICKER"===e?Co+".result":wo+".result",o=t.get(s),a=o.indexOf(n),c=Po(o,r,a),u=Po(t.get(i),r,a);return t=t.set(s,c),t.set(i,u)}(t,e.assetType,e.id,e.position);case Io:return function(t,e,n){switch(e){case"FAVORITE_STICKER":!function(t,e){var n,r,s=t.get(Co),i=null===(n=s.result)||void 0===n?void 0:n.filter((function(t){return!e.includes(t.id)})),o=null===(r=s.stickers)||void 0===r?void 0:r.filter((function(t){return!e.includes(t)})),a=s.totalCount-1,c=v(v({},s),{result:i,stickers:o,totalCount:a});t.set(Co,c)}(t,n);break;case"FAVORITE_STICKER_SET":!function(t,e){var n,r,s=t.get(wo),i=null===(n=s.result)||void 0===n?void 0:n.filter((function(t){return!e.includes(t.id)})),o=null===(r=s.stickerSets)||void 0===r?void 0:r.filter((function(t){return!e.includes(t)})),a=s.totalCount-1,c=v(v({},s),{result:i,stickerSets:o,totalCount:a});t.set(wo,c)}(t,n);break;case"RECENT":!function(t,e){var n,r,s=t.get(Mo),i=null===(n=s.result)||void 0===n?void 0:n.filter((function(t){return t.photoId?!e.includes(t.photoId):!e.includes(t.id)})),o=null===(r=s.recentsList)||void 0===r?void 0:r.filter((function(t){return!e.includes(t.id)})),a=v(v({},s),{result:i,recentsList:o});t.set(Mo,a)}(t,n)}return t}(t,e.assetType,e.ids);case go:return function(t,e){return t.assign("assets.loadState",e)}(t,e.data);case vo:return function(t,e,n){var r="STICKER"===e?"recentSync":"favoritesSync";return t.assign(["assets",r],n)}(t,e.syncType,e.sync);case ko:return function(t){return t=t.delete(Mo+".recentsList"),t.delete(Mo+".result")}(t);case Eo:return function(t){return t=t.delete(Co+".stickers"),t.delete(Co+".result")}(t)}return t},function(t,n){switch(n.type){case Do:return function(t,e){var n,r=e.chatId,s=e.messageId,i=e.counters,o=e.totalCount,a=e.reactions,c=Vo(t,r,s,!1);if(null==c)return t;if(!a){var u=Ho(t,r,s);if(u){a={totalCount:o,counters:i};var d=null===(n=u.reactionInfo)||void 0===n?void 0:n.yourReaction;d&&(a.yourReaction=d)}}a&&(t=Fo(t,r,s,c,a));return t}(t,n);case qo:return function(t,e){var n=e.chatId,r=e.messagesReactions;return Object.entries(r).forEach((function(e){var r=e[0],s=e[1],i=Vo(t,n,r,!1);i&&s&&(t=Fo(t,n,r,i,s))})),t}(t,n);case Uo:return function(t,n){var r,s,i=n.chatId,o=n.messageId,a=n.reaction,c=n.reactions,u=n.reactionInfo;n.yourReaction;var d=n.resetInconsistency,h=n.marker,f=void 0===h?0:h,l=Vo(t,i,o,!0);if(null==l)return t;var p=t.get(l);if(!d&&(null===(r=p)||void 0===r?void 0:r.filter)){var g=a||No;if(null===(s=p.filter[g])||void 0===s?void 0:s.inconsistent)return t}var v=Bo({current:p,reaction:a,loadState:e.LoadState.idle,reactions:c,marker:f,reactionInfo:u,resetInconsistency:d});return t.set(l,v)}(t,n);case xo:return function(t,e){var n=e.chatId,r=e.lastReactedMessageId,s=e.lastReaction,i=ee(t,n);if(i){var o=r?String(r):r;t=(t=t.set(i.concat("lastReactedMessageId"),o)).set(i.concat("lastReaction"),s)}return t}(t,n);case jo:return function(t,e){var n=e.chatId,r=e.messageId,s=e.reaction,i=e.loadState,o=Vo(t,n,r,!0);if(null==o)return t;var a=Bo({current:t.get(o),reaction:s,loadState:i});return t.set(o,a)}(t,n)}return t},function(t,e){switch(e.type){case Ti:return function(t,e){return t.set(["download",e],{id:e,status:Di.loading})}(t,e.fileId);case Oi:return function(t,e,n){return t.assign(["download",e],{id:e,url:n})}(t,e.fileId,e.url);case Ai:return function(t,e,n,r){return t.assign(["download",e],{status:Di.loading,progress:{loaded:n,total:r}})}(t,e.fileId,e.loaded,e.total);case Ri:return Ui(t,e.fileId,e.file);case Pi:return function(t,e){var n=["download",e];return t=t.set(n,e),t.delete(n)}(t,e.fileId);case Li:return function(t,e,n){return t.assign(["download",e],{status:Di.error,error:n})}(t,e.fileId,e.error);case Ni:return function(t,e){return t.get("download").forEach((function(n,r){n.id!==e&&n.url!==e&&n.localUrl!==e||(t=t.set(["download",r,"hasLocal"],!0))})),t}(t,e.key);case rr:return function(t,e,n){var r=ue(t,e,n.cid),s=r&&t.get(ue(t,e,n.cid));s&&s.attaches&&s.attaches.forEach((function(e){"FILE"===e._type&&e.file instanceof File&&(t=Ui(t,e.token,e.file))}));return t}(t,e.chatId,e.message)}return t},function(t,e){switch(e.type){case I:return function(t){var e=t.get("contacts");if(Array.isArray(e)){var n=new s;e.forEach((function(t){"number"==typeof t?n.set(t,Qe(t)):n.set(t.id,ze(t))})),t=t.set("contacts",n)}return t}(t);case T:return function(t,e,n,r){Ve(t,e,!0),n&&Be(t,n);r&&Je(t,r);return t}(t,e.contacts,e.presence,e.contactStubs);case ke:return function(t){if(t.get("newContact"))return t;return t.set("newContact",{firstName:null,lastName:null,phone:null})}(t);case Ee:return function(t){return t.set("newContact",null)}(t);case Se:return function(t,e){var n=e.contact&&ze(e.contact);return t.assign("newContact",v(v({},e),{contact:n}))}(t,e.data);case we:return function(t,e){return Ge(t,e,!0),We(t,[e.id]),t}(t,e.contact);case Ce:return Ve(t,e.list);case Me:return Ke(t,e.userId,e.presence);case be:return Be(t,e.presence);case Te:return function(t,e){return t.assign(["contacts",e],{status:"REMOVED",own:!1})}(t,e.contactId);case Oe:return function(t,e){return t.assign(["contacts",e],{status:"BLOCKED"})}(t,e.contactId);case Ae:return function(t,e){return t.assign(["contacts",e],{status:null})}(t,e.contactId);case Re:return function(t,e){var n=e.reduce((function(t,e){return t.set(e.id,ze(e))}),new s);return t.set("blackList",n),t}(t,e.contacts);case Pe:return function(t,e,n,r,s){var i=s?[]:t.get(["contacts",e,"photos","urls"])||[],o=i.concat(n.reduce((function(t,e){return-1===i.findIndex((function(t){return t.url===e.url}))&&t.push(e),t}),[]));o.length||r||(t=(t=(t=t.delete(["contacts",e,"photoId"])).delete(["contacts",e,"avatarUrl"])).delete(["contacts",e,"fullAvatarUrl"]));return t.set(["contacts",e,"photos"],{urls:o,total:r})}(t,e.contactId,e.urls,e.total,e.replace);case Le:return function(t,e){return t.delete(["contacts",e,"photos"])}(t,e.contactId);case Ne:return function(t,e,n){return t.set(["contacts",e,"error"],n)}(t,e.contactId,e.error);case De:return Je(t,e.contactIds)}return t},function(t,e){switch(e.type){case Wi:return function(t,e){return t.set([Xi,"leftColAdditional"],e)}(t,e.data);case zi:return function(t,e){return t.set([Xi,"onboardingAdditional"],v({requested:!0},e))}(t,e.data);case Ji:return function(t,e){return t.set([Xi,"userSmiles"],e)}(t,e.data);case Yi:return function(t,e){var n=t.get([Xi,"chatAdditional","helloStickers"]);return t.set([Xi,"chatAdditional","helloStickers"],v(v({},n),e))}(t,e.data)}return t},function(t,e){switch(e.type){case I:return function(t){var e=t.get("groups");e instanceof s||t.set("groups",e.reduce((function(t,e){return t.set(e.id,Bi(e))}),new s));return t}(t);case T:return Gi(t,e.groups||[]);case xi:return Ki(t,e.group);case ji:return Gi(t,e.list);case qi:return function(t,e){return t.assign(["groups",e],{status:"REMOVED",own:!1})}(t,e.groupId);case Fi:return function(t,e,n){var r=["groups",e,"error"];return t.set(r,n)}(t,e.groupId,e.error);case Hi:return function(t,e){Array.isArray(e)&&(t=t.set("moderatedGroups.groups",e));return t}(t,e.list);case Vi:return function(t,e){return t=t.set("moderatedGroups.counters",e),t}(t,e.data)}return t},function(t,e){switch(e.type){case"ChatMedia.SetLoadState":return function(t,e,n,r){var s=ee(t,e);s&&t.set(s.concat("media",n,"loadState"),r);return t}(t,e.chatId,e.sectionId,e.loadState);case"ChatMedia.SelectSection":return function(t,e,n){var r,s,i=ee(t,e);if(i){var o;null===(r=te(t,i).media)||void 0===r||r.forEach((function(t){t.selected&&(o=t)})),o&&(null===(s=o)||void 0===s?void 0:s.id)===n||(o&&t.set(i.concat("media",o.id,"selected"),!1),t.set(i.concat("media",n,"selected"),!0))}return t}(t,e.chatId,e.sectionId);case"ChatMedia.AddToList":return function(t,e,n,r,i){var o,a=ee(t,e);if(a){var c=te(t,e),u=null===(o=c.media)||void 0===o?void 0:o.get(n);if(u){var d=u.items,h=function(t,e,n,r){var s=[],i=bt[e],o=n.messages.slice();if(r.messageId&&r.forward&&r.backward&&!o.some((function(t){return t.id===r.messageId}))){console.warn("Отсутствует опорное сообщение %s в списке медиа",r.messageId);var a=ie(t,r.messageId);a&&o.push(a)}return o.sort((function(t,e){return t.time-e.time})).forEach((function(e){return Nt(t.id,e,i,s)})),s}(c,n,r,i).reverse(),f=_(h),l=h.length?Ft(d,h[0].messageId):[-1,-1],p=h.length?Ft(d,h[h.length-1].messageId):[-1,-1],g=-1!==l[0],v=-1!==p[1];if(i.messageId){var m=Ft(d,i.messageId);if(i.backward&&i.forward){if(-1===m[0])return console.warn("Отсутствует опорный медиа-элемент %d в списке",i.messageId),t;var y=function(t,e,n){var r=n.length,s=e[0],i=Kt(e),o=0,a=r;for(;o<r;){if(!Ht(c=n[o])&&(c.messageId===s.messageId||c.time<s.time))break;o++}for(;a>0;){var c;if(!Ht(c=n[a-1])&&(c.messageId===i.messageId||c.time>i.time))break;a--}return[o,a]}(0,h,d),I=y[0],k=y[1];I=Math.min(I,m[0]),k=Math.max(k,m[1]),!g&&Vt(d,I-1)&&f.unshift({id:"delimiter"}),!v&&Vt(d,k)&&f.push({id:"delimiter"}),d=d.slice(0,I).concat(f,d.slice(k))}else if(i.backward){if(-1!==(I=m[1]))if(h.length){k=void 0;v?k=p[1]:Vt(d,k=zt(c,d,Kt(h).time))&&f.push({id:"delimiter"}),d=d.slice(0,I).concat(f,d.slice(k))}else d=Gt(d,m[1]+1);else console.warn("Не удалось найти опорный элемент для запроса",i)}else if(i.forward){if(-1!==(k=m[0]))if(h.length){I=void 0;g?I=l[0]:Vt(d,(I=Wt(c,d,h[0].time))-1)&&f.unshift({id:"delimiter"}),d=d.slice(0,I).concat(f,d.slice(k))}else d=Gt(d,m[0]-1);else console.warn("Не удалось найти опорный элемент для запроса",i)}}else if(i.forward){var E=function(t,e,n){var r=e[0],s=function(t){for(var e=t.length-1;e>=0;e--)if(!Ht(t[e]))return t[e]}(n);if(!r||!s)return n;if(s.time>r.time)return n;var i=Ft(n,r.messageId);if(-1!==i[0])return 0===i[0]?_([{id:"delimiter"}],e):_(n.slice(0,i[0]),e);var o=Wt(t,n,r.time);o<=0&&(n=[]);if(Vt(n,o-1))return _(n.slice(0,o),[{id:"delimiter"}],e);return _(n.slice(0,o),e)}(c,h,d);E!==d?d=E:(Vt(d,d.length-1)&&f.unshift({id:"delimiter"}),d=g?d.slice(0,l[0]).concat(f):d.concat(f))}else if(i.backward){E=function(t,e,n){var r=Kt(e),s=function(t){for(var e=0;e<t.length;e++)if(!Ht(t[e]))return t[e]}(n);if(!s||!r)return n;if(r.time>s.time)return n;var i=Ft(n,r.messageId);if(-1!==i[1])return i[1]===n.length?_(e,[{id:"delimiter"}]):_(e,n.slice(i[1]));var o=zt(t,n,r.time);if(Vt(n,o))return _(e,[{id:"delimiter"}],n.slice(o));return _(e,n.slice(o))}(c,h,d);E!==d?d=E:(Vt(d,0)&&f.push({id:"delimiter"}),d=v?f.concat(d.slice(p[1])):f.concat(d))}d!==u.items&&(c.media=new s(c.media),c.media.set(u.id,Jt(u,d,r)))}t.set(a,c)}return t}(t,e.chatId,e.sectionId,e.resp,e.req);case"ChatMedia.SelectItem":return Rt(t,e.chatId,e.sectionId,e.ptr);case"ChatMedia.ClearSelectedItem":return Rt(t,e.chatId,e.sectionId,-1);case"ChatMedia.ResetSection":return function(t,e,n){var r=ee(t,e);if(r)return t.assign(r.concat("media",n),v({items:[],total:-1,count:0},jt(-1,-1,-1)));return t}(t,e.chatId,e.sectionId);case"ChatMedia.UpdateMessage":return Tt(t,e.chatId,e.message);case"ChatMedia.RemoveMessage":return At(t,e.chatId,e.messageId);case"ChatMedia.PrependMessage":return function(t,e,n){var r=ee(t,e);if(r){var i=te(t,r);if(!(n=Bt(i,n))||!Yt(n))return t;var o=qt(e,n),a=Object.keys(o),c=new s(i.media),u=!1;a.forEach((function(t){if(o[t].length){var e=c.get(t);c.set(t,Jt(e,_(o[t],e.items))),u=!0}})),u&&t.set(r.concat("media"),c)}return t}(t,e.chatId,e.message);case"ChatMedia.Uncensor":return function(t,e,n){var r=t.get(["whiteList",e])||[],s=_(r,[n]).filter(nt);return t.set(["whiteList",e],s)}(t,e.userId,e.mediaId);case"ChatMedia.RemoveFromWhiteList":return function(t,e){return t.delete(["whiteList",e])}(t,e.userId)}return t},function(t,e){switch(e.type){case Wo:!function(t,e){t.set("congrats.info",e)}(t,e.data);break;case Jo:!function(t,e){t.set("congrats",e)}(t,e.data);break;case Yo:!function(t,e){var n=t.get("congrats.list");t.assign(["congrats","list"],{list:n.list.concat(e.list),hasMore:e.hasMore,userIds:e.userIds})}(t,e.data);break;case Xo:!function(t,e){var n=t.get("congrats.list.list"),r=n.findIndex((function(t){return t.userId===e.userId}));-1!==r&&t.assign(["congrats","list","list",r],{list:n[r].list.concat(e.list),marker:e.marker})}(t,e.data);break;case Qo:!function(t,e){t.set("congrats.info.counter.processed",e.processed)}(t,e.data);break;case $o:!function(t,e){var n=t.get("congrats.list.list"),r=n.findIndex((function(t){return t.userId===e.userId}));-1!==r&&(t.set("congrats.info.counter.processed",e.processed),t.assign(["congrats","list"],{list:n.slice(0,r).concat(n.slice(r+1))}))}(t,e.data)}return t},function(t,e){switch(e.type){case I:!function(t){var e=t.get(sa),n=t.get(ia);e instanceof s||(t.set(sa,new s),ca(t,e));n instanceof s||t.set(ia,new s)}(t);case Zo:ca(t,e.animoji);case ta:!function(t,e){if(Array.isArray(e)){var n=new s(t.get(ia));e.forEach((function(t){return n.set(t.id,t)})),t.set(ia,n)}}(t,e.animojiSets);case ea:!function(t,e){Array.isArray(e)&&t.set(oa,e)}(t,e.animojiSections);case na:!function(t,e){t.assign(aa,e)}(t,e.sync)}return t}];function da(t,e){return ua.reduceRight((function(t,n){return n(t,e)}),t)}function ha(t){return{version:t.version,auth:(e=t.auth,{state:e.state,profile:e.profile&&la(e.profile),token:e.token}),chats:t.chatList.map(pa),chatList:t.chatList.map((function(t){return t.id})),chatMarker:t.chatMarker,selectedChat:t.selectedChat&&t.selectedChat.id,oldestChatLoaded:t.oldestChatLoaded,contacts:fa(t.contacts),groups:fa(t.groups),config:t.config,posting:t.posting&&Ia(t.posting),whiteList:t.whiteList};var e}function fa(t){var e=[];return t.forEach((function(t){return e.push(t.stub&&!t.own?t.id:la(t))})),e}function la(t){return ka(t,"id","updateTime","photoId","baseUrl","baseRawUrl","avatarUrl","fullAvatarUrl","names","profileUrl","phone","status","gender","bday","options","link","description","deleted","own","stub","presence")}function pa(t){return v(v({},ka(t,"id","type","status","participantsCount","created","joinTime","title","placeholder","baseIconUrl","baseRawIconUrl","iconUrl","fullIconUrl","lastEventTime","cid","newMessages","prevMessageId","subject","restrictions","access","link","description","admins","options","hidePinnedMessage","unreadReply","unreadPin","blockedParticipantsCount","participantsMarker","videoConversation","hasBots","isSuspended","modified","liveLocationMessageIds","groupChatInfo","lastMentionMessageId","lastMentionMessage","hideAlert","hideAlertImportant")),{owner:t.owner.id,newMessages:t.unreadCount,participants:_a(t),admins:t.admins&&t.admins.map(va),pinnedMessage:t.pinnedMessage&&ga(t.pinnedMessage),lastMessage:t.lastMessage&&ga(t.lastMessage),lastMentionMessage:t.lastMentionMessage&&ga(t.lastMentionMessage)})}function ga(t){return v(v({},ka(t,"id","time","type","updateTime","status","cid","text","zoom","ttl","viewTime","options","constructorId","liveUntil","elements")),{sender:t.sender&&t.sender.id,link:t.link&&{type:t.link.type,message:t.link.message&&ga(t.link.message)},options:ya(t),attaches:t.attaches&&t.attaches.map(ma)})}function va(t){return t.user.id}function ma(t){return(t=v({},t)).chatId=void 0,t.mediaId=void 0,t.user&&(t.user=void 0),t.users&&(t.users=void 0),t}function ya(t){return t.options?(t.options.hideEdit?1:0)|(t.options.isLive?2:0):0}function _a(t){for(var e={},n=0;n<t.participants.length;n++){var r=t.participants[n];e[r.user.id]=r.time}return e}function Ia(t){var e={};return t.forEach((function(t){(function(t){if(t&&(t.text||t.urls||t.shares))return!1;return!0})(t)||(e[t.chatId]=function(t){return v(v({},ka(t,"id","chatId","type","link","text","urls","shares","notifyDisabled","updated","messageElements")),{link:_s(t.link)?ga(t.link):void 0})}(t))})),e}function ka(t){for(var e=arguments,n=[],r=1;r<arguments.length;r++)n[r-1]=e[r];for(var s={},i=0;i<n.length;i++){var o=n[i];o in t&&(s[o]=t[o])}return s}var Ea=function(){function t(t,e){this._api=t,this._refType=e}return t.prototype.save=function(t){throw Error("not implemented")},t.prototype.fetch=function(t){var e=this;return this.load(t).then((function(t){return e.save(t),t}))},t.prototype.load=function(t){var e=this,n=pt(t,100).map((function(t){return e._api.request(32,{contactIds:t,contactType:e._refType})}));return Promise.all(n).then((function(t){return t.reduce((function(t,e){return t.concat(e.contacts)}),[])}))},t}(),Sa=function(t){function e(e,n){var r=t.call(this,n,"USER")||this;return r._store=e,r._api.on(131,(function(t){var e=Ca(t.contact);r._store.dispatch({type:we,contact:e})})),r._api.on(132,(function(t){r._store.dispatch(v({type:Me},t))})),r}return g(e,t),Object.defineProperty(e.prototype,"currentUser",{get:function(){return this._store.getState().auth.profile},enumerable:!0,configurable:!0}),e.prototype.getName=function(t){if("number"==typeof t&&(t=this.get(t)),t)return wa(t)},e.prototype.save=function(t){this._store.dispatch({type:Ce,list:t})},e.prototype.load=function(e){return t.prototype.load.call(this,e).then((function(t){var n=new i(t.map((function(t){return t.id})));return e.forEach((function(e){var r=Number(e);n.has(r)||(n.add(r),t.push({id:r,gender:0,options:[],updateTime:Date.now(),names:[{type:"DELETED",name:"#"+r}],deleted:!0}))})),t}))},e.prototype.fetchMissing=function(t){var e=this,n=t.filter((function(t){return function(t,e){var n=t.getState().contacts.get(e);return!n||!!n.stub}(e._store,t)})).filter(nt);return n.length?this.fetch(n):Promise.resolve([])},e.prototype.update=function(t,e,n){var r=this;return this._api.request(34,{contactId:t,action:e,name:n}).then((function(n){if(n.contact)r._store.dispatch({type:we,contact:Ca(n.contact)});else switch(e){case"REMOVE":r._store.dispatch({type:Te,contactId:t});break;case"BLOCK":r._store.dispatch({type:Oe,contactId:t});break;case"UNBLOCK":r._store.dispatch({type:Ae,contactId:t})}}))},e.prototype.search=function(t){var e=this;return this._api.request(44,t).then((function(t){if(t.contacts){var n=t.contacts.filter((function(t){return e.get(t.id)||(t.stub=!0),t.stub}));n.length&&e.save(n),t.contacts=t.contacts.map((function(t){return e.get(t.id)}))}return t}))},e.prototype.addContact=function(t){return this.update(t,"ADD")},e.prototype.removeContact=function(t){return this.update(t,"REMOVE")},e.prototype.newContactEnter=function(){this._store.dispatch({type:ke})},e.prototype.newContactExit=function(){this._store.dispatch({type:Ee})},e.prototype.newContactSubmit=function(t){var e=this;return this._store.dispatch({type:Se,data:v(v({},t),{loadState:xe,error:null})}),t.phone?this._api.request(41,t).then((function(t){var n=Ca(t.contact,!0);t.new&&e._store.dispatch({type:we,contact:n}),e._store.dispatch({type:Se,data:v({loadState:Ue},t)})})).catch((function(t){return e.newContactError(t.code)})):this.newContactError("error.invalid-phone")},e.prototype.newContactError=function(t){return this._store.dispatch({type:Se,data:{loadState:Ue,error:t}}),Promise.reject(t)},e.prototype.updatePresence=function(t){var e=this,n=pt(t,200).map((function(t){return e._api.request(35,{contactIds:t})}));return Promise.all(n).then((function(t){var n=t.reduce((function(t,e){return v(v({},t),e.presence)}),{});return e._store.dispatch({type:be,presence:n}),n}))},e.prototype.loadPhotos=function(t){var e=this.get(t),n=e.photos;if(!n||!n.urls){var r=[];return(e.photoId||e.avatarUrl)&&r.push(function(t){return{url:t.fullAvatarUrl,id:t.photoId}}(e)),this._store.dispatch({type:Pe,contactId:t,urls:r,total:r.length}),this._loadPhotos(t)}var s=n.urls&&n.urls.length;return s===n.total?Promise.resolve():this._loadPhotos(t,s-1)},e.prototype.get=function(t){var e=this._store.getState().contacts.get(t);if(e&&!e.stub)return e},e.prototype.fillStubs=function(t){this._store.dispatch({type:De,contactIds:t})},e.prototype.getChatPlaceholder=function(t){return ge(this._store.immutable,t)},e.prototype.clearPhotos=function(t){this._store.dispatch({type:Le,contactId:t})},e.prototype.blockUser=function(t){var e=this;return this.update(t,"BLOCK").then((function(){return e.fetchBlackList()}))},e.prototype.unblockUser=function(t){var e=this;return this.update(t,"UNBLOCK").then((function(){return e.fetchBlackList()}))},e.prototype.fetchBlackList=function(){var t=this;return this._api.request(36,{status:"BLOCKED"}).then((function(e){return t._store.dispatch({type:Re,contacts:e.contacts}),e.contacts}))},e.prototype._loadPhotos=function(t,e){var n=this;return void 0===e&&(e=0),this._api.request(39,{contactId:t,from:e}).then((function(e){var r=e.urls.map((function(t,n){return{url:t,id:e.ids&&e.ids[n]}}));n._store.dispatch({type:Pe,contactId:t,urls:r,total:e.total+1})})).catch((function(t){return"privacy.restricted"!==t.code?Promise.reject(t):Promise.resolve(t)}))},e}(Ea);function wa(t){return t.names.length?(t.names.find((function(t){return"CUSTOM"===t.type}))||t.names[0]).name:"name"in t?t.name:void 0}function Ca(t,e){return t.own=null!=e?e:"REMOVED"!==t.status,t}var Ma=function(t,e){return t(e={exports:{}},e.exports),e.exports}((function(t){var e=Object.prototype.hasOwnProperty,n="~";function r(){}function s(t,e,n){this.fn=t,this.context=e,this.once=n||!1}function i(t,e,r,i,o){if("function"!=typeof r)throw new TypeError("The listener must be a function");var a=new s(r,i||t,o),c=n?n+e:e;return t._events[c]?t._events[c].fn?t._events[c]=[t._events[c],a]:t._events[c].push(a):(t._events[c]=a,t._eventsCount++),t}function o(t,e){0==--t._eventsCount?t._events=new r:delete t._events[e]}function a(){this._events=new r,this._eventsCount=0}Object.create&&(r.prototype=Object.create(null),(new r).__proto__||(n=!1)),a.prototype.eventNames=function(){var t,r,s=[];if(0===this._eventsCount)return s;for(r in t=this._events)e.call(t,r)&&s.push(n?r.slice(1):r);return Object.getOwnPropertySymbols?s.concat(Object.getOwnPropertySymbols(t)):s},a.prototype.listeners=function(t){var e=n?n+t:t,r=this._events[e];if(!r)return[];if(r.fn)return[r.fn];for(var s=0,i=r.length,o=new Array(i);s<i;s++)o[s]=r[s].fn;return o},a.prototype.listenerCount=function(t){var e=n?n+t:t,r=this._events[e];return r?r.fn?1:r.length:0},a.prototype.emit=function(t,e,r,s,i,o){var a=arguments,c=n?n+t:t;if(!this._events[c])return!1;var u,d,h=this._events[c],f=arguments.length;if(h.fn){switch(h.once&&this.removeListener(t,h.fn,void 0,!0),f){case 1:return h.fn.call(h.context),!0;case 2:return h.fn.call(h.context,e),!0;case 3:return h.fn.call(h.context,e,r),!0;case 4:return h.fn.call(h.context,e,r,s),!0;case 5:return h.fn.call(h.context,e,r,s,i),!0;case 6:return h.fn.call(h.context,e,r,s,i,o),!0}for(d=1,u=new Array(f-1);d<f;d++)u[d-1]=a[d];h.fn.apply(h.context,u)}else{var l,p=h.length;for(d=0;d<p;d++)switch(h[d].once&&this.removeListener(t,h[d].fn,void 0,!0),f){case 1:h[d].fn.call(h[d].context);break;case 2:h[d].fn.call(h[d].context,e);break;case 3:h[d].fn.call(h[d].context,e,r);break;case 4:h[d].fn.call(h[d].context,e,r,s);break;default:if(!u)for(l=1,u=new Array(f-1);l<f;l++)u[l-1]=a[l];h[d].fn.apply(h[d].context,u)}}return!0},a.prototype.on=function(t,e,n){return i(this,t,e,n,!1)},a.prototype.once=function(t,e,n){return i(this,t,e,n,!0)},a.prototype.removeListener=function(t,e,r,s){var i=n?n+t:t;if(!this._events[i])return this;if(!e)return o(this,i),this;var a=this._events[i];if(a.fn)a.fn!==e||s&&!a.once||r&&a.context!==r||o(this,i);else{for(var c=0,u=[],d=a.length;c<d;c++)(a[c].fn!==e||s&&!a[c].once||r&&a[c].context!==r)&&u.push(a[c]);u.length?this._events[i]=1===u.length?u[0]:u:o(this,i)}return this},a.prototype.removeAllListeners=function(t){var e;return t?(e=n?n+t:t,this._events[e]&&o(this,e)):(this._events=new r,this._eventsCount=0),this},a.prototype.off=a.prototype.removeListener,a.prototype.addListener=a.prototype.on,a.prefixed=n,a.EventEmitter=a,t.exports=a})),ba=function(t){function e(e,n){var r=t.call(this)||this;return r._store=e,r._api=n,r}return g(e,t),e.prototype.issueUrl=function(t){switch(this.emit("issue-url",t),t){case"PROFILE":return this._requestPhotoUrl(!0);case"PHOTO":return this._requestPhotoUrl(!1);case"VIDEO":case"AUDIO":return this._requestMediaUrl(t);case"FILE":return this._requestFileUrl();case"STICKER":return this._requestStickerUrl()}throw new Error("Неизвестный тип ресурса: "+t)},e.prototype.upload=function(t,e,n){var r=this;return new Promise((function(s,i){r.emit("upload-start",e);var o=location.protocol||"https:";t=t.replace(/^http:/,o);var a=r._store.getState();if(a.config&&a.config.server.proxy){var c=a.config.server.proxy;t=o+"//"+c+"/__proxy_host/"+t.replace(/^https:\/\//,"")}var u=new XMLHttpRequest;if("function"==typeof u.overrideMimeType&&u.overrideMimeType("application/json"),u.open("POST",t,!0),u.upload&&n){var d=!1;u.upload.onprogress=function(t){d||!1!==n(t.loaded,t.total)||(r.emit("upload-abort",e),d=!0,u.abort(),i(at()))}}u.onload=function(){var t=null;try{t=u.responseText?JSON.parse(u.responseText):null}catch(t){}if(t&&t.error_code){var n=new Error(t.error_data||"Empty response");n.code=t.error_code,r.emit("upload-error",n,e),i(n)}else r.emit("upload-complete",e),s(t)},u.onerror=function(t){r.emit("upload-error",new Error("Unknown upload error"),e),i(t)};var h=new FormData;h.append("file",e,e.name),u.send(h)}))},e.prototype.uploadWithReties=function(t,e,n,r){var s=this;return void 0===n&&(n=5),this.upload(t,e,r).catch((function(i){if(ct(i)||n<=0)throw i;return(o=3e3,"undefined"!=typeof navigator&&!1===navigator.onLine?new Promise((function(t){var e=function(){window.removeEventListener("online",e),t()};window.addEventListener("online",e)})):st(o)).then((function(){return s.emit("upload-retry",n,e),s.uploadWithReties(t,e,n-1,r)}));var o}))},e.prototype._requestPhotoUrl=function(t){return void 0===t&&(t=!1),this._api.request(80,{count:1,profile:t})},e.prototype._requestMediaUrl=function(t){return this._api.request(82,{count:1,audio:"AUDIO"===t}).then((function(t){return t.info[0]}))},e.prototype._requestFileUrl=function(){return this._api.request(87,{count:1}).then((function(t){return t.info[0]}))},e.prototype._requestStickerUrl=function(){return this._api.request(81).then((function(t){return{url:t.url}}))},e}(Ma);function Ta(t,e){var n=new i,r=new i,s={},o={};return t.forEach((function(t){t.groupChatInfo&&r.add(t.groupChatInfo.groupId);var i=function(t){if(Array.isArray(t.participants))return t.participants.map((function(t){return t.user.id}));return Object.keys(t.participants).map(Number)}(t);if(Na(n,i),t.title||Da(s,t.id,i.slice(0,4)),null!=t.owner){var a=[Ua(t.owner)];Na(n,a),Da(s,t.id,a)}if(t.admins&&Na(n,t.admins.map(Ua)),"DIALOG"===t.type&&Da(s,t.id,i),t.lastMessage){var c=t.lastMessage,u=c.sender,d=c.link,h=c.type,f=c.attaches;if(u){var l=Ua(u);"GROUP"===h?(r.add(l),Da(o,t.id,[l])):(n.add(l),Da(s,t.id,[l]))}if(d&&d.message&&d.message.sender&&n.add(Ua(d.message.sender)),f&&f.length){var p=f[0];null!=p.userId&&(n.add(p.userId),Da(s,t.id,[p.userId])),Array.isArray(p.userIds)&&(Na(n,p.userIds),Da(s,t.id,p.userIds))}}e&&t.messages&&Aa(t.messages,n,r)})),{contacts:n,groups:r,requiredContacts:s,requiredGroups:o}}function Oa(t,e,n){return void 0===e&&(e=new i),void 0===n&&(n=new i),t.attaches&&t.attaches.forEach((function(t){t.userId&&e.add(t.userId),t.contactId&&e.add(t.contactId),t.userIds&&Na(e,t.userIds)})),"GROUP"===t.type&&t.sender?n.add(Ua(t.sender)):t.sender&&e.add(Ua(t.sender)),t.link&&t.link.message&&Oa(t.link.message,e,n),{groups:n,contacts:e}}function Aa(t,e,n){return void 0===e&&(e=new i),void 0===n&&(n=new i),t.forEach((function(t){return Oa(t,e,n)})),{contacts:e,groups:n}}function Ra(t,e){var n=new i,r=new i,s=t.requiredContacts,o=t.requiredGroups;return Object.keys(s).forEach((function(t){return Na(n,s[t])})),Object.keys(o).forEach((function(t){return Na(r,o[t])})),Pa({contacts:n,groups:r},e)}function Pa(t,e){return Promise.all([e.contacts.fetchMissing(Array.from(t.contacts)),e.groups.fetchMissing(Array.from(t.groups))])}function La(t,e){var n=Array.isArray(t)?t:[t],r=Ta(n);return Ra(r,e).then((function(){return e.contacts.fillStubs(Array.from(r.contacts)),function(t,e){t.forEach((function(t){t.title||(t.placeholder=e.getChatPlaceholder(t))}))}(n,e.contacts),t}))}function Na(t,e){for(var n=0;n<e.length;n++)t.add(e[n]);return t}function Da(t,e,n){t[e]=t[e]?t[e].concat(n):n}function Ua(t){if("object"==typeof t){if("id"in t)return t.id;if("user"in t)return t.user.id}return Number(t)}function xa(t){return Array.isArray(t)?t.slice():t instanceof s?new s(t):t instanceof i?new i(t):t&&"object"==typeof t?"function"==typeof t.immutableClone?t.immutableClone():Object.assign({},t):t}function ja(t,e){return null!=t&&"object"==typeof t&&(t instanceof s||t instanceof i?t.has(e):e in t)}function qa(t,e){if(null!=t)return t instanceof s?t.get(e):t[e]}function Fa(t,e,n){if(null==t)return n;for(var r=0,s=e.length,i=void 0;r<s;r++){if(!ja(t,i=e.item(r)))return n;t=qa(t,i)}return t}function Ha(t,e,n){if(null!=t)return t instanceof s?t.set(e,n):t instanceof i?t.add(n):t[e]=n,t}function Va(t){if(t instanceof s)return Array.from(t.keys());if(Array.isArray(t)){if("function"==typeof t.keys)return Array.from(t.keys());for(var e=[],n=0,r=t.length;n<r;n++)e.push(n);return e}return t&&"object"==typeof t?Object.keys(t):[]}var Ga=function(t){t||(t=[]),this._hash=null,this._key=Array.isArray(t)?t:t.split("."),this.length=this._key.length};Ga.prototype.item=function(t){return t<0&&(t=this.length+t),this._key[t]},Ga.prototype.toString=function(){return null===this._hash&&(this._hash=this._key.join(".")),this._hash},Ga.prototype.valueOf=function(){return this._key},Ga.prototype.slice=function(t,e){return new this.constructor(this._key.slice(t,e))},Ga.prototype.concat=function(){for(var t=arguments,e=this._key.slice(),n=0,r=arguments.length,s=void 0;n<r;n++)(s=t[n])instanceof this.constructor?e=e.concat(s._key):Array.isArray(s)?e=e.concat(s):e.push(s);return new this.constructor(e)},Ga.prototype.push=function(t){var e=this._key.slice();return e.push(t),new this.constructor(e)},Ga.prototype.equal=function(t){return function(t,e){if(t.length!==e.length)return!1;for(var n=0,r=t.length;n<r;n++)if(t[n]!==e[n])return!1;return!0}(this._key,t._key)};var Ka=function(){this._nodes=null,this._keys=null,this._value=null,this.hasValue=!1,this.hasNodes=!1},Ba={value:{configurable:!0},empty:{configurable:!0},size:{configurable:!0}};Ba.value.set=function(t){this._value=t,this.hasValue=!0},Ba.value.get=function(){return this._value},Ba.empty.get=function(){return!this.hasValue&&!this.hasNodes},Ba.size.get=function(){return this._nodes?this._nodes.size:0},Ka.prototype.keys=function(){return this._keys},Ka.prototype.set=function(t,e){for(var n=this,r=0,s=t.length;r<s;r++)n=n.addNode(t.item(r));n.value=e},Ka.prototype.get=function(t,e){var n=this.find(t,e);return n&&n.value},Ka.prototype.delete=function(t,e){if(!t||!t.length)return!1;for(var n=this,r=0,s=t.length-1;r<s;r++)if(!(n=n.getNode(t.item(r))))return!1;var i=t.item(t.length-1),o=n.getNode(i);return!!o&&(o.clearValue(),o.hasNodes&&!e||n.deleteNode(i),!0)},Ka.prototype.clearValue=function(){this.value=null,this.hasValue=!1},Ka.prototype.find=function(t,e){for(var n=this,r=0,s=t.length;r<s;r++)if(!(n=n.getNode(t.item(r))||e&&n.getNode("*")))return null;return n},Ka.prototype.addNode=function(t){this._nodes||(this._nodes=new s,this._keys=[],this.hasNodes=!0);var e=this._nodes.get(t);return e||(e=new this.constructor,this._keys.push(t),this._nodes.set(t,e)),e},Ka.prototype.getNode=function(t){return this._nodes&&this._nodes.get(t)},Ka.prototype.deleteNode=function(t){if(this._nodes){var e=this._nodes.delete(t);if(e){var n=this._keys.indexOf(t);-1!==n&&this._keys.splice(n,1),this._nodes.size||(this._nodes=null,this._keys=null,this.hasNodes=!1)}return e}return!1},Ka.prototype.walk=function(t,e){"function"==typeof t&&(e=t,t=new Ga);for(var n,r,s,i,o=[{key:t,node:this}];n=o.pop();)if(n.node.hasNodes)for(var a=0,c=(r=n.node.keys()).length,u=void 0;a<c&&(u=r[a],s=n.key.push(u),!1!==e(i=n.node.getNode(u),s,u,n.node));a++)o.push({key:s,node:i})},Object.defineProperties(Ka.prototype,Ba);var za=function(){this._links=new Ka,this._depLinks=new Ka};function Wa(t){var e=[];return t.walk((function(t,n){t.value&&e.push(n)})),e}za.prototype.save=function(t,e){var n=this._depLinks.get(e);if(n&&!n.equal(t)){var r=this._links.get(n);r&&r.delete(e)}var s,i=this._links.find(t);i&&i.hasValue?s=i.value:(s=new Ka,this._links.set(t,s)),s.set(e,!0),this._depLinks.set(e,t)},za.prototype.getDeps=function(t){var e=this._links.find(t),n=[];return e&&(e.hasValue&&n.push([new Ga,Wa(e.value)]),e.walk((function(t,e){t.hasValue&&n.push([e,Wa(t.value)])}))),n},za.prototype.getOwnDeps=function(t){var e=this._links.find(t);return e&&e.hasValue?Wa(e.value):[]},za.prototype.reset=function(){this._links=new Ka,this._depLinks=new Ka};var Ja=function(){this._stack=[]};Ja.prototype.next=function(){return this._stack.shift()},Ja.prototype.add=function(t,e,n,r,s){if(r!==s){var i=null!==n?e.push(n):e;this._stack.push({node:t,key:i,value:r,prevValue:s})}},Ja.prototype.addMultiple=function(t,e,n,r){Array.isArray(n)?this._addMultipleFromArray(t,e,n,r):this._addMultipleFromObject(t,e,n,r)},Ja.prototype._addMultipleFromArray=function(t,e,n,r){for(var s=0,i=n.length;s<i;s++)this.add(t,e,s,n[s],qa(r,s))},Ja.prototype._addMultipleFromObject=function(t,e,n,r){for(var s=Va(n),i=0,o=s.length,a=void 0;i<o;i++)a=s[i],this.add(t,e,a,qa(n,a),qa(r,a))};function Ya(t,e,n){if("*"===this.key)for(var r=Va(t),s=0,i=r.length;s<i;s++)this.target.set(e.push(r[s]),qa(t,r[s]));else ja(t,this.key)&&this.target.set(e.push(this.key),qa(t,this.key))}var Xa={},Qa=function(t,e){this._original=t,this._value=t,this._links=new Ka,this._refs=e||new za,this._updatePaths=new s},$a={updated:{configurable:!0},value:{configurable:!0},original:{configurable:!0},refs:{configurable:!0}};$a.updated.get=function(){return this._original!==this._value},$a.value.get=function(){return this._value},$a.value.set=function(t){this._value!==t&&(this._original=this._value=t,this._refs.reset(),this.applyAllLinks(),this.save())},$a.original.get=function(){return this._original},$a.refs.get=function(){return this._refs},Qa.prototype.key=function(t){return t instanceof Ga?t:new Ga(t)},Qa.prototype.has=function(t){return this.get(t,Xa)!==Xa},Qa.prototype.get=function(t,e){return Fa(this._value,this.key(t),e)},Qa.prototype.set=function(t,e,n){if(t=this.key(t),e=this.applyLinks(t,e,n?null:this.get(t)),this._set(t,e)){for(var r,s=this._refs.getDeps(t),i=0,o=s.length;i<o;i++)(r=Fa(e,s[i][0],Xa))!==Xa&&this._updateDeps(s[i][1],r);this._updateParentDeps(t)}return this},Qa.prototype._set=function(t,e){if(e===this.get(t))return!1;var n=t.slice(0,-1),r=t.item(-1);return Ha(this._createIntermediate(n),r,e),!0},Qa.prototype.delete=function(t){if(t=this.key(t),this.has(t)){var e=t.slice(0,-1),n=t.item(-1);!function(t,e){t instanceof s||t instanceof i?t.delete(e):Array.isArray(t)?t.splice(e,1):"object"==typeof t&&delete t[e]}(this._createIntermediate(e),n)}return this},Qa.prototype.assign=function(t,e){var n=this;t=this.key(t);var r=this.get(t,Xa);return r===Xa||null==r||"object"!=typeof r?this.set(t,e):Va(e).forEach((function(r){return n.set(t.concat(r),qa(e,r))})),this},Qa.prototype.save=function(){this._original=this._value,this._updatePaths.clear()},Qa.prototype.link=function(t,e){var n=this;t=this.key(t),this._links.set(t,e),function(t,e){t=t instanceof Ga?t:new Ga(t);var n=new s;if(t.length){n.set(new Ga,e);for(var r=0,i=t.length,o=void 0;r<i&&(o={key:t.item(r),target:new s},n.forEach(Ya,o),(n=o.target).size);r++);}return n}(t,this.value).forEach((function(t,e){return n.set(e,t,!0)}))},Qa.prototype.applyLinks=function(t,e,n){t=this.key(t);var r=this._links.find(t,!0);if(r){var s=this._collectLinkUpdateTree(r,t,e,n);if(s.hasValue)e=s.value;else if(s.hasNodes)for(var i,o,a,c=[{node:s,key:null,value:e=xa(e)}];i=c.shift();)if(i.node.hasValue)Ha(i.value,i.key,i.node.value);else if(i.node.hasNodes){o=i.node.keys(),null!==i.key?(a=xa(qa(i.value,i.key)),Ha(i.value,i.key,a)):a=i.value;for(var u=0,d=o.length,h=void 0;u<d;u++)h=o[u],c.push({node:i.node.getNode(h),key:h,value:a})}}return e},Qa.prototype.applyAllLinks=function(){this._value=this.applyLinks(new Ga,this._value)},Qa.prototype._linkKey=function(t,e,n){var r=n(e,t,this);return r?(this._refs.save(r,t),this.get(r,e)):e},Qa.prototype._collectLinkUpdateTree=function(t,e,n,r){var s,i,o,a=new Ka,c=new Ja;for(c.add(t,new Ga,null,n,r);s=c.next();)if(s.node.hasValue&&(o=this._linkKey(e.concat(s.key),s.value,s.node.value))!==s.value&&a.set(s.key,o),s.node.hasNodes)for(var u=0,d=(i=s.node.keys()).length,h=void 0;u<d;u++)"*"===(h=i[u])&&null!=s.value?c.addMultiple(s.node.getNode(h),s.key,s.value,s.prevValue):ja(s.value,h)&&c.add(s.node.getNode(h),s.key,h,qa(s.value,h),qa(s.prevValue,h));return a},Qa.prototype._createIntermediate=function(t){this.updated||(this._value=xa(this._value));for(var e=this._updatePaths,n=this._value,r=0,i=t.length,o=void 0,a=void 0;r<i;r++)a=qa(n,o=t.item(r)),e.has(o)||(e.set(o,new s),Ha(n,o,a=null!=a?xa(a):{})),e=e.get(o),n=a;return n},Qa.prototype._updateParentDeps=function(t){for(var e=this._value,n=0,r=t.length-1;n<r;n++)e=qa(e,t.item(n)),this._updateDeps(this._refs.getOwnDeps(t.slice(0,n+1)),e)},Qa.prototype._updateDeps=function(t,e){for(var n=0,r=t.length,s=void 0;n<r;n++)s=t[n],this.has(s)&&this._set(s,e)&&this._updateParentDeps(s)},Object.defineProperties(Qa.prototype,$a);var Za={maxItems:100,request:function(){return Promise.reject(new Error("Метод не реализован"))},normalize:function(t){return t.trim()}},tc=function(t){function n(e,n,r,s){var i=t.call(this)||this;return i._store=e,i._api=n,i._key=r,"function"==typeof s&&(s={request:s}),i.options=v(v({},Za),s),i._safeSearchRequest=Z(i._safeSearchRequest.bind(i),250,{leading:!1,trailing:!0}),i.reset(),i}return g(n,t),Object.defineProperty(n.prototype,"key",{get:function(){return"function"==typeof this._key?this._key(this):this._key},enumerable:!0,configurable:!0}),n.prototype.getSection=function(){var t=this.key;return t&&new Qa(this._store.getState()).get(t)},n.prototype.query=function(t){var e=this.options.normalize(t||"");if(!e)return this.reset(),Promise.resolve();var n=this.getSection();return n&&n.normalizedQuery===e?Promise.resolve(n):(this._dispatch({type:Qi,data:{query:t,normalizedQuery:e,marker:void 0}}),this._hasRequest?Promise.resolve(this.getSection()):this._safeSearchRequest())},n.prototype.loadNext=function(){var t=this,e=this.getSection();return e&&e.normalizedQuery&&e.marker&&e.loadState!==so?(this._dispatch({type:to}),this.options.request(this._api,e.normalizedQuery,e).then((function(n){var r=t.getSection();return r&&r.normalizedQuery===e.normalizedQuery&&t.append(n),n}))):Promise.resolve(null)},n.prototype.reset=function(){this.getSection()&&(this._dispatch({type:Zi}),this.emit("reset"))},n.prototype.update=function(t){this._dispatch({type:Qi,data:v(v({},t),{loadState:e.LoadState.idle,loaded:!0})}),this.emit("update",t)},n.prototype.append=function(t){this._dispatch({type:$i,data:v(v({},t),{loadState:e.LoadState.idle})}),this.emit("append",t)},n.prototype.dispose=function(){this.reset(),this.removeAllListeners()},n.prototype._safeSearchRequest=function(){var t=this,e=this.getSection();return e&&e.normalizedQuery?(this._hasRequest=!0,this._dispatch({type:to}),this.options.request(this._api,e.normalizedQuery,e).then((function(n){t._hasRequest=!1;var r=t.getSection();return r&&(r.normalizedQuery?r.normalizedQuery===e.normalizedQuery?t.update(n):t._safeSearchRequest():t._dispatch({type:eo})),n})).catch((function(e){console.warn(e),t._dispatch({type:eo}),t._hasRequest=!1}))):(this._hasRequest=!1,Promise.resolve())},n.prototype._dispatch=function(t){this._store.dispatch(Object.assign({key:this.key},t))},n}(Ma),ec=function(t){function e(e,n,r,i,o){void 0===o&&(o={});var a=this;return a=t.call(this,e,n,(function(){var t=a.chatId,n=e.getState();return n.peekChat&&n.peekChat.id===t?["peekChat","search"]:n.chats instanceof s&&n.chats.has(t)?["chats",t,"search"]:["search","chat"]}),v({request:function(t,e,n){var s={chatId:a.chatId,query:e,count:100,marker:n.marker};return t.request(73,s).then((function(t){var e=a.chatId,n=[],s=t.result.map((function(t){return n.push(t.message),v(v({},t),{chatId:e})}));return Pa(Aa(n),{contacts:r,groups:i}).then((function(){return v(v({},t),{result:s})}))}))}},o))||this,a.chatId=0,a}return g(e,t),e.prototype.query=function(e,n){return void 0===n&&(n=0),this.chatId=n,t.prototype.query.call(this,e)},e.prototype.append=function(e){var n=new i,r=this.getSection();r.result&&r.result.forEach((function(t){return n.add(t.message.id)})),e=v(v({},e),{result:e.result.filter((function(t){return!n.has(t.message.id)&&(n.add(t.message.id),!0)}))}),t.prototype.append.call(this,e)},e.prototype.loadNext=function(e){return void 0===e&&(e=0),this.chatId=e,t.prototype.loadNext.call(this)},e.prototype.reset=function(t){var e=this.getSection();this.chatId=t,e&&(this._dispatch({type:Zi,chatId:t}),this.emit("reset"))},e}(tc),nc=function(t){function e(e,n,r,s){var i=this;return i=t.call(this,e,n,s.key,v({request:function(t,e,n){var o={query:e,count:i.options.maxItems,marker:n.marker};return t.request(68,o).then((function(t){return function(t,e){var n=e.result.map((function(t){return t.chat=t.chatId,t.chatId}));return t.fetchMissing(n).then((function(){return e}))}(r,t)})).then((function(t){var e=t.result;return s.messagesOnly&&(e=e.filter((function(t){return"MESSAGES"===t.section&&t.count>0}))),v(v({},t),{result:e})}))}},s))||this,i}return g(e,t),e}(tc);function rc(t){var e=0,n=0,r=0;return t.chats.forEach((function(t){e<t.lastEventTime&&(e=t.lastEventTime),Array.isArray(t.participants)&&t.participants.forEach((function(t){e<t.time&&(e=t.time)}))})),t.contacts.forEach((function(t){t.current||t.stub||(n<t.updateTime&&(n=t.updateTime),t.presence&&t.presence.seen&&r<t.presence.seen&&(r=t.presence.seen))})),{chatsSync:Math.floor(e),contactsSync:Math.floor(n),presenceSync:Math.floor(1e3*r),configHash:t.config.hash,interactive:t.interactive}}function sc(e){for(var n=arguments,r=[],s=1;s<arguments.length;s++)r[s-1]=n[s];var i=r[0];return void 0!==window.webapi?window.webapi.invoke(e,i):new Promise((function(e,n){t(["OK/webapi"],e,n)})).then((function(t){return t.invoke(e,i)}))}var ic=50,oc=25,ac=function(){function t(t,e,n,r,i,o,a,c,u){this._store=t,this._api=e,this._contacts=r,this._stats=o,this._config=a,this._posting=n,this._participants=c,this._refsService={contacts:r,groups:i},u&&(this._stickers=u),this._file=new ba(t,e),this._search=new nc(t,e,this,{key:["search"],maxItems:30}),this._messageInChatSearch=new ec(t,e,r,i,{maxItems:100}),this._fileRequests=new s,this._typingParticipants=new s,this._handleNotifMessage=this._handleNotifMessage.bind(this),this._handleIncomingMessage=this._handleIncomingMessage.bind(this),this._updateReadMark=this._updateReadMark.bind(this),this._addTypingParticipant=this._addTypingParticipant.bind(this),this._updateChatInfo=this._updateChatInfo.bind(this),this._api.on(128,this._handleNotifMessage),this._api.on(130,this._updateReadMark),this._api.on(129,this._addTypingParticipant),this._api.on(135,this._updateChatInfo)}return t.prototype.save=function(t,e){var n=this;return La(t,this._refsService).then((function(r){return n.dispatch(Lr(r)),e&&n.dispatch(Dr(t)),n.resolveMentions(t),t}))},t.prototype.fetchMissing=function(t){var e=this._store.getState().chats,n=(t=Array.isArray(t)?t.filter(nt):[t]).filter((function(t){return!e.has(t)}));return n.length?this.fetch(n):Promise.resolve([])},t.prototype.fetch=function(t){var e,n=this,r=!1;return Array.isArray(t)?(r=!0,e=t):e=[t],this.load(e).then((function(t){return n.save(t)})).then((function(t){return r?t:t[0]}))},t.prototype.fetchChatAllMembers=function(t){return this._participants.loadAllMembers(t.id)},t.prototype.fetchChatContacts=function(t){return Pa(Ta(Array.isArray(t)?t:[t]),this._refsService)},t.prototype.resolveMentions=function(t){return m(this,void 0,void 0,(function(){var e,n=this;return y(this,(function(r){switch(r.label){case 0:return e=t.map((function(t){return m(n,void 0,void 0,(function(){var e,n,r=this;return y(this,(function(s){switch(s.label){case 0:return(e=this.getChat(t.id))&&e.lastMentionMessageId?(n=ie(e,e.lastMentionMessageId))?[3,2]:[4,this.loadMessageByIds(t.id,[e.lastMentionMessageId])]:[3,3];case 1:return s.sent().messages.forEach((function(t){r.dispatch(jr(e.id,t,{lastMentionMessageId:e.lastMentionMessageId}))})),[3,3];case 2:this.dispatch(function(t,e){return{type:Wn,chatId:t,message:e}}(e.id,n)),s.label=3;case 3:return[2]}}))}))})),[4,Promise.all(e)];case 1:return r.sent(),[2]}}))}))},t.prototype.fetchRequiredChatContacts=function(t){return Ra(Ta(Array.isArray(t)?t:[t]),this._refsService)},t.prototype.load=function(t,e){var n=this;if(null==t)return Promise.resolve([]);var r,s=!1;if(Array.isArray(t)?(s=!0,r=t.filter(nt)):r=[t],!r.length)return Promise.resolve([]);for(var i=[],o=0;o<r.length;)i.push(this.loadChatInfo(r.slice(o,o+100))),o+=100;return Promise.all(i).then((function(t){var r=t.reduce((function(t,e){return t.concat(e.chats)}),[]);return e?n.fetchRequiredChatContacts(r).then((function(){return r})):r})).then((function(t){return s?t:t[0]})).catch((function(){return s?[]:void 0}))},t.prototype.fetchGroupChats=function(t,e){var n=this;void 0===e&&(e="NONE"),this._store.dispatch(O(t,e));var r=void 0===uc(dc(this._store,t),e)?void 0:rc(this._store.getState()).chatsSync;this._api.request(160,{groupId:t,filter:e,chatsSync:r}).then((function(r){return La(r.chats,n._refsService).then((function(s){return r.chats=s,n.dispatch(Nr(t,s,e,r.marker)),r}))}))},t.prototype.stopGroupChats=function(){this._api.request(162)},t.prototype.loadAllChats=function(t,e){void 0===e&&(e=0),this._lastChatsMarker!==t&&this.loadChatsLoop(t,e)},t.prototype.loadChatsLoop=function(t,e,n){var r=this;void 0===e&&(e=0),void 0===n&&(n=50),t&&(!e||t>e)&&this.loadNext(t,n).then((function(n){n.marker&&t===r._lastChatsMarker&&r.loadChatsLoop(n.marker,e),n.marker||0!=e||r.dispatch({type:Hn})}))},t.prototype.loadNext=function(t,n){var r=this;void 0===n&&(n=30);var s=this._store.getState().state;return t&&t!==this._lastChatsMarker&&s!==e.LoadState.chatsLoading?(this._lastChatsMarker=t,this._store.dispatch({type:S}),this._api.request(53,{marker:t,count:n}).then((function(t){return La(t.chats,r._refsService).then((function(e){return t.chats=e,r.dispatch(function(t,e){return{type:qn,chats:t,marker:e}}(e,t.marker||0)),t}))})).catch((function(t){throw r.resetInternalChatMarker(),r._store.dispatch({type:C}),t}))):Promise.resolve({chats:[],marker:0})},t.prototype.loadNextGroupChats=function(t,n){var r,s,i=this,o=dc(this._store,t);if(!o)return Promise.resolve();var a=uc(o,n),c=(null===(s=null===(r=o)||void 0===r?void 0:r.get(n))||void 0===s?void 0:s.state)===e.LoadState.chatsLoading,u=void 0===a;return u&&!c?this.fetchGroupChats(t,n):u||0===a||c?Promise.resolve():(this._store.dispatch(O(t,n)),this._api.request(161,{groupId:t,marker:a,filter:n}).then((function(e){return La(e.chats,i._refsService).then((function(r){return e.chats=r,i.dispatch(Nr(t,r,n,e.marker)),e}))})))},t.prototype.loadBotCommands=function(t){return this._api.request(144,{chatId:t})},t.prototype.updateBotCommands=function(t){var e=this;this.loadBotCommands(t).then((function(n){var r=n.contacts&&Object.values(n.contacts),s=n.commands&&n.commands.map((function(t){return t.bot=t.botId,delete t.botId,t}));e.dispatch(function(t,e){return{type:Cr,chatId:t,commands:e}}(t,s)),e._contacts.save(r||[])}))},t.prototype.suspendBot=function(t){return this._api.request(119,{botId:t,value:!0})},t.prototype.startBot=function(t){var e=this,n=hc(t,"botStarted");return this._api.request(64,n).then((function(n){e.dispatch(function(t,e){return{type:br,chatId:t,message:e}}(t,n.message)),e._handleIncomingMessage({chatId:t,message:n.message})})).then((function(){e.select(t),e.updateBotCommands(t)}))},t.prototype.sendBotCommand=function(t){var e=this,n=t.chatId,r=t.callbackId,s=t.type,i=t.payload,o=setTimeout((function(){e.dispatch(Kr(t,!0))}),300);return r?this._api.request(118,{callbackId:r,type:s,payload:i}).then((function(r){r&&r.message&&e._handleIncomingMessage({chatId:n,message:r.message}),clearTimeout(o),e.dispatch(Kr(t,!1))})):(clearTimeout(o),Promise.resolve())},t.prototype.sendButtonMessage=function(t,e){this._posting.sendButtonMessage(t,e)},t.prototype.loadChatInfo=function(t){return this._api.request(48,{chatIds:t})},t.prototype.updateChatInfo=function(t){var e=this;return this.loadChatInfo([t]).then((function(t){return e.dispatch(Lr(t.chats)),t.chats[0]}))},t.prototype.loadEntity=function(t){var e=this.getChat(t);return e?Promise.resolve({chat:e}):"number"==typeof t?this.load(t).then((function(t){return{chat:t}})):this._api.request(89,{link:t})},t.prototype.fetchEntity=function(t){var e=this;return this.loadEntity(t).then((function(t){if(t.user){var n=t.user.contact.id;return e.getDialog(n).then((function(t){return e._contacts.fetchMissing([n]).then((function(){return{chat:t,peek:!1}}))}))}if(t.chat){var r=t.chat,s=t.message;return Ie(t.chat)&&e.save([t.chat]),e.fetchChatContacts(r).then((function(){return{chat:r,messagesTime:s&&s.time,peek:!1}}))}if(t.group){var i=t.group,o=t.startPayload;return e.createGroupchat(i.groupId,void 0,void 0,o).then((function(t){return{chat:t}}))}return Promise.reject()}))},t.prototype.getDialog=function(t){var e=this,n=tt(this._getCurrentUser(),t),r=this.getChat(n);return r?Promise.resolve(r):0===n?Promise.reject("chat_with_myself"):this.load(n,!0).then((function(t){return t?e.save([t]).then((function(){return e.getChat(n)})):Promise.reject(new Error("Отсутствует чат с ID "+n))}))},t.prototype.getDialogStub=function(t){var e=this._store.getState(),n=e.contacts,r=e.auth.profile,i=n.get(t);if(!i)throw new Error("Не возможно создать диалог, пользователь "+t+" отсутствует");var o=tt(r.id,i.id),a=wa(i);return{id:o,type:"DIALOG",status:"ACTIVE",owner:r,hasBots:i.options&&i.options.includes("BOT"),settings:{dontDisturbUntil:0,chatId:o},participants:[{user:i,time:0},{user:r,time:0}],title:a,placeholder:a,contactId:i.id,official:i.official||i.options&&i.options.includes("OFFICIAL"),messages:null,media:new s,joinTime:1,participantsCount:2,unreadCount:0,created:Date.now(),lastEventTime:0}},t.prototype.create=function(t,e){var n,r=this;return 1!==t.length||(null===(n=e)||void 0===n?void 0:n.createMultichat)?this.createMultichat(t,e):this.getDialog(t[0]).then((function(t){return r.select(t.id),t}))},t.prototype.createMultichat=function(t,e){return this._createChat({userIds:t,chatType:"CHAT",okChat:!!e&&!!e.okChat},e)},t.prototype.createGroupchat=function(t,e,n,r){return this._newChat({chatType:"GROUP_CHAT",groupId:t,subjectType:e,subjectId:n,startPayload:r})},t.prototype.createChannel=function(t){var e=this;return this._createChat({title:t.title,chatType:"CHANNEL"},{description:t.description,icon:t.icon}).then((function(n){e._stats.action("ACTION_CHANNEL_CREATE"),e.setCreatedChannel(n.id);var r=v({},t);return delete r.description,delete r.title,delete r.icon,e.updateChat(n.id,r),e.select(n.id),n}))},t.prototype.createMultiChatFromDialog=function(t,e){var n=this,r=this.getChat(t).participants.find((function(t){return!t.user.current})).user.id;return this.createMultichat([r].concat(e)).then((function(t){return n.select(t.id),t}))},t.prototype.setCreatedChannel=function(t){this.dispatch(function(t){return{type:_r,chatId:t}}(t))},t.prototype.select=function(t,e){var n=this,r=this.getChat(t);if(r){var s;if(this.dispatch(function(t,e){return{type:$n,chatId:t,focusedTime:e}}(t,e)),r.messages&&r.messages.size)e&&(s=function(t,e){var n=Array.from(t.values()),r=n[0].time,s=n[n.length-1].time,i=e<r,o=e>s;if(i)return{from:e,backward:oc,forward:oc,forwardTime:r};if(o)return{from:e,backward:oc,forward:oc,backwardTime:s}}(r.messages,e),s&&(s.focus=!0));else{s={focus:!!e||void 0};var i=e||function(t){if(Array.isArray(t.participants)){var e=t.participants.find((function(t){return t.user.current}));return e&&e.time}}(r);i&&(Object.assign(s,{from:i,backward:oc,forward:oc}),r.lastMessage&&i>=r.lastMessage.time&&(s.backward=50,s.forward=3,s.from=r.lastMessage.time))}(s?this.fetchMessages(t,s):Promise.resolve()).then((function(){n.fetchChatAllMembers(r),n.fetchChatContacts(r),n._api.flowing&&(n.updateChatInfo(t),n._updateChatContactsPresence(r))}))}},t.prototype.resetSelectedChat=function(){this.dispatch({type:Zn})},t.prototype.subscribe=function(t){if(me(cc(this._store,t),this._getCurrentUser()))return this._api.request(75,{chatId:t,subscribe:!0})},t.prototype.unsubscribe=function(t){if(me(cc(this._store,t),this._getCurrentUser()))return this._api.request(75,{chatId:t,subscribe:!1})},t.prototype.searchTouch=function(t){t&&this._api.send(72,{chatId:t})},t.prototype.search=function(t){return this._search.query(t)},t.prototype.searchChats=function(t){var e=this;return this._api.request(68,t).then((function(t){t.result=t.result.filter((function(t){return"CHATS"===t.section})),t.result.length||(t.marker=void 0);var n=t.result.map((function(t){return t.chatId}));return e.fetchMissing(n).then((function(){return t}))})).then((function(t){return t.result.forEach((function(t){t.chat=e.getChat(t.chatId)})),t}))},t.prototype.searchMessages=function(t,e){var n=this.getChat(t);return n?(e||"").trim()?this._messageInChatSearch.query(e,t):(this.resetMessageSearch(t),n.messages?Promise.resolve():this.fetchMessages(t)):Promise.reject(new Error("В модели отсутствует чат с ID "+t))},t.prototype.chatSearchCountMsg=function(t,e,n){return this._api.request(197,{chatId:t,from:e,to:n})},t.prototype.loadMoreSearchResults=function(){return this._search.loadNext()},t.prototype.loadMoreMessageSearchResults=function(t){return this._messageInChatSearch.loadNext(t)},t.prototype.selectMessageSearchResult=function(t){var e=t.chatId,n=t.message;if(this.getChat(e))return this.select(e,n.time)},t.prototype.resetSearch=function(){this._store.dispatch({type:Zi})},t.prototype.resetMessageSearch=function(t){this._store.dispatch({type:no,chatId:t})},t.prototype.updateReadMark=function(t,e,n,r,s){void 0===s&&(s="READ_MESSAGE");var i=this.getChat(t);if(!i)return Promise.reject(new Error("Отсутствует чат "+t));var o="READ_REACTION"===s;if(!this._isUserChat(i)&&!this._isGroupChatModerator(i))return o?this._updateReactionMark(t):i.unreadCount>0&&this._updateReadMark({chatId:t,messageId:e,mark:n,unread:0}),Promise.resolve();var a=i.lastMessage&&i.messages&&i.messages.get(i.lastMessage.uid),c=function(t,e){var n=t&&t.participants;e||(e=this._getCurrentUser());if(n)for(var r=0,s=n.length;r<s;r++)if(n[r].user.id===e)return n[r].time;return-1}(i,this._getCurrentUser()),u=a&&fc(i,a)&&i.unreadCount>0&&!a.unread;return o||r||u||!(i.readMarkLock||n<c)?this.setReadMark(t,e,n,r,s):Promise.resolve()},t.prototype.setReadMark=function(t,e,n,r,s){var i=this;void 0===s&&(s="READ_MESSAGE");var o={chatId:t,messageId:e,mark:n,setAsUnread:r,type:s},a="READ_REACTION"===s;return a||this._updateReadMark(o),this._api.request(50,o).then((function(n){a?i._updateReactionMark(t):i._updateReadMark({chatId:t,messageId:e,mark:n.mark,unread:n.unread||0})}))},t.prototype.setMessageAsUnread=function(t,e){this._stats.action("MARK_AS_UNREAD_MESSAGE");var n=this.getChat(t),r=n&&ie(n,e);return r?this.updateReadMark(t,r.id,r.time,!0):Promise.resolve()},t.prototype.chatsLoaded=function(){return!!this._store.getState().chatsLoaded},t.prototype.selectShare=function(t,e){return this._posting.selectShare(t,e)},t.prototype.removeShares=function(t){return this._posting.removeShares(t)},t.prototype.posting=function(t,e){this._posting.update(t,e)},t.prototype.resetPosting=function(t){this._posting.reset(t)},t.prototype.setPostingNotifyMode=function(t,e){this._posting.update(t,{disableNotify:e})},t.prototype.resetPostingLink=function(t){this._posting.resetLink(t)},t.prototype.getMessagesFromPosting=function(t,e){return this._posting.getMessagesFromPosting(t,e)},t.prototype.commitPosting=function(t,e){var n=this;return this._posting.commit(t,e).then((function(e){var r=Array.isArray(e)?e[e.length-1]:e,s=n.getChat(r.chatId||t);n.setReadMark(t,r.message.id,r.message.time);var i=!1;s&&s.messages&&s.messages.forEach((function(t){t.id===r.message.id&&(i=!0)})),i||n.fetchMessages(r.chatId)}))},t.prototype.replyMessage=function(t,e){return this._posting.replyMessage(t,e)},t.prototype.editLastMessage=function(t){var e=this.getChat(t),n=e&&!e.posting&&function(t){for(var e=Array.from(t.messages.values()),n=Date.now(),r=e.length-1;r>=0;r--){var s=e[r];if(s&&s.actions){var i=s.actions.find((function(t){return"edit"===t.type}));if(i&&i.timeout){if(i.timeout>n)return s;break}}}return null}(e);if(n)return this.editMessage(t,n.id)},t.prototype.editMessage=function(t,e){return this._posting.editMessage(t,e)},t.prototype.selectMessage=function(t,e){this.dispatch(function(t,e){return{type:ar,chatId:t,messageId:e}}(t,e))},t.prototype.unselectMessage=function(t,e){this.dispatch(function(t,e){return{type:cr,chatId:t,messageId:e}}(t,e))},t.prototype.resetSelectedMessages=function(t){this.dispatch(function(t){return{type:ur,chatId:t}}(t))},t.prototype.removeMessages=function(t,e,n,r){var s=this;if(e.length){this.dispatch(function(t,e){return{type:or,chatId:t,messageIds:e}}(t,e));var i=this.getChat(t),o=e.map((function(t){return ie(i,t)})).map((function(t){return void 0===t&&(t={}),t.id})).filter(Boolean);o.length&&this._api.request(66,{chatId:t,messageIds:o,complaint:r?"SPAM":null,forMe:n}),e.forEach((function(e){return s._posting.cancelMessageSend(t,e)}));var a=this._posting.getPostingForm(t);a&&"EDIT"===a.type&&_s(a.link)&&a.link.id&&e.indexOf(a.link.id)>-1&&this.resetPostingLink(t)}},t.prototype.stopTyping=function(t){this._posting.stopTyping(t)},t.prototype.startTyping=function(t,e){this._posting.startTyping(t,e)},t.prototype.resetFocusedMessage=function(t){this.dispatch(function(t){return{type:Bn,chatId:t}}(t))},t.prototype.fetchMessages=function(t,e){var n,r=this;return"number"==typeof(e=v({},e)).focus?n=e.focus:!0===e.focus&&(n=e.from),delete e.focus,this.loadMessages(t,e).then((function(t){return t?Pa(Aa(t=t.map((function(t){return t.elements&&t.elements.length&&(t.elements=t.elements.filter(Boolean)),t}))),r._refsService).then((function(){return t})):(r.storeStickers(function(t){var e=[];return t.forEach((function(t){var n,r;e=e.concat(pc(t)),(null===(n=t.link)||void 0===n?void 0:n.message)&&(e=e.concat(pc(null===(r=t.link)||void 0===r?void 0:r.message)))})),e}(t)),t)})).then((function(e){return e&&e.length&&r.dispatch(function(t,e,n){return{type:Gn,chatId:t,messages:e,focus:n}}(t,e,n)),e}))},t.prototype.loadMessages=function(t,e){var n=this.getChat(t);if(n&&"CHANNEL"===n.type&&"CLOSED"===n.status)return Promise.resolve([n.lastMessage]);var r=function(t,e){var n=Object.assign({chatId:t.id,from:t.lastMessage&&t.lastMessage.time||0},e);n.direction?n[n.direction]=n.amount||ic:null==n.forward&&null==n.backward&&(n.backward=n.amount||ic);return n}(n,e);return this._request(t,49,r).then((function(t){return t.messages&&0!==t.messages.length||n.isFake||!n.lastMessage?t.messages:[n.lastMessage]}))},t.prototype.loadMessageByIds=function(t,e){var n={chatId:t,messageIds:e};return this._request(t,71,n)},t.prototype.getMessageIfExists=function(t,e){var n=this,r=this.getChat(t),s=r&&ie(r,e);return s?Promise.resolve(s):this.loadMessageByIds(t,[e]).then((function(t){var s=t.messages.find((function(t){return t.id===e}));if(s)return re(n._store.immutable,r,s)}))},t.prototype.voiceMessageUpdate=function(t,e){return this._posting.voiceMessageUpdate(t,e)},t.prototype.voiceMessageReset=function(t){return this._posting.voiceMessageReset(t)},t.prototype.addFiles=function(t,e,n){return this._posting.addFiles(t,e,n)},t.prototype.sendUserSticker=function(t,e){return this._posting.sendUserSticker(t,e)},t.prototype.getFileType=function(t){return lt(t)},t.prototype.replaceFile=function(t,e,n,r){return void 0===r&&(r=!1),this._posting.replaceFile(t,e,n,r)},t.prototype.removeFile=function(t,e){this._posting.removeFile(t,e)},t.prototype.addPostingPreview=function(t){this._posting.addPreview(t)},t.prototype.resetPostingPreview=function(t){this._posting.resetPreview(t)},t.prototype.initPostingForward=function(t,e){e=v(v({},e),{chatId:t}),this._posting.updateForward(t,e)},t.prototype.updatePostingForwardComment=function(t,e){this._posting.updateForward(t,{text:e})},t.prototype.addPostingForwardMessage=function(t,e){this._posting.updateForward(t,{addMessageId:e})},t.prototype.removePostingForwardMessage=function(t,e){this._posting.updateForward(t,{removeMessageId:e})},t.prototype.addPostingForwardChat=function(t,e){this._posting.updateForward(t,{addChatId:e})},t.prototype.removePostingForwardChat=function(t,e){this._posting.updateForward(t,{removeChatId:e})},t.prototype.resetPostingForward=function(t){var e=this.getChat(t);e&&e.posting&&e.posting.forward&&"MESSAGES"===e.posting.forward.type&&this.resetSelectedMessages(t),this._posting.updateForward(t,null)},t.prototype.join=function(t){var e=this;return this._api.request(57,{link:t}).then((function(n){var r,s=n.chat;"CHANNEL"===s.type?e._stats.action("ACTION_CHANNEL_SUBSCRIBE"):e._stats.action(t.includes("/join/")?"ACTION_CHAT_JOIN_PRIVATE_LINK":"ACTION_CHAT_JOIN_PUBLIC_LINK");var i=(null===(r=e._store.getState().config)||void 0===r?void 0:r.server)["chat-join-add-to-list"];return e.save([s],i).then((function(){return e.select(s.id)}))}))},t.prototype.clear=function(t,e){void 0===e&&(e=!1),this.dispatch(function(t){return{type:fr,chatId:t}}(t));var n=this.getChat(t).lastEventTime;return this._api.request(54,{chatId:t,lastEventTime:n,forAll:e})},t.prototype.close=function(t){var e=this.getChat(t).lastEventTime;return this._api.request(61,{chatId:t,lastEventTime:e})},t.prototype.remove=function(t){var e=this.getChat(t);if(e){var n=e.lastEventTime,r="DIALOG"!==e.type;return"CHANNEL"===e.type&&this._stats.action("ACTION_CHANNEL_DELETE"),this.dispatch(Vr(t)),this._api.request(52,{chatId:t,lastEventTime:n,forAll:r})}},t.prototype.hide=function(t){var e=this;return this._api.request(196,{chatId:t}).then((function(){return e.dispatch(Vr(t))}))},t.prototype.leave=function(t){var e=this;return this._api.request(58,{chatId:t}).then((function(){return e.dispatch(Vr(t))}))},t.prototype.setIcon=function(t,e){var n=this,r=URL.createObjectURL(e);this.dispatch(function(t,e,n){return{type:gr,chatId:t,url:e,fullUrl:n}}(t,r,r));var s=this._file.issueUrl("PHOTO").then((function(t){return n._file.upload(t.url,e)})),i=this.getChat(t);return i&&"CHANNEL"===i.type?s.then((function(e){var r=e.photos[Object.keys(e.photos)[0]].token;return n._api.request(55,{chatId:t,photoToken:r})})).then((function(t){return n.save([t.chat])})):s.then((function(e){var r=e.photos[Object.keys(e.photos)[0]].token,s=hc(t,"icon",{photoToken:r});return n._api.request(64,s)})).then((function(e){return n.dispatch(jr(t,e.message)),URL.revokeObjectURL(r),e}))},t.prototype.revokeLink=function(t){return this._updateChat(t,{revokePrivateLink:!0})},t.prototype.updateNextLink=function(t,e){var n=this,r=this.getChat(t),s=r&&r.link&&r.link.split("/").pop();e&&s!==e?this.checkPublicLink(e).then((function(e){n.dispatch(Gr(t,e))})):this.dispatch(Gr(t))},t.prototype.checkPublicLink=function(t){return this._api.request(56,{link:t}).then((function(){return{link:t}})).catch((function(t){return{error:t.message}}))},t.prototype.updateChat=function(t,e){var n=this;void 0===e&&(e={});var r={theme:e.theme,description:e.description,access:e.access,link:e.link,revokePrivateLink:e.revokePrivateLink,removeLink:e.removeLink,options:e.options};return this._updateChat(t,r).then((function(){e.icon&&"name"in e.icon&&n.setIcon(t,e.icon)}))},t.prototype.commitForward=function(t,e){var n=this,r=Date.now(),s=this.getChat(t),i=[];if(e||s&&s.posting&&s.posting.forward&&(e=s.posting.forward),!e)return Promise.reject("Empty forward form");var o=e.targetChatIds,a=e.text,c=e.messageIds,u=void 0===c?[]:c,d=function(){return n.resetPostingForward(t),Promise.all(i)};switch(this.calculateForwardInfo(o),e.type){case"MESSAGES":return this._stats.action("FORWARD_MESSAGE","targets: "+o.length+", messages: "+u.length),Promise.all(u.map((function(e){return n.getMessageIfExists(t,e)}))).then((function(e){return e.filter((function(t){return t&&"REMOVED"!==t.status})).sort((function(t,e){return t.time>e.time?1:t.time<e.time?-1:0})).forEach((function(e,c){o.forEach((function(t){a&&0===c&&i.push(n._sendForwardComment(t,a,r++)),i.push(n._posting.forwardMessage(t,s.id,e,r++))})),n.resetSelectedMessages(t)})),d()}));case"CHANNEL":this._stats.action("SHARE_CHANNEL_LINK","targets: "+o.length),o.forEach((function(t){a&&i.push(n._sendForwardComment(t,a,r++)),i.push(n._posting.sendChannelLink(t,s.link,r++))}))}return d()},t.prototype.addLeftColActiveReason=function(t){return this.dispatch(function(t){return{type:Rr,reason:t}}(t))},t.prototype.removeLeftColActiveReason=function(t){return this.dispatch(function(t){return{type:Pr,reason:t}}(t))},t.prototype.setInfoActive=function(t){return this.dispatch(function(t){return{type:"Set info panel state",infoActive:t}}(t))},t.prototype.calculateForwardInfo=function(t){var e,n;(null===(e=this._store.getState().config)||void 0===e?void 0:e.server)["quick-forward"]&&(null===(n=t)||void 0===n?void 0:n.length)&&this._store.dispatch({type:Ci,chatIds:t})},t.prototype.sendLocation=function(t,e,n,r){var s=this;return this._stats.action("location_sent"),this._posting.sendLocation(t,e,n,r).then((function(){return s.resetSearch()}))},t.prototype.sendAttaches=function(t,e){var n=this;return this._stats.action("attachment_sent"),this._posting.sendAttach(t,e).then((function(){return n.resetSearch()}))},t.prototype.saveLocationImage=function(t,e,n){this.dispatch(function(t,e,n){return{type:Tr,chatId:t,messageId:e,image:n}}(t,e,n))},t.prototype.sendSticker=function(t,e){var n=this;return this._stats.action("sticker_sent",e.stickerOrigin),this._posting.sendSticker(t,e).then((function(){return n.resetSearch()}))},t.prototype.sendCommand=function(t,e){var n=this;return this._posting.sendCommand(t,e).then((function(){return n.resetSearch()}))},t.prototype.sendContact=function(t,e){var n=this,r=Date.now();this._stats.action("SEND_CONTACT","targets: "+e.length),this.fetchMissing(e).then((function(){var s=e.map((function(e){return n._posting.sendContact(e,t,r++)}));return n._afterShare(s,1===e.length?e[0]:null)}))},t.prototype.sendVideoMessage=function(t,e){var n=ys(t,e,Date.now(),"VIDEO");return this._posting.commitPostingForm(t,n)},t.prototype.updateMessagesStats=function(t,e){var n=this,r=this.getChat(t);r&&this._isUserChat(r)&&this._api.request(74,{chatId:t,messageIds:e}).then((function(e){n.dispatch(function(t,e){return{type:"Update chat message stats",chatId:t,stats:e}}(t,e.stats))}))},t.prototype.requestFileUrl=function(t,e){var n=this;if(!this._fileRequests.has(e)){var r=this._api.request(88,{fileId:e}).then((function(r){n._fileRequests.has(e);var s=r&&r.url;n.dispatch(function(t,e,n){return{type:Ir,chatId:t,fileId:e,url:n}}(t,e,s))})).catch((function(t){return n._fileRequests.has(e),Promise.reject(t)}));this._fileRequests.set(e,r)}return this._fileRequests.get(e)},t.prototype.setPinVisibility=function(t,e){return this._api.request(86,{chatId:t,show:e})},t.prototype.setNewPin=function(t,e,n){return void 0===n&&(n=!1),this._api.request(55,{chatId:t,pinMessageId:e||0,notifyPin:n})},t.prototype.togglePin=function(t,e){this.getChat(t)&&(this.dispatch(function(t,e){return{type:kr,chatId:t,hidden:e}}(t,e)),this.setPinVisibility(t,!e))},t.prototype.addPin=function(t,e){var n=this;this.dispatch(function(t,e){return{type:Sr,chatId:t,messageId:e}}(t,e)),this.setNewPin(t,e).then((function(){return n.updateChat(t)}))},t.prototype.removePin=function(t){var e=this;this.dispatch(function(t){return{type:Er,chatId:t}}(t)),this.setNewPin(t).then((function(){return e.updateChat(t)}))},t.prototype.isPeekChat=function(t){var e=this._store.getState().peekChat;return e&&e.id===t||!this.getChat(t)},t.prototype.isParticipant=function(t,e){return _e(t,e)},t.prototype.getChat=function(t){var e=cc(this._store,t);if(e)return e;var n=this._store.getState();return n.newChat&&lc(n.newChat,t)?n.newChat:void 0},t.prototype.getSelectedChat=function(){return this._store.getState().selectedChat},t.prototype.findMessage=function(t,e){var n="number"==typeof t?this.getChat(t):t;return n&&ie(n,e)},t.prototype.isFavorite=function(t){var e="number"==typeof t?this.getChat(t):t;return Boolean(e&&e.settings&&e.settings.favIndex)},t.prototype.getFavorites=function(){var t=this,e=this._store.getState(),n=e&&e.config&&e.config.server,r=n&&n["max-favorite-chats"]||0,i=[];return e.chats instanceof s&&e.chats.forEach((function(e,n){t.isFavorite(e)&&i.push(n)})),{chats:i,max:r}},t.prototype.addFavorite=function(t){var e=this.getChat(t),n=this.getFavorites(),r=function(t,e){var n=new Error(t);return n.code=e,Promise.reject(n)};return e?!isNaN(n.max)&&n.chats.length>=n.max?r("Max favorites limit reached","max-favorite-limit-reached"):this.isFavorite(e)?Promise.resolve():this._config.setChatSettings(t,{favIndex:Date.now()}):r("No chat with id "+t,"no-chat")},t.prototype.removeFavorite=function(t){var e=this.getChat(t);return e&&this.isFavorite(e)?this._config.setChatSettings(t,{favIndex:0}):Promise.resolve()},t.prototype.transferOwnership=function(t,e){return this._updateChat(t,{changeOwnerId:e})},t.prototype.allowRemoveAll=function(t,e){var n,r,s,i=this.getChat(t);if(!i)return!1;var o=i.admins&&i.admins.find((function(t){return t.user&&t.user.current})),a=(null===(n=i.groupChatInfo)||void 0===n?void 0:n.isModerator)||(null===(s=null===(r=o)||void 0===r?void 0:r.permissions)||void 0===s?void 0:s.manageMessages),c=Date.now(),u=this._store.getState().config.server["edit-timeout"],d=!1,h=e.every((function(t){var e=ie(i,t);if(e){var n=ut(u,e.time)<c;return d=d||!!e.error||!e.id,e.sender&&e.sender.current&&!n&&!e.error&&e.id}return!1}));return a&&!d||h},t.prototype.cleanRemovedMessage=function(t,e){this.dispatch(function(t,e){return{type:wr,chatId:t,messageId:e}}(t,e))},t.prototype.report=function(t,e){return void 0===e&&(e="SPAM"),this._api.request(117,{chatId:t,complaint:e})},t.prototype.hideAlert=function(t){this.dispatch(function(t){return{type:Or,chatId:t}}(t))},t.prototype.hideAlertImportant=function(t){this.dispatch(function(t){return{type:Ar,chatId:t}}(t))},t.prototype.hangupMessage=function(t){var e=this,n=t.chatId,r=t.text,s=ms(n,{text:r});return this.getChat(n)?this._posting.commitPostingForm(n,s,!0):this.fetch(n).then((function(){e._posting.commitPostingForm(n,s,!0)}))},t.prototype.getPostingService=function(){return this._posting},t.prototype.resetInternalChatMarker=function(){this._lastChatsMarker=0},t.prototype.destroy=function(){this._api.off(128,this._handleNotifMessage),this._api.off(130,this._updateReadMark),this._api.off(129,this._addTypingParticipant),this._api.off(135,this._updateChatInfo)},t.prototype._updateChatContactsPresence=function(t){var e=Ta([t],!0).contacts;this._contacts.updatePresence(Array.from(e))},t.prototype._newChat=function(t){var e=this;return this._api.request(63,t).then((function(t){return e.save([t.chat]),t.chat}))},t.prototype._createChat=function(t,e){var n=this,r=hc(void 0,"new",t);return this._api.request(64,r).then((function(t){var r=t.chat,s=t.message;r.lastMessage&&r.lastEventTime||(r.lastMessage=s,r.lastEventTime=s.time),r.messages||(r.messages=[s]),n.save([r],!0);var i=Promise.resolve();if(e){e.title&&(i=i.then((function(){return n._updateChat(r.id,{theme:e.title})}))),e.description&&(i=i.then((function(){return n._updateChat(r.id,{description:e.description})})));var o=e.icon;if(o)if("lastModified"in o){var a=o;i=i.then((function(){return n.setIcon(r.id,a)}))}else sc("messages/avatar/change",v(v({},o),{convId:"CHAT_"+Math.abs(r.id)}))}return Promise.race([i.then((function(){return r})),new Promise((function(t){return setTimeout((function(){return t(r)}),500)}))])}))},t.prototype._request=function(t,n,r){var s=this;return this.dispatch(qr(t,e.LoadState.loading)),this._api.request(n,r).then((function(n){return s.dispatch(qr(t,e.LoadState.idle)),n})).catch((function(n){return s.dispatch(qr(t,e.LoadState.idle)),Promise.reject(n)}))},t.prototype._handleNotifMessage=function(t){var e=this.getChat(t.chatId),n=e?e.type:t.chat&&t.chat.type,r=e&&e.id||t.chatId,s=t.message&&t.message.id;r&&n&&s&&this._api.send(128,{chatId:r,messageId:s,chatType:n},{notif:!0,cmd:1}),this._handleIncomingMessage(t)},t.prototype._handleIncomingMessage=function(t){var e=this;t=function(t){var e=t.message&&Array.isArray(t.message.attaches)&&t.message.attaches[0];if(e&&"CONTROL"===e._type&&"new"===e.event&&t.chat&&!t.chat.lastMessage)return v(v({},t),{chat:v(v({},t.chat),{lastMessage:t.message})});return t}(t);var n,r,i=this.getChat(t.chatId);if(t.chat&&ye(t.chat,this._getCurrentUser()))return this.dispatch(Vr(t.chatId,t.message)),Promise.resolve();if(!i)return(t.chat?La(t.chat,this._refsService):this.fetch(t.chatId)).then((function(t){return e.dispatch(Dr([t]))}));if("REMOVED"===t.message.status){var o=i.lastMessage&&i.lastMessage.id===t.message.id&&!fc(i,t.message);return this.dispatch((n=t.chatId,r=t.message.id,{type:Qn,chatId:n,messageId:r})),o?this.fetch(t.chatId):Promise.resolve()}this._stickers&&this.storeStickers(pc(t.message));var a=Oa(t.message),c=this._getLastMentionId(i,t.message);return Pa(a,this._refsService).then((function(){var n=i.lastMessage;e.dispatch(jr(t.chatId,t.message,{prevMessageId:t.prevMessageId,lastMentionMessageId:c})),!function(t,e){if(t.lastMessage){if(t.lastMessage.id!==e.prevMessageId){if(t.messages instanceof s){var n=Array.from(t.messages.values()),r=n[n.length-1];if(r&&r.id===e.prevMessageId)return!1}return!0}if(t.messages)return!fc(t,t.lastMessage)}return!1}(i,t)?t.chat&&("ACTIVE"===t.chat.status&&"REMOVED"===i.status&&e.dispatch(xr(t.chatId)),e._updateChatInfo(t)):e.fetch(t.chatId).then((function(t){if(t){var r=e.getChat(t.id);r&&r.selected?n&&fc(r,n)&&e.fetchMessages(t.id):e.dispatch(xr(t.id))}}))}))},t.prototype._getLastMentionId=function(t,e){var n=this._contacts.currentUser,r=e.sender?function(t){return"number"==typeof t?t:t.id}(e.sender):null;if(function(t,e){return!!t.elements&&t.elements.some((function(t){return t.entityId===e.id}))}(e,n)&&r!==n.id){var s=void 0;if(t.lastMentionMessageId&&(s=ie(t,t.lastMentionMessageId)),!s||s.time<e.time)return e.id}},t.prototype._updateReadMark=function(t){var e,n,r,s,i;this.dispatch((e=t.chatId,n=t.mark,r=t.userId,s=t.unread,i=t.setAsUnread,{type:er,chatId:e,mark:n,userId:r,unread:s,setAsUnread:i}))},t.prototype._updateReactionMark=function(t,e,n){this._store.dispatch({type:xo,chatId:t,lastReactedMessageId:e,lastReaction:n})},t.prototype._addTypingParticipant=function(t){var e,n,r,s=this,i=t.chatId+":"+t.userId;this._typingParticipants.has(i)&&clearTimeout(this._typingParticipants.get(i)),this.dispatch((e=t.chatId,n=t.userId,r=t.type,{type:dr,chatId:e,userId:n,attachType:r})),this._typingParticipants.set(i,setTimeout((function(){s._typingParticipants.delete(i),s.dispatch(function(t,e){return{type:hr,chatId:t,userId:e}}(t.chatId,t.userId))}),6e3))},t.prototype._getCurrentUser=function(){var t=this._store.getState().auth;return t&&t.profile&&t.profile.id},t.prototype._updateChatInfo=function(t){var e=this,n=t.chat;ye(n,this._getCurrentUser())?this.dispatch(Vr(n.id)):this.fetchChatContacts(n).then((function(){e.dispatch(Ur(n))}))},t.prototype._sendForwardComment=function(t,e,n){return this._posting.commitPostingForm(t,ms(t,{cid:n++,text:e}),!0)},t.prototype._updateChat=function(t,e){var n=this;return this._api.request(55,v({chatId:t},e)).then((function(e){var r=e.chat,s=e.message;return r&&n.dispatch(Ur(r)),s&&n.dispatch(jr(t,s)),e}))},t.prototype._isUserChat=function(t){return _e(t,this._getCurrentUser())},t.prototype._isGroupChatModerator=function(t){var e;return!!(null===(e=t.groupChatInfo)||void 0===e?void 0:e.isModerator)},t.prototype._afterShare=function(t,e){var n=this;return Promise.all(t).then((function(t){var r;t.forEach((function(t){e===t.chatId&&(r=t.message),n.dispatch(jr(t.chatId,t.message))})),n.resetSearch(),e&&n.fetchMissing(e).then((function(){n.select(e,r&&r.time)}))}))},t.prototype.dispatch=function(t){this._store.dispatch(t)},t.prototype.toggleAnswered=function(t){return this.groupChatMark(t,!0,!1)},t.prototype.toggleImportant=function(t){return this.groupChatMark(t,!1,!0)},t.prototype.groupChatMark=function(t,e,n){var r=this,s=this.getChat(t),i=function(t,e){var n=new Error(t);return n.code=e,Promise.reject(n)};if(!s)return i("No chat with id "+t,"no-chat");var o=s.groupChatInfo;if(!o)return i("Chat has no group info","no-group-info");if(!o.isModerator)return i("You are not group chat moderator","no-moderator-privileges");var a={chatId:t};return e&&(a.answered=!o.isAnswered),n&&(a.important=!o.isImportant),this._api.request(163,a).then((function(){return r.updateChatInfo(t)}))},t.prototype.storeStickers=function(t){t.length&&this._stickers.storeMissing(t)},t}();function cc(t,e){if(e){var n=t.getState(),r=n.chats.get(e);return r||(n.peekChat&&lc(n.peekChat,e)?n.peekChat:"string"==typeof e?Array.from(n.chats.values()).find((function(t){return lc(t,e)})):void 0)}}function uc(t,e){var n;if(void 0===e&&(e="NONE"),t){var r=t.get(e);if(void 0!==r)return r.marker;if("NONE"!==e&&0===(null===(n=t.get("NONE"))||void 0===n?void 0:n.marker))return 0}}function dc(t,e){var n,r;return null===(r=null===(n=t.getState().moderatedGroups)||void 0===n?void 0:n.chatLists)||void 0===r?void 0:r.get(e)}function hc(t,e,n){return{chatId:t,message:{cid:Date.now(),attaches:[v({_type:"CONTROL",event:e},n)]}}}function fc(t,e){return!(!e||!t.messages)&&(t.messages.has(U(e))||t.messages.has(e.id))}function lc(t,e){return t&&(t.id===e||t.link===e)}function pc(t){return et(t.attaches||[]).filter((function(t){return"STICKER"===t._type}))}var gc=36e5,vc={s:1e3,m:6e4,h:gc,d:864e5};function mc(t){var e=t.trim().match(/^(\d+)([a-z]*)$/);return e?Number(e[1])*(vc[e[2].toLowerCase()]||1):0}var yc=function(){function t(t,e){var n=this;this._store=t,this._api=e,this._api.on(134,(function(t){if(t&&t.config){var e=t.config;e.chats&&Object.keys(e.chats).forEach((function(t){var n=e.chats[t];n.dontDisturbUntil||(n.dontDisturbUntil=0),n.favIndex||(n.favIndex=0)})),n.save(e)}}))}return t.prototype.save=function(t){return this._store.dispatch({type:Si,config:t}),t},t.prototype.getUserSettings=function(){var t=this._store.getState();return t&&t.config&&t.config.user},t.prototype.getProsConfig=function(){var t=this._store.getState();return t&&t.config&&t.config.pros||{}},t.prototype.setUserSettings=function(t){var e=this;(function(t){if("DONT_DISTURB_UNTIL"in t)return!1;return t.UI_NOTIFICATIONS||t.PUSH_SOUND&&"_NONE_"!==t.PUSH_SOUND})(t)&&(t=v(v({},t),{DONT_DISTURB_UNTIL:0}));var n=!1;for(var r in t)t.hasOwnProperty(r)&&B.has(r)&&(t[r],n=!0);var s=this.save({user:t});return n?this._api.request(22,{settings:{user:t}}).then((function(t){return e.save(t)})).catch((function(t){return console.error("error saving user config",t)})):Promise.resolve(s)},t.prototype.setCampaignIds=function(t){return this.save({campIds:t})},t.prototype.setHelloClosed=function(t,e){var n,r;if(this.shouldHideHelloStickers(e)){var s={closedCount:((null===(r=(this.getProsConfig().hiddenHello||{})[t])||void 0===r?void 0:r.closedCount)||0)+1,lastClosedTime:Date.now()};this.save({pros:{hiddenHello:(n={},n[t]=s,n)}}),this.resetIgnoredHelloViews(e),_c("hidden")}},t.prototype.isHelloClosed=function(t,e){var n,r,s=null===(r=null===(n=this._store.getState())||void 0===n?void 0:n.config)||void 0===r?void 0:r.server;if(s&&this.shouldHideHelloStickers(e)){var i=this.getProsConfig(),o=s["hide-hello-max-ignored-views"];if(o&&i.ignoredHelloViews>=o)return _c("hide-max-ignored"),!0;if(this.isClosedHelloLimit(i.hiddenHello))return _c("hide-max-closed-chats"),!0;var a=i.hiddenHello&&i.hiddenHello[t],c=s["hide-hello-durations"];if(a&&c){var u=a.closedCount,d=u>=c.length+1;d&&_c("hide-closed-count-max");var h=u>0&&Date.now()-a.lastClosedTime<mc(c[u-1]);return h&&_c("hide-closed-timeout"),d||h}}return _c("not-closed"),!1},t.prototype.resetIgnoredHelloViews=function(t){this.shouldHideHelloStickers(t)&&(_c("ignored-view-reset"),this.save({pros:{ignoredHelloViews:0}}))},t.prototype.incrementIgnoredHelloViews=function(t){var e;if(this.shouldHideHelloStickers(t)){_c("ignored-view");var n={ignoredHelloViews:((null===(e=this.getProsConfig())||void 0===e?void 0:e.ignoredHelloViews)||0)+1};this.save({pros:n})}},t.prototype.getChatSettings=function(t){var e=this._store.getState(),n=e&&e.config&&e.config.chats;return n&&n[t]},t.prototype.setChatSettings=function(t,e){var n;return this._save({chats:(n={},n[t]=e,n)})},t.prototype._save=function(t){var e=this;return this.save(t),this._api.request(22,{settings:t}).then((function(t){return e.save(t)})).catch((function(t){return console.error("error saving config",t)}))},t.prototype.shouldHideHelloStickers=function(t){var e,n,r=null===(n=null===(e=this._store.getState())||void 0===e?void 0:e.config)||void 0===n?void 0:n.server,s=r&&r["hide-hello-modes"];return t&&s&&s.indexOf(t)>-1},t.prototype.isClosedHelloLimit=function(t){var e,n,r=null===(n=null===(e=this._store.getState())||void 0===e?void 0:e.config)||void 0===n?void 0:n.server;if(r&&t){var s=r["hide-hello-max-closed-interval"],i=r["hide-hello-max-closed-count"];if(s&&i){var o=mc(s),a=Date.now();return Object.values(t).filter((function(t){return t.closedCount>0&&a-t.lastClosedTime<o})).length>=i}}return!1},t}();function _c(t){var e;"undefined"!=typeof OK&&(null===(e=OK.logger)||void 0===e||e.success("messagesLayer","hello-stickers",t))}var Ic=function(){function t(t,e){this._store=t,this._api=e,this._downloading=new s}return t.prototype.get=function(t){return this._store.getState().download.get(t)},t.prototype.prefetch=function(t,e,n){var r=this,s=this.get(t);return s&&s.url?Promise.resolve(s.url):this.getUrl(t,e,n).then((function(e){if(e)return r._store.dispatch({type:Oi,fileId:t,url:e}),e}))},t.prototype.fetch=function(t,e,n){var r=this;if(this._downloading.has(t))return this._downloading.get(t);var s=function(e,n){return r._store.dispatch(v({type:e,fileId:t},n))},i=function(){return!r.get(t)};s(Ti);var o=this.prefetch(t,e,n).then((function(t){return i()?Promise.reject(at()):new Promise((function(e,n){var r=!1,o=new XMLHttpRequest;o.responseType="blob",o.onprogress=function(t){i()?r||(r=!0,o.abort(),n(at())):s(Ai,{loaded:t.loaded,total:t.total})},o.onerror=function(t){return n(t)},o.onload=function(){var t,n=function(t){if(!t)return"";var e=t.split(";").reduce((function(t,e){var n=e.trim().split("=");return t[n[0].trim()]=n[1]&&n[1].trim(),t}),{}),n="";e["filename*"]?n=e["filename*"].replace(/^utf-8''/,""):e.filename&&(n=e.filename.slice(1,-1));return n&&decodeURIComponent(n.replace(/\+/g," "))}(o.getResponseHeader("Content-Disposition"))||"file";try{t=new File([o.response],n,{type:"application/octet-stream"})}catch(e){(t=new Blob([o.response],{type:"application/octet-stream"})).name=n,t.lastModifiedDate=new Date}e(t)},o.open("GET",t,!0),o.send()}))})).then((function(e){return i()?Promise.reject(at()):(r._downloading.delete(t),s(Ri,{file:e}),e)})).catch((function(e){return ct(e)||s(Li,{error:e}),r._downloading.delete(t),Promise.reject(e)}));return this._downloading.set(t,o),o},t.prototype.remove=function(t){this._store.dispatch({type:Pi,fileId:t})},t.prototype.getUrl=function(t,e,n){return this._api.request(88,{fileId:t,chatId:e,messageId:n}).then((function(t){var e=t&&t.url;return e?e.replace(/^http:/,"https:"):null}))},t.prototype.markAsLocal=function(t){this._store.dispatch({type:Ni,key:t})},t}();var kc=function(t){function e(e,n){var r,s,i=t.call(this,n,"GROUP")||this;i._store=e;var o=null===(s=null===(r=i._store.getState())||void 0===r?void 0:r.config)||void 0===s?void 0:s.server;return o&&o["moderated-groups"]&&i._api.on(149,(function(t){return i.handleModeratedGroupsNotif(t.counters)})),i}return g(e,t),e.prototype.destroy=function(){this._api.off(149,this.handleModeratedGroupsNotif)},e.prototype.save=function(t){this._store.dispatch({type:ji,list:t})},e.prototype.setModeratedList=function(t){this._store.dispatch({type:Hi,list:t})},e.prototype.fetchMissing=function(t){var e=this._store.getState().groups,n=Array.from(new i(t.filter((function(t){return!e.has(t)}))));return n.length?this.fetch(n):Promise.resolve([])},e.prototype.get=function(t){return this._store.getState().groups.get(t)},e.prototype.fetchModeratedGroupsList=function(){var t,e,n=this,r=null===(e=null===(t=this._store.getState())||void 0===t?void 0:t.config)||void 0===e?void 0:e.server;r&&r["moderated-groups"]&&this._api.request(123,{filter:"NONE"}).then((function(t){var e;if(null===(e=t)||void 0===e?void 0:e.groups){var r=new s;t.groups.forEach((function(e,n){r.set(e.id,t.msgCounts[n])})),n.save(t.groups),n.setModeratedList(t.groups.map((function(t){return t.id}))),n.setGroupCounters(r)}}))},e.prototype.setGroupCounters=function(t){this._store.dispatch({type:Vi,data:t})},e.prototype.handleModeratedGroupsNotif=function(t){var e=this;if(!(t instanceof s)){var n=new s;Object.keys(t).forEach((function(e){n.set(Number(e),Number(t[e]))})),t=n}var r=Object.keys(t).map((function(t){return Number(t)}));this.fetchMissing(r).then((function(t){t.length&&e.setModeratedList(r)})),this.setGroupCounters(t)},e}(Ea),Ec=/<meta\s+property="(og:video(?::secure_url)?)"\s+content="(.+?)"/gi;var Sc=function(){function t(t,e){this._store=t,this._api=e}return t.prototype.getVideoUrlData=function(t,e,n,r){var s=this,i={videoId:n};return this._store.getState().config.server["video-params"]&&t&&e?(i.chatId=t,i.messageId=e):i.token=r,this._api.request(83,i).then((function(t){var e,n=t&&t.EXTERNAL;return n&&/^https?:\/\/(?:www\.)instagram\.com\//.test(t.EXTERNAL)?(e=n,fetch(e.replace(/^http:/,"https:")).then((function(t){return t.text()})).then((function(t){for(var e={},n=Ec.exec(t);n;)e[n[1]]=n[2],n=Ec.exec(t);var r=e["og:video:secure_url"]||e["og:secure_url"];if(r)return{MP4_1:r}})).catch((function(t){console.warn("Error fetching Instagram video:",t)}))).then((function(e){return e&&Object.assign(t,e),t})):t})).then((function(i){return s._store.dispatch(function(t,e,n,r,s){return{type:vr,chatId:t,messageId:e,videoId:n,token:r,urlData:s}}(t,e,n,r||"",i)),i}))},t.prototype.getMusicUrl=function(t,e,n,r){return m(this,void 0,void 0,(function(){var s;return y(this,(function(i){switch(i.label){case 0:return[4,this._api.request(84,{trackId:n,context:r})];case 1:return s=i.sent(),this._store.dispatch(function(t,e,n,r){return{type:mr,chatId:t,messageId:e,trackId:n,url:r}}(t,e,n,s.url)),[2,s.url]}}))}))},t}(),wc=function(){function t(t,e){this.store=t,this.api=e,this.hidpi=!!this.store.getState().hidpi,this.contactsService=new Sa(this.store,this.api)}return t.prototype.leftColAdditionalInfo=function(){var t=this;return sc("messages/leftcol/additional",{hidpi:!0}).then((function(e){var n,r;if(null===(r=null===(n=e)||void 0===n?void 0:n.randomCongrats)||void 0===r?void 0:r.friendIds){var s=e.randomCongrats;t.contactsService.fetch(s.friendIds).then((function(t){return s.friends=t})).then((function(){t.store.dispatch({type:Wi,data:e})}))}else t.store.dispatch({type:Wi,data:e})}))},t.prototype.onboardingAdditionalInfo=function(){var t=this;return sc("messages/onboarding/additional",{hidpi:this.hidpi}).then((function(e){var n;if(null===(n=e)||void 0===n?void 0:n.promptedUsers){var r=Object.keys(e.promptedUsers).map((function(t){return parseInt(t,10)}));return Promise.all([t.contactsService.fetch(r),t.contactsService.updatePresence(r)]).then((function(t){var n=t[0],r=t[1];return e.friends=n.filter((function(t){return!t.deleted})).map((function(t){return v(v({},t),{presence:r[t.id]})})),e}))}return Promise.resolve(e)})).then((function(e){t.fetchChatsPro(e).then((function(n){t.store.dispatch({type:zi,data:v({chatsPro:n},e)})}))}))},t.prototype.fetchChatsPro=function(t){var e,n,r=this,s=(null===(e=this.store.getState().config)||void 0===e?void 0:e.server)||{},i=Boolean(Object.keys((null===(n=t)||void 0===n?void 0:n.promptedUsers)||{}).length),o=((s["pro-chats-novice-enabled"]&&!i||s["pro-chats-enabled"])&&s&&s["pro-chats-urls"]||[]).map((function(t){return(t||"").trim()})).filter((function(t){return t.length})).map((function(t){return r.fetchChatByLink(t)}));return Promise.all(o).then((function(t){var e=[];return(t||[]).forEach((function(t){var n=t&&t.chat;n&&!_e(n,r._getCurrentUser())&&e.push(n)})),e}))},t.prototype.resolveChatId=function(t){return t>0?tt(t,this._getCurrentUser()):t},t.prototype.addFriend=function(t){return sc("messages/user/addfriend",{id:t})},t.prototype.blockUser=function(t,e){return sc("messages/user/block",{id:t,groupId:e}).then((function(t){var e,n=null===(e=t)||void 0===e?void 0:e.error;if(n)throw ls(n.key,n.message)}))},t.prototype.unblockUser=function(t){return sc("messages/user/unblock",{id:t})},t.prototype.addToGifs=function(t){return sc("messages/add/gif",t)},t.prototype.complain=function(t){return sc("messages/user/complain",t)},t.prototype.fetchChatByLink=function(t){return this.api.request(48,{link:t}).catch((function(){return Promise.resolve()}))},t.prototype._getCurrentUser=function(){var t=this.store.getState().auth;return t&&t.profile&&t.profile.id||0},t}();function Cc(t,e,n){return function(t,e){return new Promise((function(n,r){var s=t.config&&t.config.chats,o=[];if(s){var a=new i;t.chats&&t.chats.forEach((function(t){return a.add(t.id)})),Object.keys(s).forEach((function(t){s[t].favIndex&&!a.has(Number(t))&&o.push(Number(t))}))}if(!o.length)return n(t);e.chat.loadChatInfo(o).then((function(e){t.chats=e.chats.concat(t.chats),n(t)})).catch(r)}))}(n,e).then((function(){var r,o=t.getState(),a=function(t,e){var n=t.profile,r=[],s=new i;t.contacts&&t.contacts.forEach((function(t){s.add(t.id),t.id!==n.id&&(t.own="REMOVED"!==t.status,r.push(t))}));t.presence&&Object.keys(t.presence).forEach((function(t){var n=Number(t);if(!(s.has(n)||e&&e.has(n))){var i=Qe(n);i.own=!0,r.push(i)}}));return n.current=!0,r}(n,o.contacts),c=new i(a.map(Mc)),u=o.contacts||new s,d=Ta(n.chats),h=function(t,e){var n=e.chats.find((function(e){var n=cc(t,e.id);return n&&n.selected})),r=n&&cc(t,n.id);if(n&&r&&n.lastMessage&&(!r.lastMessage||r.lastMessage.id!==n.lastMessage.id))return n.id;return null}(t,n),f=Array.from(d.contacts).filter((function(t){return!c.has(t)&&!u.has(t)}));t.dispatch((r=v(v({},n),{profile:n.profile.id,contacts:a,contactStubs:f}),v({type:T},r)));var l=Ra(d,e);return h&&e.chat.fetchMessages(h),n.hasModeratedGroups&&e.groups.fetchModeratedGroupsList(),e.chat.resolveMentions(n.chats),l}))}function Mc(t){return t.id}var bc=function(t){function e(e,n,r,s,i){var o=t.call(this)||this;return o.store=e,o.stream=n,o.stats=r,o.userAgent=s,o.deviceId=i,o.state="init",o.transactionId=0,o.loginAttempt=0,o.maxLoginAttempts=3,n.on("connect",(function(){o.state="start",o.emit("authStart"),o.authorize().then((function(t){var e=t.resp,n=t.req;o.state="success",o.emit("authorize",e,n)})).catch((function(t){Tc(t)||(o.state="fail",t&&(o.stats.action("AUTH_ERROR",t.code||t.message||"unknown"),o.stats.log.error("[auth] "+t.message,t.code)),o.emit("authFail",t))}))})),n.on("disconnect",(function(){o.state="deauthorized",o.cancelAuthRequests(),o.emit("deauthorize")})),o}return g(e,t),e.prototype.getSessionToken=function(t){var e=this;return void 0===t&&(t=0),this.getCredentials().catch((function(){if(t>0)return new Promise((function(n,r){setTimeout((function(){e.getSessionToken(t-1).then(n,r)}),1e3)}));throw e.error("Превышено количество попыток на получение данных о сессии","credentials-max-retries")}))},e.prototype.getLoginToken=function(t){var e=this;return this.state="confirm",this.stream.request(23,{token:t,tokenType:"OKWEB",deviceType:this.userAgent.deviceType,deviceId:this.deviceId}).catch((function(t){if(t&&"verify.token"===t.code)throw e.error("Ошибка верификации токена","login-token-verify");if(Tc(t))throw t;var n="";throw t&&(n+=t.message||"",t.code&&(n+=" ["+t.code+"]")),e.error("Неизвестная ошибка получения логин токена: "+n,"login-token-unknown")})).then((function(t){if(!t||!t.token)throw e.error("Отсутствует токен для логина","login-token-empty");if("RECOVERY"===t.tokenType)throw e.error("Требуется подтверждение входа через 2ФА","login-token-recovery");return t.token}))},e.prototype.authorize=function(){var t=this;this.cancelAuthRequests();var e=this.store.getState();if(e.auth&&e.auth.token)return this.login(e.auth.token).catch((function(e){if(!Tc(e))return t.stats.log.error("[auth] login error",e?e.code+"\n"+e.stack:""),t.stats.action("AUTH_ERROR","BAD_LOGIN_TOKEN"),t.store.dispatch({type:dn}),t.authorize().then((function(e){return t.stats.action("AUTH_ERROR","BAD_LOGIN_TOKEN_RECOVER_OK"),e})).catch((function(e){return t.stats.action("AUTH_ERROR","BAD_LOGIN_TOKEN_RECOVER_FAIL"),Promise.reject(e)}));throw e}));var n=++this.transactionId;return this.getSessionToken(5).then((function(e){return t.validateTransaction(n),t.getLoginToken(e)})).then((function(e){return t.validateTransaction(n),t.login(e)}))},e.prototype.start=function(){this.emit("start")},e.prototype.getCredentials=function(){var t=this;return this.state="credentials",sc("messages/credentials").catch((function(e){if(e&&e.code){if("number"==typeof e.code||"000"===e.code)throw t.error("Неожиданный код ответа от сервера: "+e.code,"credentials-invalid-http");if("invalid-json"===e.code)throw t.error("Невалидный JSON","credentials-invalid-json")}throw t.error("Неизвестная ошибка получения сессии")})).then((function(e){var n;if(!e)throw t.error("Отсутствуют данные о сессии","credentials-empty");var r="token"in e?e.token:null===(n=e.result)||void 0===n?void 0:n.token;if(!r)throw t.error("Отсутствует токен сессии","credentials-empty-token");return r}))},e.prototype.login=function(t){var e=this;this.state="login";var n=!1,r=v({token:t,chatsCount:20,userAgent:this.userAgent,log:!1},rc(this.store.getState())),s=function(){return r.log=e.loginAttempt>1,r},i=function(){return e.stream.request(19,s())};return this.loginAttempt++,(this.loginAttempt<this.maxLoginAttempts?Promise.race([i(),new Promise((function(t,r){e.loginTimer=setTimeout((function(){n||(e.emit("retry",e.loginAttempt),e.cancelAuthRequests(),e.stream.reopen(),r(e.error("Сброс авторизации","cancel")))}),2e4)}))]):i()).then((function(s){return e.loginAttempt=0,n=!0,clearTimeout(e.loginTimer),s.token=s.token||t,e.store.dispatch(v({type:cn},s)),{resp:s,req:r}})).catch((function(t){throw!t||"proto.state"!==t.code&&"proto.payload"!==t.code||e.stats.log.error("MSG_LOGIN_ERROR","Error code: "+t.code+"\n"+JSON.stringify(s(),null,2)),t}))},e.prototype.cancelAuthRequests=function(){clearTimeout(this.loginTimer),this.stream.cancel((function(t){return 23===t.command||19===t.command}),"cancel")},e.prototype.error=function(t,e){var n=new Error(t);return n.code=e,"cancel"!==e&&this.emit("error",n),n},e.prototype.validateTransaction=function(t){if(t!==this.transactionId)throw this.error("Отмена авторизации","cancel");return!0},e}(Ma);function Tc(t){return t&&("cancel"===t.code||"ECANCEL"===t.code)}var Oc=function(t){function e(e,n){var r=this;return r=t.call(this,e,n,(function(){var t=e.getState(),n=r._chatId,i="BLOCKED_MEMBER"===r._type?"blockedParticipantsSearch":"participantsSearch";return t.peekChat&&t.peekChat.id===n?["peekChat",i]:t.chats instanceof s&&t.chats.has(n)?["chats",n,i]:["participants"]}),{request:function(t,e,n){var s=r._chatId,i=r._type;return t.request(59,{chatId:s,type:i,query:e,count:100,marker:n.marker}).then((function(t){var e=[];return t.members&&t.members.forEach((function(t){e.push(v(v({},t.contact),{name:t.contact.names[0].name,presence:t.presence}))})),{type:i,members:e}}))}})||this,r}return g(e,t),e.prototype.query=function(e,n,r){return this._chatId=n,this._type=r,t.prototype.query.call(this,e)},e}(tc),Ac=new s,Rc={type:"MEMBER",count:100},Pc=function(){function t(t,e){this._store=t,this._api=e,this._search=new Oc(t,e)}return t.prototype.add=function(t,e,n){var r=this;return this._dispatch(t,En,{userIds:e}),this._update({chatId:t,userIds:e,type:"MEMBER",showHistory:n}).catch((function(n){throw e.forEach((function(e){return r._dispatch(t,Sn,{userId:e})})),n}))},t.prototype.remove=function(t,e,n){return this._dispatch(t,Sn,{userId:e}),this._update({chatId:t,userIds:[e],type:"MEMBER",operation:"remove",cleanMsgPeriod:n})},t.prototype.block=function(t,e,n){return this._dispatch(t,wn,{userId:e}),this._update({chatId:t,userIds:[e],type:"BLOCKED_MEMBER",cleanMsgPeriod:n})},t.prototype.unblock=function(t,e){return this._dispatch(t,Cn,{userId:e}),this._update({chatId:t,userIds:[e],type:"BLOCKED_MEMBER",operation:"remove"})},t.prototype.manageAdmins=function(t,e,n){var r=this;return n||(n=Q(X)),n.manageAdmins&&(n=Q(127)),this._dispatch(t,Mn,{userIds:e,permissions:n}),this._update({chatId:t,userIds:e,type:"ADMIN",permissions:$(n)}).catch((function(n){throw e.forEach((function(e){return r._dispatch(t,bn,{userId:e})})),n}))},t.prototype.removeAdmin=function(t,e){return this._dispatch(t,bn,{userId:e}),this._update({chatId:t,userIds:[e],type:"ADMIN",operation:"remove"})},t.prototype.loadBlocked=function(t){var e,n=cc(this._store,t),r=n&&n.blockedParticipants;return n?n.blockedParticipantsSearch?this._search.loadNext():Nc(r)?this._request(t,{type:"BLOCKED_MEMBER",marker:null===(e=r)||void 0===e?void 0:e.marker,branch:"blockedParticipants"}):Promise.resolve():Promise.resolve()},t.prototype.loadAllMembers=function(t){var e=this,n=cc(this._store,t);if(!Lc(n))return Promise.resolve();if(Ac.has(t))return Ac.get(t);var r=new Promise((function(r,s){var i=function(o){var a;if(o&&!o.marker)Ac.delete(t),r();else{var c=(null===(a=o)||void 0===a?void 0:a.marker)||Dc(n);e._request(t,{type:"MEMBER",marker:c,branch:"members",count:100}).then(i).catch((function(e){Ac.delete(t),s(e)}))}};i()}));return Ac.set(t,r),r},t.prototype.loadMembers=function(t){var e=cc(this._store,t);return e.participantsSearch?this._search.loadNext():Lc(e)?this._request(t,{type:"MEMBER",marker:Dc(e),branch:"members"}):(this._dispatch(t,On,{branch:"members",members:[]}),Promise.resolve())},t.prototype.search=function(t,e,n){void 0===n&&(n="MEMBER"),this._search.query(e,t,n)},t.prototype.reset=function(t){this._search.reset(),this._dispatch(t,An)},t.prototype._request=function(t,e){var n=this,r=(e=v(v({},Rc),e)).branch;return this._dispatch(t,Tn,{loadState:Rn.loading,branch:r}),this._api.request(59,v({chatId:t},e)).then((function(e){return n._dispatch(t,On,v({branch:r},e)),e}))},t.prototype._update=function(t){var e=this,n=v({operation:"add",showHistory:!0},t);return this._api.request(77,n).then((function(t){return e._store.dispatch(Ur(t.chat)),t}))},t.prototype._dispatch=function(t,e,n){void 0===n&&(n={}),this._store.dispatch(v({type:e,chatId:t},n))},t}();function Lc(t){return!!t&&Boolean("CHANNEL"===t.type&&Nc(t.members)||"CHAT"===t.type&&t.participantsCount>t.participants.length&&Nc(t.members))}function Nc(t){return!t||t.loadState===Rn.idle&&!!t.items&&!!t.items.length&&!!t.marker}function Dc(t){return t&&t.members?t.members.marker:t&&t.participantsMarker}var Uc=function(){function t(t){this.ttl=t,this.values={},this.dates={}}return t.prototype.has=function(t){if(t in this.dates){if(this.dates[t]+this.ttl>=Date.now())return!0;this.delete(t)}return!1},t.prototype.get=function(t){return this.has(t)?this.values[t]:void 0},t.prototype.set=function(t,e){return this.dates[t]=Date.now(),this.values[t]=e,this},t.prototype.delete=function(t){delete this.dates[t],delete this.values[t]},t}();function xc(){return 32767===jc.globalId&&(jc.globalId=0),++jc.globalId}var jc=function(){function t(t,e,n,r){var s=this;void 0===n&&(n=0),void 0===r&&(r=!1),this.command=t,this.data=e,this.cmd=n,this.notif=r,this.id=xc(),this._completed=!1,this.promise=new Promise((function(t,e){s.completed?s.status.success?t(s.status.value):e(s.status.value):(s._resolve=t,s._reject=e)}))}return Object.defineProperty(t.prototype,"completed",{get:function(){return this._completed},enumerable:!0,configurable:!0}),Object.defineProperty(t.prototype,"requestTime",{get:function(){return Date.now()-this.startTime},enumerable:!0,configurable:!0}),t.prototype.saveStartTime=function(){this.startTime=Date.now()},t.prototype.payload=function(){var t={ver:10,cmd:this.cmd,seq:this.id,opcode:this.command};return null!=this.data&&(t.payload=this.data),JSON.stringify(t)},t.prototype.resolve=function(t){return this.completed||(this.status={success:!0,value:t},this._completed=!0,this._resolve&&this._resolve(t)),this},t.prototype.reject=function(t){return this.completed||(this.status={success:!1,value:t},this._completed=!0,this._reject&&this._reject(t)),this},t.prototype.cancel=function(t,e){this.reject(it(t||"ECANCEL",e||"Request cancelled"))},t.prototype.getStatus=function(){return this.status},t.globalId=0,t}(),qc=function(){function t(t,e,n){this.stream=t,this.stats=e,this.queue=[],this.options=v({maxReties:10},n)}return t.prototype.send=function(t){var e=new jc(64,t);return this.queue.push(e),1===this.queue.length&&this.next(),e.promise},t.prototype.failAll=function(t){void 0===t&&(t=it("service.unavailable","Request failed by message sender")),this.debug("Fail all requests, amount: "+this.queue.length);var e=this.queue.slice();this.queue.length=0,e.forEach((function(e){return e.reject(t)}))},t.prototype.cancel=function(t){var e=this;this.queue.forEach((function(n){t(n)&&(e.debug("Cancel request",n),n.cancel())}))},t.prototype._send=function(t){var e=this,n=0,r=function(){return t.completed?(e.debug("Request aborted",t,n),t.promise):e.stream.request(t.command,t.data,t.cmd).catch((function(s){if(s&&"service.unavailable"===s.code&&n<e.options.maxReties)return t.cmd=2,n++,e.debug("Retry message send",t,n),st(function(t,e){return 1e3*(Math.pow(2,Math.min(t,e))+Math.random())}(n,4)).then(r);throw s}))};r().then((function(r){e.remove(t),t.resolve(r),n>0&&e.debug("Message delivered",t,n),e.next()})).catch((function(n){n&&"service.unavailable"===n.code?e.failAll():(e.remove(t),t.reject(n),e.next())}))},t.prototype.next=function(){this.queue.length&&this._send(this.queue[0])},t.prototype.remove=function(t){var e=this.queue.indexOf(t);-1!==e&&this.queue.splice(e,1)},t.prototype.debug=function(t,e,n){if(e){var r=e.data||{};t+="\nchat="+r.chatId+", cid="+(r.message&&r.message.cid)}return n&&(t+=", attempt="+n),this.log(t)},t.prototype.log=function(t){this.stats.log.error("MSG_SENDER",t)},t}(),Fc=["STICKER","FILE","PHOTO","VIDEO"],Hc=function(t){function e(e,n,r){var o=t.call(this)||this;return o._store=e,o._api=n,o._stats=r,o.file=new ba(e,n),o._sendingMessages=new s,o._processingFiles=new s,o._pendingSharePreviews=new i,o._mentionsCache=new Uc(3e4),o._msgSender=new qc(n,r),o._chatNotificationType=new s,o._notifyTyping=Z((function(t){var e=o._chatNotificationType.get(t),n=o._store.getState().chats.get(t),r=o.getPostingForm(t);e&&o._api.flowing&&(n&&r||Fc.includes(e))&&o._api.send(65,{chatId:t,type:e},{notif:!0})}),3e3,{leading:!0}),o._api.on(136,(function(t){o._updateUploadedFileState(x(t),v(v({},t),{processed:!0}))})),o}return g(e,t),Object.defineProperty(e.prototype,"senderId",{get:function(){return this._store.getState().auth.profile.id},enumerable:!0,configurable:!0}),e.prototype.getPostingForm=function(t){return this._store.getState().posting.get(t)},e.prototype.getMaxLength=function(){var t=this._store.getState(),e=t.config&&t.config.server&&t.config.server["max-msg-length"];return Math.round(.95*(e||4e3))},e.prototype.update=function(t,e,n){var r=this.getPostingForm(t);this._store.dispatch({type:Es,chatId:t,actions:e});var s=this.getPostingForm(t),i=r&&r.urls,o=s&&s.urls;if(o&&o!==i&&s&&"EDIT"!==s.type&&this.updateUrlShares(t),!n){var a=r&&r.text,c=s&&s.text,u=r&&r.voiceMessage&&r.voiceMessage.recording,d=s&&s.voiceMessage&&s.voiceMessage.recording;a!==c&&c?this.notifyTyping(t,"TEXT"):u!==d&&d?this.notifyTyping(t,"AUDIO",!0):u&&!d&&(this._chatNotificationType.delete(t),clearTimeout(this._notifyTimer))}r&&r.preview&&this.addPreview(t),this._updateChunksCount(t)},e.prototype.startTyping=function(t,e){this._isTypingTypeEnabled(e)&&this.notifyTyping(t,e,!0)},e.prototype.stopTyping=function(t){this._chatNotificationType.delete(t),clearTimeout(this._notifyTimer)},e.prototype.reset=function(t){this._store.dispatch({type:Ss,chatId:t})},e.prototype.resetLink=function(t){this.update(t,{resetLink:!0})},e.prototype.replyMessage=function(t,e){this.update(t,{reply:e})},e.prototype.editMessage=function(t,e){this.update(t,{edit:e})},e.prototype.voiceMessageUpdate=function(t,e){this.update(t,{voiceMessage:e})},e.prototype.voiceMessageReset=function(t){this.update(t,{voiceMessage:null})},e.prototype.addFiles=function(t,e,n){var r=this;n=n||{};var s=function(t){var e=t.config,n={};return e&&e.server&&Object.keys(e.server).forEach((function(t){var r=t.match(/^file-upload-(.+)$/);r&&(n[r[1]]=e.server[t])})),n}(this._store.getState());n.type&&"guess"!==n.type&&new i(e.map((function(t){return lt(t)}))).forEach((function(e){return r.notifyTyping(t,e,!1)}));if("file"===n.type){if(!s.enabled)return this.addFiles(t,e,v(v({},n),{type:"media"}));(function(t,e){var n=e["max-size"],r=e["unsupported-types"];return t.forEach((function(t){if(n&&t.size>n)throw(s=ls("file-upload-max-size-error","Размер файла "+t.name+" превышает допустимые "+n+" байт")).file=t,s.maxSize=n,s;var e,s,i=(e=t.name).slice(2+(e.lastIndexOf(".")-1>>>0));if(r&&r.includes(i))throw(s=ls("file-upload-unsupported-types-error","В целях безопасности загрузка файлов с расширением ."+i+" не поддерживается")).file=t,s.unsupportedTypes=r,s})),!0})(e,s)&&this._sendFiles(t,e)}else"media"===n.type?this.attachFiles(t,e.filter(Zr),n.autoUpload):"gif"===n.type?this._sendGif(t,e[0]):this.addFiles(t,e,v(v({},n),{type:e.every(Zr)?"media":"file"}))},e.prototype.replaceFile=function(t,e,n,r){this.update(t,{replaceAttach:{from:e,to:n}}),r&&this._upload(t)},e.prototype.removeFile=function(t,e){var n=this;this.update(t,{removeAttach:e}),this.stopTyping(t),this._processingFiles.forEach((function(r,s){r.chatId===t&&r.file===e&&n._processingFiles.delete(s)})),this._sendPendingMessages(t)},e.prototype.selectShare=function(t,e){return this.update(t,{selectShare:e})},e.prototype.removeShares=function(t){return this.update(t,{disableShares:!0})},e.prototype.addPreview=function(t){var e=cc(this._store,t),n=this.getPostingForm(t);if(e&&n){var r=this.getMessagesFromPosting(t,n).map((function(t){return"CHANNEL"!==e.type||e.options.SIGN_ADMIN?e.participants&&(t.sender=e.participants.find((function(t){return t.user.current})).user):t.sender={name:e.title},t.isMine="CHANNEL"!==e.type&&"CHANNEL_ADMIN"!==e.type,t.preview=!0,t}));this._store.dispatch({type:ws,chatId:t,messages:r})}},e.prototype.resetPreview=function(t){this._store.dispatch({type:ws,chatId:t})},e.prototype.updateForward=function(t,e){this._store.dispatch({type:Es,chatId:t,actions:{forward:e}})},e.prototype.commit=function(t,e){var n=this,r=this.getPostingForm(t),s=this._store.getState().config;if(!r)return Promise.reject(ls("error.no.posting","У чата "+t+" отсутствует отправляемое сообщение"));if(cs(r)||us(r,s))return Promise.reject(ls("error.empty.posting","У чата "+t+" пустое сообщение"));if("EDIT"===r.type){if(r.link&&r.link.id)return this._editMessage(t,r);this._store.dispatch({type:or,chatId:t,messageIds:[r.link.id]}),delete(r=v(v({},r),{type:"NEW"})).link}var i=function(t,e){var n,r,s=[];if(null===(n=e)||void 0===n?void 0:n.length){var i=Date.now();e.forEach((function(e,n){var r=v(v({},t),{cid:i++,text:e.text,messageElements:e.elements,upload:e.upload,shares:void 0});0!==n&&(r.type="NEW",r.attaches=r.urls=r.link=void 0),s.push(r)}))}else s.push(t);var o=ns(t.shares);if(o){var a=function(t){var e;return"LINK"===t.type&&(null===(e=t.attributes)||void 0===e?void 0:e.url)===o.url};s.some((function(e){return!(!e.messageElements||!e.messageElements.some(a)||(e.shares=t.shares,0))}))||(s[0].shares=t.shares)}else(null===(r=t.shares)||void 0===r?void 0:r.disabled)&&s.forEach((function(t){t.shares={disabled:!0,items:[],selected:-1}}));return s}(r,e);return Promise.all(i.map((function(e){return n.commitPostingForm(t,e)})))},e.prototype.sendLocation=function(t,e,n,r){void 0===r&&(r=15);var s=function(t,e,n,r){return void 0===r&&(r=15),ms(t,{attaches:[{latitude:n,longitude:e,zoom:r,_type:"LOCATION"}],cid:Date.now()})}(t,e,n,r);return this.commitPostingForm(t,s,!0)},e.prototype.sendSticker=function(t,e){var n=this.getPostingForm(t),r=this._store.getState(),s=function(t,e,n){var r=[v(v({},e),{_type:"STICKER"})],s=v({},n);return delete s.text,delete s.upload,delete s.shares,n&&"EDIT"===n.type&&(delete s.link,s.type="NEW"),s.attaches=r,ms(t,s)}(t,v(v({},r.stickers.get(e.stickerId||e.id)),e),n);return s&&"REPLY"===s.type&&this.resetLink(t),this.commitPostingForm(t,s,!0)},e.prototype.sendUserSticker=function(t,e){var n=this;return this.file.issueUrl("STICKER").then((function(r){return n.file.uploadWithReties(r.url,e,5,(function(r,s){var i,o;i=Br.PROGRESS,o={progress:{loaded:r,total:s}},n._store.dispatch(v({type:i,chatId:t,file:e},o))})).then((function(t){return n._api.request(193,{token:t[0].token})})).then((function(e){n.sendSticker(t,v({stickerId:e.sticker.id},e.sticker))}))}))},e.prototype.sendCommand=function(t,e){var n=Date.now();return this.commitPostingForm(t,ms(t,{text:e,cid:n}),!0)},e.prototype.getMessagesFromPosting=function(t,e){var n=this,r=cc(this._store,t);return e=e||this.getPostingForm(t),r&&e?function(t,e){if(!t.upload||t.upload.size<e)return[t];var n=es(t.upload,e),r=Date.now();return n.map((function(e,n){var s=v(v({},t),{cid:r+n,upload:e});return n>0&&(delete s.text,delete s.link),s}))}(e,10).map((function(t){var e=vs(r,t,n.senderId);if(e)return e})).filter(Boolean):[]},e.prototype.sendContact=function(t,e,n){var r=function(t,e,n){return ms(t,{cid:n,attaches:[{_type:"CONTACT",contactId:e,user:e}]})}(t,e,n);return this.commitPostingForm(t,r,!0)},e.prototype.sendChannelLink=function(t,e,n){return this.commitPostingForm(t,ms(t,{cid:n,text:e}),!0)},e.prototype.sendAttach=function(t,e){var n=ms(t,{attaches:e,cid:Date.now()});return this.commitPostingForm(t,n,!0)},e.prototype.forwardMessage=function(t,e,n,r){var s=cc(this._store,e);return s?(n="string"==typeof n?ie(s,n):n,this.commitPostingForm(t,ms(t,{cid:r,link:{type:"FORWARD",chatId:e,chatIconUrl:s.iconUrl,chatName:s.title||s.placeholder,message:n}}),!0)):Promise.reject()},e.prototype.notifyTyping=function(t,e,n){e&&(this._chatNotificationType.set(t,e),"TEXT"!==e&&this._stats.action("ATTACH_"+e),n&&!this._notifyTimer&&(clearTimeout(this._notifyTimer),this.notifyLoop(t))),this._notifyTyping(t)},e.prototype.notifyLoop=function(t){var e=this;this._notifyTimer=window.setTimeout((function(){e._chatNotificationType.get(t)&&(e._notifyTyping(t),e.notifyLoop(t))}),3e3)},e.prototype.updateUrlShares=function(t){var e=this;if(!this._pendingSharePreviews.has(t)){var n=this.getPostingForm(t);n&&n.urls&&n.urls.length&&(this._pendingSharePreviews.add(t),this._getUrlPreviews(n.urls,t).then((function(r){e._pendingSharePreviews.delete(t);var s=e.getPostingForm(t);if(s&&s.urls&&s.urls.length)if(ot(s.urls,n.urls)){var i=r.attachments;i&&(i=i.filter((function(t){return!t.deleted}))),e.update(t,{setShares:i})}else e.updateUrlShares(t)})).catch((function(n){e._pendingSharePreviews.delete(t),console.warn(n)})))}},e.prototype.cancelMessageSend=function(t,e){var n=function(n){return!!n&&64===n.command&&!!n.data&&n.data.chatId===t&&n.data.message.cid===e};this._api.cancel(n),this._msgSender.cancel(n),this._store.dispatch(function(t,e){return{type:sr,chatId:t,messageCid:e}}(t,e));var r=this._sendingMessages.get(e);r&&(r.reject(at()),this._sendingMessages.delete(e))},e.prototype.commitPostingForm=function(t,e,n){var r=this,s=cc(this._store,t),i=vs(s,e,this.senderId);return i&&s?(s&&i.elements&&(i.elements=this._prepareMessageMentions(i.elements,s)),this._store.dispatch(Fr(t,i,n)),this.emit("commit",i,t),new Promise((function(e,n){r._sendingMessages.set(i.cid,{resolve:e,reject:n}),r._sendPendingMessages(t)}))):Promise.reject(ls("error.empty.message","Unable to create message from posting form"))},e.prototype.attachFiles=function(t,e,n){this.update(t,{addAttach:e}),n&&this._upload(t)},e.prototype.uploadFile=function(t,e,n,r){var s=this,i=ss(cc(this._store,t),r=r||this.getPostingForm(t)).find((function(t){return t.file===e}));if(!i)return Promise.reject(new Error("Отсутствует запись в модели для указанного файла"));if(i.promise)return i.promise;var o=function(r,i){return s._store.dispatch(v(v({type:r,chatId:t,file:e},i),{key:n.key}))},a=this._isTypingTypeEnabled(i._type),c=function(r,c){if(n.shouldAbort(e))return!1;a&&s.notifyTyping(t,i._type,!0),o(Br.PROGRESS,{progress:{loaded:r,total:c}})},u=this.file.issueUrl(i._type).then((function(r){return n.shouldAbort(e)?Promise.reject(at()):s.file.uploadWithReties(r.url,e,5,c).then((function(a){if(s.stopTyping(t),a&&"photos"in a)o(Br.COMPLETE,{payload:{token:a.photos[Object.keys(a.photos)[0]].token}}),s._sendPendingMessages(t);else{var c=Qr(i._type),u=r[c],d=Xr(i._type);s._updateUploadedFileState(u,{chatId:t,file:e,uploaded:!0,token:r[d],_type:i._type},n.key)}return a}))})).catch((function(e){return ct(e)?s._sendPendingMessages(t):o(Br.ERROR,{error:e}),Promise.reject(e)}));return o(Br.START,{promise:u}),u},e.prototype.splitChunks=function(t){var e=t.shares,n=[],r=this.getMaxLength(),s=rs(t.text,r);return s.length?s.forEach((function(r,s,i){var o,a=Date.now();o=s===i.length-1?v(v({},t),{cid:a+s,text:ds(r),shares:hs(e),detectShare:fs(t)}):v(v({},t),{cid:a+s,text:ds(r),upload:void 0,attaches:void 0,urls:void 0,shares:void 0,detectShare:void 0}),n.push(o)})):n.push(v(v({},t),{shares:hs(e),detectShare:fs(t)})),n},e.prototype.isMedia=function(t){return Zr(t)},e.prototype.sendButtonMessage=function(t,e){var n,r=cc(this._store,t),s=os(r),i={cid:e.cid,text:e.text,attaches:e.attaches,sender:this.senderId,time:Date.now(),elements:e.elements,type:s,link:e.link};"REPLY"===(null===(n=r.posting)||void 0===n?void 0:n.type)&&(i.link={type:"REPLY",messageId:r.posting.link.id}),i.posting={type:s,detectShare:Boolean(e.detectShare),attachMEL:Boolean(e.attachMEL)},r&&i.elements&&(i.elements=this._prepareMessageMentions(i.elements,r)),this._store.dispatch(Fr(t,i)),this._post(t,e.cid,{chatId:t,message:i})},e.prototype._isTypingTypeEnabled=function(t){var e,n=this._store.getState();return(null===(e=n.config)||void 0===e?void 0:e.server)&&n.config.server["typing-enabled-"+t]},e.prototype._getUrlPreviews=function(t,e){var n=this,r=[],s=t.map((function(t,e){if(/^@/.test(t)){var s=n._mentionsCache.get(t);return s||(r.push({url:t,ix:e}),null)}return t}));return r.length?Promise.all(r.map((function(t){return n._resolveMention(t.url.slice(1))}))).then((function(t){return t.forEach((function(t,e){var i=r[e];n._mentionsCache.set(i.url,t),s[i.ix]=t})),n._fetchUrlPreviews(s,e)})):this._fetchUrlPreviews(s,e)},e.prototype._fetchUrlPreviews=function(t,e){return this._api.request(70,{chatId:e,text:t.filter(Boolean).join("\n")})},e.prototype._sendFiles=function(t,e){var n=this;this._stats.action("file-attach_sent");var r=Date.now();return Promise.all(e.filter(Boolean).map((function(e){var s=ys(t,e,r);return r++,n.commitPostingForm(t,s,!0)})))},e.prototype._sendGif=function(t,e){var n=this;return this._stats.action("gif-attach_sent"),new Promise((function(){var r=n.getPostingForm(t),i=function(t,e,n){var r=Date.now(),i=(new s).set(e,{file:e,_type:"PHOTO",status:zr.idle}),o=ms(t,v(v({cid:r++},n),{upload:i}));return delete o.text,o}(t,e,r);return"REPLY"===i.type&&n.resetLink(t),n.commitPostingForm(t,i,!0)}))},e.prototype._resolveMention=function(t){return this._api.request(89,{link:t}).then((function(e){return e.chat||e.user?"https://tt.me/"+t:null})).catch((function(){return null}))},e.prototype._updateChunksCount=function(t){var e=this.getPostingForm(t);if(e){var n=1;if(e.upload&&e.upload.size>10&&(n=es(e.upload,10).length),e.text){var r=this.getMaxLength(),s=rs(e.text,r);s.length&&(n=n+s.length-1)}this._store.dispatch({type:Es,chatId:t,actions:{chunks:n}})}},e.prototype._upload=function(t){for(var e=this,n=ss(cc(this._store,t),this.getPostingForm(t)),r=n.filter((function(t){return t.status===zr.loading})),s=n.filter((function(t){return t.status===zr.idle})),i=!1,o=Math.max(0,3-r.length),a=function(){var n=s.shift().file,r={shouldAbort:function(){return!e._isPendingUpload(t,n)}};n instanceof Blob&&c.uploadFile(t,n,r),i=!0},c=this;o--&&s.length;)a();return i},e.prototype._sendPendingMessages=function(t){var e=this;this._upload(t),is(cc(this._store,t)).forEach((function(n){var r=e._sendingMessages.get(n.cid);if(!r||!r.request){var s=!!n.attaches&&!!n.attaches.some((function(t){return!!t.file&&t.status!==zr.completed})),i=n.attaches&&n.attaches[0],o=i&&"LOCATION"===i._type&&(!i.latitude||!i.longitude);o&&!n.locating&&e._tryLocate(t,n),s||o||e._sendMessage(t,n)}}))},e.prototype._sendMessage=function(t,e){var n=this;if(!e.posting&&"EDITED"!==e.status)return Promise.reject(new Error("Отсутствует поле posting у сообщения"));if("EDITED"===e.status)return this._sendEditedMessage(t,e);var r=v(v({},e.posting),{chatId:t,message:ps(e)});delete r.detectShare;var s=this._post(t,e.cid,r).then((function(t){var r=n._sendingMessages.get(e.cid);return r&&r.resolve&&r.resolve(t),n._sendingMessages.delete(e.cid),t})).catch((function(r){var s=n._sendingMessages.get(e.cid);return s&&s.reject&&s.reject(r),n._sendingMessages.delete(e.cid),r&&"string"==typeof r.code&&-1!==r.code.indexOf("chat.denied")&&n.logChatDenied(t,e,r),Promise.reject(r)})),i=this._sendingMessages.get(e.cid);return i?this._sendingMessages.set(e.cid,v(v({},i),{request:s})):this._sendingMessages.set(e.cid,{request:s}),s},e.prototype._editMessage=function(t,e){var n=cc(this._store,t);if(this.reset(t),!n)return Promise.reject("Чат уже удален");var r=vs(n,e,this.senderId);return r?(n&&r.elements&&(r.elements=this._prepareMessageMentions(r.elements,n)),this._store.dispatch(function(t,e){return{type:Jn,chatId:t,message:e}}(t,r)),this._sendPendingMessages(t),Promise.resolve({message:r})):Promise.reject("Пустая форма отправки сообщения")},e.prototype._sendEditedMessage=function(t,e){var n,r=this;this._sendingMessages.set(e.cid,e);var s=this._store.getState(),i=(null===(n=s.config)||void 0===n?void 0:n.server)&&s.config.server["editable-attachments"]?e.attaches&&e.attaches.map((function(t){return gs(t)})):null;return this._api.request(67,{chatId:t,messageId:e.id,text:e.text,elements:e.elements,attachments:i}).then((function(e){return e.message&&"EDITED"===e.message.status&&r._store.dispatch(function(t,e){return{type:Xn,chatId:t,message:e}}(t,e.message)),e})).finally((function(){r._store.dispatch(function(t,e){return{type:Yn,chatId:t,cid:e}}(t,e.cid))}))},e.prototype._post=function(t,e,n){var r=this,s=cc(this._store,t);return s?(this._stats.action(s.type+"_MSG_POST"),this._msgSender.send(n).then((function(e){return r._store.dispatch(function(t,e){return{type:rr,chatId:t,message:e}}(t,e.message)),r.emit("confirm",e),e})).catch((function(n){return r._store.dispatch(Hr(t,e,n)),Promise.reject(n)}))):Promise.reject()},e.prototype._tryLocate=function(t,e){var n=this;e.locating=!0;var r=e.attaches&&e.attaches[0];r&&navigator.geolocation.getCurrentPosition((function(e){r.longitude=e.coords.longitude,r.latitude=e.coords.latitude,r.zoom=15,n._sendPendingMessages(t)}),(function(r){var s={code:"locate.access",error:r};n._sendingMessages.get(e.cid).reject(s),n._store.dispatch(Hr(t,e.cid,s)),n._sendingMessages.delete(e.cid)}))},e.prototype._isPendingUpload=function(t,e){return ss(cc(this._store,t),this.getPostingForm(t)).some((function(t){return t.file===e&&t.status!==zr.completed}))},e.prototype._updateUploadedFileState=function(t,e,n){var r,s=null,i=v(v({},this._processingFiles.get(t)),e);if(i.chatId&&i.file){var o=((r={status:s=i.uploaded&&i.processed?zr.completed:zr.processing})[Qr(i._type)]=t,r);i.token&&(o[Xr(i._type)]=i.token),this._store.dispatch({type:Br.COMPLETE,chatId:i.chatId,file:i.file,key:n,payload:o})}s===zr.completed?(this._sendPendingMessages(i.chatId),this._processingFiles.delete(t)):this._processingFiles.set(t,i)},e.prototype.logChatDenied=function(t,e,n){var r,s=this._store.getState(),i=s.chats,o=s.chatList,a=i.get(t),c="ChatID: "+t+"\n";c+="Has chat in DB?: "+i.has(t)+"\n",c+="Has chat in list?: "+o.some((function(e){return e.id===t}))+"\n",c+="Message text: "+(e.text?e.text.slice(0,100)+" ("+e.text.length+")":"(none)")+"\n",(null===(r=e.attaches)||void 0===r?void 0:r.length)&&(c+="Message has "+e.attaches.map((function(t){return t._type})).join(", ")+" attaches\n"),a&&(c+="User is chat participant? "+a.participants.some((function(t){return t.user.current}))+"\n"),c+="Error code: "+n.code+"\n",c+="Error message: "+n.message+"\n",c+="JSON: "+JSON.stringify(e).slice(0,1024),this._stats.log.error("CHAT_DENIED",c)},e.prototype._prepareMessageMentions=function(t,e){var n;return(null===(n=t)||void 0===n?void 0:n.length)?function(t,e){var n,r,s=e.participants.map((function(t){return t.user.id})).concat((null===(r=null===(n=e.members)||void 0===n?void 0:n.items)||void 0===r?void 0:r.map((function(t){return t.id})))||[]);return t.filter((function(t){return"USER_MENTION"!==t.type||"USER_MENTION"===t.type&&t.entityId&&s.includes(t.entityId)}))}(t,e):t},e}(Ma),Vc=function(){function t(t,e,n){this._store=t,this._userAgent="["+e.deviceType+":"+e.appVersion+"] "+e.headerUserAgent,this._saveEvent=n}return t.prototype.error=function(t,e){this._log("ERROR",t,e)},t.prototype.warn=function(t,e){this._log("WARN",t,e)},t.prototype.info=function(t,e){this._log("INFO",t,e)},t.prototype.debug=function(t,e){this._log("DEBUG",t,e)},t.prototype._log=function(t,e,n){if(!e)throw new Error('Missing required "msg" argument');var r=this._getUserId(),s=this._userAgent;this._saveEvent({type:"LOG",event:t,params:{msg:e,details:n,userId:r,userAgent:s}})},t.prototype._getUserId=function(){var t=this._store.getState();if(t&&t.auth)return t.auth.profile?t.auth.profile.id:0},t}(),Gc=function(){function t(t,e,n){this._api=e,this._store=t,this._log=new Vc(t,n,this._saveEvent.bind(this)),this._queue=[]}return t.prototype.net=function(t,e,n){this._saveEvent({type:"NET",event:"0x"+t.toString(16),params:{respTime:e,tamTime:n}})},t.prototype.screen=function(t){this._saveEvent({type:"SCREEN",event:t})},t.prototype.action=function(t,e){this._saveEvent({type:"ACTION",event:t,params:{value:e}})},t.prototype.videoStats=function(t,e){var n=this._store.getState().call,r=n?n.id:void 0;this._saveEvent({type:"VIDEO_STATS",event:t,params:{cid:r,value:e}})},t.prototype.flush=function(){var t=this;if(!this._api.stopped&&this._queue.length){var e=this._queue.slice();this._api.request(5,{events:e}).then((function(){t._queue.length!==e.length?(t._queue=t._queue.slice(e.length),t._startFlushTimeout()):t._queue=[]})).catch((function(n){console.error("error while sending stats",e,n),t._startFlushTimeout()}))}},Object.defineProperty(t.prototype,"log",{get:function(){return this._log},enumerable:!0,configurable:!0}),t.prototype._saveEvent=function(t){t.time=Date.now(),this._queue.push(t),1===this._queue.length&&this._startFlushTimeout()},t.prototype._startFlushTimeout=function(){this._timerId&&window.clearTimeout(this._timerId),this._timerId=window.setTimeout(this.flush.bind(this),15e3)},t}();var Kc=function(t){var e,n=t.Symbol;return"function"==typeof n?n.observable?e=n.observable:(e=n("observable"),n.observable=e):e="@@observable",e}("undefined"!=typeof self?self:"undefined"!=typeof window?window:"undefined"!=typeof global?global:"undefined"!=typeof module?module:Function("return this")()),Bc=function(){return Math.random().toString(36).substring(7).split("").join(".")},zc={INIT:"@@redux/INIT"+Bc(),REPLACE:"@@redux/REPLACE"+Bc(),PROBE_UNKNOWN_ACTION:function(){return"@@redux/PROBE_UNKNOWN_ACTION"+Bc()}};function Wc(t,e,n){var r;if("function"==typeof e&&"function"==typeof n||"function"==typeof n&&"function"==typeof arguments[3])throw new Error("It looks like you are passing several store enhancers to createStore(). This is not supported. Instead, compose them together to a single function");if("function"==typeof e&&void 0===n&&(n=e,e=void 0),void 0!==n){if("function"!=typeof n)throw new Error("Expected the enhancer to be a function.");return n(Wc)(t,e)}if("function"!=typeof t)throw new Error("Expected the reducer to be a function.");var s=t,i=e,o=[],a=o,c=!1;function u(){a===o&&(a=o.slice())}function d(){if(c)throw new Error("You may not call store.getState() while the reducer is executing. The reducer has already received the state as an argument. Pass it down from the top reducer instead of reading it from the store.");return i}function h(t){if("function"!=typeof t)throw new Error("Expected the listener to be a function.");if(c)throw new Error("You may not call store.subscribe() while the reducer is executing. If you would like to be notified after the store has been updated, subscribe from a component and invoke store.getState() in the callback to access the latest state. See https://redux.js.org/api-reference/store#subscribe(listener) for more details.");var e=!0;return u(),a.push(t),function(){if(e){if(c)throw new Error("You may not unsubscribe from a store listener while the reducer is executing. See https://redux.js.org/api-reference/store#subscribe(listener) for more details.");e=!1,u();var n=a.indexOf(t);a.splice(n,1)}}}function f(t){if(!function(t){if("object"!=typeof t||null===t)return!1;for(var e=t;null!==Object.getPrototypeOf(e);)e=Object.getPrototypeOf(e);return Object.getPrototypeOf(t)===e}(t))throw new Error("Actions must be plain objects. Use custom middleware for async actions.");if(void 0===t.type)throw new Error('Actions may not have an undefined "type" property. Have you misspelled a constant?');if(c)throw new Error("Reducers may not dispatch actions.");try{c=!0,i=s(i,t)}finally{c=!1}for(var e=o=a,n=0;n<e.length;n++){(0,e[n])()}return t}return f({type:zc.INIT}),(r={dispatch:f,subscribe:h,getState:d,replaceReducer:function(t){if("function"!=typeof t)throw new Error("Expected the nextReducer to be a function.");s=t,f({type:zc.REPLACE})}})[Kc]=function(){var t,e=h;return(t={subscribe:function(t){if("object"!=typeof t||null===t)throw new TypeError("Expected the observer to be an object.");function n(){t.next&&t.next(d())}return n(),{unsubscribe:e(n)}}})[Kc]=function(){return this},t},r}function Jc(t,e,n){return e in t?Object.defineProperty(t,e,{value:n,enumerable:!0,configurable:!0,writable:!0}):t[e]=n,t}function Yc(){for(var t=arguments,e=arguments.length,n=new Array(e),r=0;r<e;r++)n[r]=t[r];return 0===n.length?function(t){return t}:1===n.length?n[0]:n.reduce((function(t,e){return function(){return t(e.apply(void 0,arguments))}}))}function Xc(){for(var t=arguments,e=arguments.length,n=new Array(e),r=0;r<e;r++)n[r]=t[r];return function(t){return function(){var e=t.apply(void 0,arguments),r=function(){throw new Error("Dispatching while constructing your middleware is not allowed. Other middleware would not be applied to this dispatch.")},s={getState:e.getState,dispatch:function(){return r.apply(void 0,arguments)}},i=n.map((function(t){return t(s)}));return function(t){for(var e=arguments,n=1;n<arguments.length;n++){var r=null!=e[n]?e[n]:{},s=Object.keys(r);"function"==typeof Object.getOwnPropertySymbols&&(s=s.concat(Object.getOwnPropertySymbols(r).filter((function(t){return Object.getOwnPropertyDescriptor(r,t).enumerable})))),s.forEach((function(e){Jc(t,e,r[e])}))}return t}({},e,{dispatch:r=Yc.apply(void 0,i)(e.dispatch)})}}}var Qc="1.4.5",$c=["owner","participants.*.user","members.items.*","blockedParticipants.items.*","typingParticipants.*.user","admins.*.user","admins.*.inviter","media.items.*.message.sender","search.result.*.message.sender","search.result.*.message.link.message.sender","commands.*.bot"],Zc=["sender","attaches.*.user","attaches.*.users.*","link.message.sender","link.message.attaches.*.user","link.message.link.message.sender","link.message.link.message.attaches.*.user","reactionsDetailed.filter.*.items.*.userId"];function tu(t,e,n){var r=t&&"object"==typeof t?t.id:Number(t);return t&&"object"==typeof t&&"GROUP"===t.type&&n.get("groups",r)?n.key(["groups",r]):n.get("contacts")instanceof s&&n.get("contacts",r)?n.key(["contacts",r]):void 0}function eu(t,e,n){var r=t&&"object"==typeof t?t.id:Number(t);return n.key(["stickers",r])}function nu(t,e,n){var r=t&&"object"==typeof t?t.id:Number(t);return n.key(["stickerSets",r])}function ru(t,e,n){var r=t&&"object"==typeof t?t.id:Number(t);return n.key(["groups",r])}function su(t,e,n){var r=t&&"object"==typeof t?U(t):t;if(null!=r)return n.key(["chats",e.item(1),"messages",r])}function iu(t,e,n){var r=t&&"object"==typeof t?t.id:Number(t);return n.key(["chats",r])}function ou(t,e,n){return n.key(["config","chats",t.chatId])}function au(t){return $c.map((function(e){return t+"."+e})).concat(cu(t+".lastMessage"),cu(t+".pinnedMessage"),cu(t+".messages.*"))}function cu(t){return Zc.map((function(e){return t+"."+e}))}function uu(t,e,n){if(t)return n.key(["download",t])}function du(t,e,n){var r=t&&"object"==typeof t?t.id:Number(t);return n.key(["showcase","chats",r])}function hu(t,e,n){var r=t&&"object"==typeof t?t.sessionId:t;return n.key(["constructors","sessions",r])}function fu(t,n,r){var i,o=t?t.version:"",a=function(t){return["auth.profile","newContact.contact","newChat.contacts.*","newChat.invited.*","onboarding.contacts.*","blackList.*","call.contact","posting.*.link.sender","search.*.result.*.chat.participants.*.user"].concat(au("chats.*"),au("onboarding.chats.*")).forEach((function(e){return t.link(e,tu)})),["chats.*.lastMessage","chats.*.pinnedMessage","chats.*.search.result.*.message","chats.*.messages.*.link.message","chats.*.selectedMessages.*"].forEach((function(e){return t.link(e,su)})),["search.result.*.chat","search.messages.result.*.chat","call.chat","createdChannel","chatList.*","selectedChat"].forEach((function(e){return t.link(e,iu)})),["chats.*.settings"].forEach((function(e){return t.link(e,ou)})),["assets.stickerSections.TOP.result.*","assets.stickerSections.NEW.result.*","assets.stickerSections.RECENT.result.*","assets.stickerSections.FAVORITE_STICKERS.result.*","assets.stickerSearch.result.*","assets.stickerSuggestions.*","stickerSets.*.result.*"].forEach((function(e){return t.link(e,eu)})),["assets.stickerSections.NEW_STICKER_SETS.result.*","assets.stickerSections.FAVORITE_STICKER_SETS.result.*","assets.stickerSetSearch.result.*"].forEach((function(e){return t.link(e,nu)})),["chats.*.messages.*.attaches.*.download","chats.*.messages.*.link.message.attaches.*.download","chats.*.search.result.*.message.attaches.*.download","chats.*.mediaList.FILE.items.*.attach.download"].forEach((function(e){return t.link(e,uu)})),["showcase.sections.*.chats.*"].forEach((function(e){return t.link(e,du)})),["chats.*.constructorSession"].forEach((function(e){return t.link(e,hu)})),t.link("chats.*.group",ru),t.link("moderatedGroups.groups.*",ru),t}(new Qa),c=Yc;"undefined"!=typeof __REDUX_DEVTOOLS_EXTENSION_COMPOSE__&&(c=__REDUX_DEVTOOLS_EXTENSION_COMPOSE__);var u=function(t,e){return function(n,r){return e.value=n,t(e,r),e.save(),e.value}}(n,a),d=Wc(u,Object.assign({interactive:!0,state:e.LoadState.idle,auth:{},chats:new s,chatList:[],contacts:new s,groups:new s,blackList:new s,assets:{},stickers:new s,animojis:{},onboarding:{chats:[],contacts:[]},showcase:{chats:new s,sections:[]},config:{},download:new s,isMobile:null===(i=r)||void 0===i?void 0:i.isMobile},t),c(Xc(lu,pu)));return d.immutable=a,d.dispatch(function(t,e){return{type:I,version:t,prevVersion:e}}(Qc,o)),d}var lu=function(t){return function(e){return function(n){var r;return"undefined"==typeof process&&-1!==location.hash.indexOf("logger")?(console.groupCollapsed(n.type),console.info("action",n),console.time(n.type),r=e(n),console.timeEnd(n.type),console.log("next state",t.getState()),console.groupEnd(),r):e(n)}}},pu=function(t){return function(e){return function(n){var r=t.getState();if(r)if(r._actionsLog){for(;r._actionsLog.length>=30;)r._actionsLog.shift();r._actionsLog.push(n.type)}else r._actionsLog=[n.type];return e(n)}}},gu={maxAttempts:4,maxRequests:10,version:"1.0.0"},vu=function(t){function e(){return null!==t&&t.apply(this,arguments)||this}return g(e,t),e}(Ma),mu=function(t){function e(e,n){var r=t.call(this)||this;return r._ws=null,r._opened=!1,r._reconnecting=!1,r._closing=!1,r._reconnectAttempt=0,r._timerId=0,r._connectTime=0,r.options=v(v({},gu),n),r.type="websocket","string"==typeof e?(r.url=e,r.open()):(r.url=e.url,r._connectTime=Date.now(),r.bindSocket(e),e.readyState===WebSocket.OPEN?setTimeout((function(){return r._handleOpen()}),1):e.readyState===WebSocket.CLOSED&&(clearTimeout(r._timerId),setTimeout((function(){return r._handleClose()}),1))),r}return g(e,t),Object.defineProperty(e.prototype,"ws",{get:function(){return this._ws},enumerable:!0,configurable:!0}),Object.defineProperty(e.prototype,"readyState",{get:function(){return this._ws?this._ws.readyState:0},enumerable:!0,configurable:!0}),Object.defineProperty(e.prototype,"connected",{get:function(){return this.readyState===WebSocket.OPEN},enumerable:!0,configurable:!0}),e.prototype.send=function(t){this._ws&&(this._ws.send(t),this.emit("send",t))},e.prototype.open=function(){this.connected||this._reconnecting||(this._disposeSocket(),this._connectTime=Date.now(),this.bindSocket(new WebSocket(this.url)))},e.prototype.close=function(t,e){this._closing=!0,clearTimeout(this._timerId),this._ws&&this._ws.close(t||1e3,e)},e.prototype.reopen=function(){var t=this._ws;t?(this._handleClose(),t.close(4001,"Forced connection re-open")):this.open()},e.prototype.handleEvent=function(t){switch(t.type){case"open":this._handleOpen();break;case"close":this._handleClose(t);break;case"message":this.emit("message",t.data);break;case"error":this.emit("error",t)}},e.prototype._reconnectIfNeeded=function(){var t=this;if(!this._closing){var e=gt(Math.min(++this._reconnectAttempt,this.options.maxAttempts));return this._reconnecting=!0,clearTimeout(this._timerId),this._timerId=setTimeout((function(){t._reconnecting=!1,t.open()}),e||0),!0}return!1},e.prototype._handleOpen=function(){clearTimeout(this._timerId),this._reconnectAttempt=0,this._opened||(this._opened=!0,this.emit("open"));var t=null!=this._connectTime?Date.now()-this._connectTime:void 0;this.emit("connect",t)},e.prototype._handleClose=function(t){this._disposeSocket(),this._opened&&this.emit("disconnect"),this._reconnectIfNeeded()||this.emit("close",t)},e.prototype._disposeSocket=function(){this._ws&&(this._ws.removeEventListener("open",this),this._ws.removeEventListener("close",this),this._ws.removeEventListener("message",this),this._ws.removeEventListener("error",this),this._ws=null)},e.prototype.bindSocket=function(t){var e=this;this._ws=t,this._closing=!1,t.addEventListener("open",this),t.addEventListener("close",this),t.addEventListener("message",this),t.addEventListener("error",this),clearTimeout(this._timerId),this._timerId=setTimeout((function(){t.readyState===WebSocket.CONNECTING&&e._ws===t&&t.close(4e3,"Connection open timeout exceeded")}),7e3)},e}(vu),yu=function(t){function e(e,n){var r=t.call(this)||this;return r.url=e,r.connecting=!1,r.sessionId=0,r.queue=[],r.sending=[],r.timerId=0,r.ops=0,r.lastResponseTime=0,r.wasOpened=!1,r.options=v(v({listen:!0,noConnectionThreshold:3e5},gu),n),r.type="long-polling",r.init(),r}return g(e,t),Object.defineProperty(e.prototype,"connected",{get:function(){return!!this.connId},enumerable:!0,configurable:!0}),e.prototype.open=function(){var t=this,e=0,n=++this.sessionId,r=this.url+"/init?version="+this.options.version;this.connId=this.cmdUrl=null,this.ops=0;var s=Date.now();clearTimeout(this.timerId);var i=function(){n===t.sessionId&&(t.connecting=!0,t.handshake(r).then(o,a))},o=function(e){n===t.sessionId&&(t.connId=e.id,t.cmdUrl=e.url||null,t.connecting=!1,clearTimeout(t.timerId),t.wasOpened||(t.wasOpened=!0,t.emit("open")),t.emit("connect",Date.now()-s),t.prevConnId&&t.notifyClose(t.prevConnId),t.next(),t.options.listen&&t.listenIncoming())},a=function(r){n===t.sessionId&&(t.log({message:"handshake-fail",attempt:e,err:r}),t.connecting=!1,t.runTimer(i,t.timeout(++e)))};i()},e.prototype.close=function(){clearTimeout(this.timerId),this.connId&&(this.sessionId++,this.sending.length=0,this.connId=null,this.emit("disconnect"),this.emit("close",void 0))},e.prototype.reopen=function(){this.close(),this.connecting||this.open()},e.prototype.send=function(t){var e=JSON.parse(t);this.queue.push(e),this.next()},e.prototype.init=function(){var t=this;if(this.open(),"undefined"!=typeof window){var e=function(){t.connId&&t.notifyClose(t.connId),window.removeEventListener("beforeunload",e)};window.addEventListener("beforeunload",e)}},e.prototype.sendMessage=function(t){var e=this;this.emit("send",JSON.stringify(t));var n=0,r=this.connId,s=(this.cmdUrl||this.url)+"/cmd";this.sending.push(t);var i=function(){r===e.connId&&e.sending.includes(t)&&e.request(s,t,2e4).then(o,a)},o=function(n){e.ops++,e.removeSending(t),n.seq=t.seq,e.notifyMessage(n),e.next()},a=function(r){e.isResetErr(r)?e.removeSending(t):e.setTimeout(i,e.timeout(++n))};i()},e.prototype.next=function(){if(this.connected&&this.queue.length&&this.sending.length<this.options.maxRequests){var t=this.queue.shift();t&&(this.sendMessage(t),this.next())}},e.prototype.listenIncoming=function(){var t=this,e=this.connId,n=(this.cmdUrl||this.url)+"/events",r=0,s=function(){e===t.connId&&t.request(n).then(i,o)},i=function(e){r=0,t.ops++;try{e.events.forEach((function(e){return t.notifyMessage(e)}))}catch(t){console.error(t)}finally{s()}},o=function(e){t.isResetErr(e)||t.setTimeout(s,t.timeout(++r))};s()},e.prototype.notifyMessage=function(t){this.emit("message",JSON.stringify(t))},e.prototype.request=function(t,e,n){var r=this;return void 0===n&&(n=0),new Promise((function(s,i){var o=new XMLHttpRequest;o.open("POST",t);var a=t;e&&e.opcode&&(a+="?"+e.opcode),n&&(o.timeout=n),o.withCredentials=!0,r.connId&&o.setRequestHeader("x-connect-id",r.connId);var c=function(){var t=_u(o.statusText,o.status||0);r.isResetErr(t)&&r.reset(0===t.code),i(t),r.xhrLog({url:a,cmd:"error",status:t.code})};o.onerror=c,o.ontimeout=function(){return i(_u("XHR timeout","XhrTimeout"))},o.onload=function(){if(200===o.status){r.lastResponseTime=Date.now();try{o.responseText?s(JSON.parse(o.responseText)):s(null)}catch(t){t.code||(t.code="invalid-json"),i(t)}r.xhrLog({url:a,cmd:"receive"})}else c()},o.send(e?JSON.stringify(e):null),r.xhrLog({url:a,cmd:"send"})}))},e.prototype.handshake=function(t,e){var n=this;return void 0===e&&(e=1e4),new Promise((function(r,s){n.runTimer((function(){var t=new Error("Request time-out");t.code="Timeout",s(t)}),e+100),n.request(t,void 0,e).then((function(t){if(clearTimeout(n.timerId),t&&t.id)return r(t);var e=new Error(t?"No id in handshake":"Handshake response is empty");e.code="HandshakeInvalid",s(e)})).catch((function(t){clearTimeout(n.timerId),s(t)}))}))},e.prototype.runTimer=function(t,e){clearTimeout(this.timerId),this.timerId=this.setTimeout(t,e)},e.prototype.setTimeout=function(t,e){return void 0===e&&(e=1),setTimeout(t,e)},e.prototype.removeSending=function(t){var e=this.sending.indexOf(t);-1!==e&&this.sending.splice(e,1)},e.prototype.reset=function(t){var e=this.connected;e&&(this.log({message:"reset-session",ops:this.ops}),t&&this.log({message:"reset-session.no-internet"}),this.prevConnId=this.connId,this.connId=null,this.sending.length=0,this.emit("disconnect")),!e&&this.connecting||this.open()},e.prototype.timeout=function(t){return gt(Math.min(t,this.options.maxAttempts))},e.prototype.notifyClose=function(t){"undefined"!=typeof navigator&&navigator.sendBeacon&&this.connId&&navigator.sendBeacon(this.url+"/close",t)},e.prototype.isResetErr=function(t){if(t){if(502===t.code||503===t.code)return!0;if(0===t.code)return Date.now()-this.lastResponseTime>this.options.noConnectionThreshold}return!1},e.prototype.log=function(t){this.emit("log",this.type,t)},e.prototype.xhrLog=function(t){this.log(t)},e}(vu);function _u(t,e){var n=new Error(t);return null!=e&&(n.code=e),n}var Iu={maxRequests:64},ku=function(t){function e(e,n){var r=t.call(this)||this;return r.transport=e,r.pending=new s,r.stalled=null,r.queue=[],r._paused=!1,r.options=Object.assign({},Iu,n),r._onConnect=r._onConnect.bind(r),r._onDisconnect=r._onDisconnect.bind(r),r._onMessage=r._onMessage.bind(r),e.on("connect",r._onConnect),e.on("disconnect",r._onDisconnect),e.on("message",r._onMessage),r}return g(e,t),Object.defineProperty(e.prototype,"paused",{get:function(){return this._paused},enumerable:!0,configurable:!0}),Object.defineProperty(e.prototype,"flowing",{get:function(){return!this.paused&&!!this.transport&&this.transport.connected},enumerable:!0,configurable:!0}),Object.defineProperty(e.prototype,"connected",{get:function(){return!!this.transport&&this.transport.connected},enumerable:!0,configurable:!0}),Object.defineProperty(e.prototype,"stopped",{get:function(){return!this.transport},enumerable:!0,configurable:!0}),Object.defineProperty(e.prototype,"transportType",{get:function(){if(this.transport){var t=this.transport.type;return"tamtam"===t?this.transport.active.type:t}},enumerable:!0,configurable:!0}),e.prototype.pause=function(){this.paused||(this._paused=!0,this.emit("pause"))},e.prototype.resume=function(){this.paused&&(this._paused=!1,this.flowing&&this._resume(),this.emit("resume"))},e.prototype.request=function(t,e,n){var r=new jc(t,e,n);return this.flowing?this._send(r):this._enqueue(r),r.promise},e.prototype.send=function(t,e,n){void 0===n&&(n={}),this.flowing&&this._send(new jc(t,e,n.cmd,n.notif).resolve())},e.prototype.clear=function(t,e){this.cancel((function(){return!0}),t,e)},e.prototype.cancel=function(t,e,n){Eu(this.pending,t,e,n),Eu(this.stalled,t,e,n),this.stalled&&!this.stalled.size&&(this.stalled=null),this.queue=this.queue&&this.queue.filter((function(r){return!t(r)||(r.cancel(e,n),!1)})),this.flowing&&this.pending&&this.pending.size<this.options.maxRequests&&this._sendNext()},e.prototype.reopen=function(){this.transport&&this.transport.reopen()},e.prototype.end=function(t,e){this.clear(t,e),this.transport&&(this.transport.off("connect",this._onConnect),this.transport.off("disconnect",this._onDisconnect),this.transport.off("message",this._onMessage)),this.pending.clear(),this.queue.length=0,this.stalled&&this.stalled.clear(),this.emit("end")},e.prototype._onConnect=function(){this.emit("connect"),this.flowing&&this._resume()},e.prototype._onDisconnect=function(){this.emit("disconnect"),this.pending&&this.pending.size&&(this.stalled=this._getStalled(),this.pending=new s)},e.prototype._onMessage=function(t){try{var e=JSON.parse(t);this._handleIncomingMessage(e),this.emit("message",e)}catch(e){this.emit("raw-message",t)}},e.prototype._handleIncomingMessage=function(t){var e=this.pending&&this.pending.get(t.seq);if(!e&&this.stalled&&(e=this.stalled.get(t.seq)),e&&function(t,e){return t.seq===e.id&&t.opcode===e.command&&(1===t.cmd||3===t.cmd)}(t,e)){if(this.pending&&this.pending.delete(t.seq),this.stalled&&this.stalled.delete(t.seq),1===t.cmd)e.resolve(t.payload);else if(function(t){return 3===t.cmd}(t)){var n=t.payload;e.reject(it(n.error,n.message,{localizedMessage:n.localizedMessage})),this.emit("request-error",e)}this.emit("request-end",e.command,e.requestTime,t.duration||0,t.cmd),this._sendNext()}else 0===t.cmd||2===t.cmd?this.emit(t.opcode,t.payload,t.seq):this.flowing&&this._sendNext()},e.prototype._resume=function(){var t=this,e=this.queue&&this.queue.slice()||[];this.queue=[],this.stalled&&(this.stalled.forEach((function(e){e.cmd=2,t._send(e)})),this.stalled=null),e.forEach((function(e){return t._send(e)}))},e.prototype._send=function(t){return this.pending&&!this.pending.has(t.id)&&(this.pending.size<this.options.maxRequests&&this.transport?(t.notif||this.pending.set(t.id,t),t.saveStartTime(),this.transport.send(t.payload())):this._enqueue(t)),t.promise},e.prototype._enqueue=function(t){this.queue&&this.queue.push(t)},e.prototype._sendNext=function(){var t=this.queue&&this.queue.shift();t&&this._send(t)},e.prototype._getStalled=function(){var t=new s;return this.pending.forEach((function(e,n){e.notif||t.set(n,e)})),t},e}(Ma);function Eu(t,e,n,r){t&&t.forEach((function(s,i){e(s)&&(s.cancel(n,r),t.delete(i))}))}var Su=["open","close","connect","disconnect","send","message","error","log"],wu=function(t){function e(e,n,r){var s=t.call(this)||this;if(s.disposeListeners=null,s.type="tamtam",e instanceof WebSocket&&(e.readyState===WebSocket.CLOSING||e.readyState===WebSocket.CLOSED))s.setActive(new yu(n,r)),setTimeout((function(){return s.emit("log",s.type,"use-longpolling")}),1);else{var i=null,o=function(){clearTimeout(u),d.off("open",a),d.off("close",c),d.off("error",c)},a=function(){null===i?(i=!0,o(),s.emit("log",s.type,"use-websocket")):d.close()},c=function(){null===i&&(i=!1,o(),d.close(),s.emit("log",s.type,"use-longpolling"),s.setActive(new yu(n,r)))},u=setTimeout(c,r&&r.probeTimeout||2e3),d=new mu(e,r);d.once("open",a),d.once("close",c),d.once("error",c),s.setActive(d)}return s}return g(e,t),Object.defineProperty(e.prototype,"connected",{get:function(){return this.active.connected},enumerable:!0,configurable:!0}),e.prototype.open=function(){return this.active.open()},e.prototype.close=function(){return this.active.close()},e.prototype.reopen=function(){return this.active.reopen()},e.prototype.send=function(t){return this.active.send(t)},e.prototype.setActive=function(t){this.unsubscribe(),this.active=t,this.subscribe(t)},e.prototype.subscribe=function(t){var e=this;this.unsubscribe();var n={};Su.forEach((function(r){n[r]=function(){for(var t=arguments,n=[],s=0;s<arguments.length;s++)n[s]=t[s];return e.emit.apply(e,_([r],n))},t.on(r,n[r])})),this.disposeListeners=function(){Su.forEach((function(e){return t.off(e,n[e])}))}},e.prototype.unsubscribe=function(){this.disposeListeners&&(this.disposeListeners(),this.disposeListeners=null)},e}(vu),Cu=function(t){function e(e,n,r){return t.call(this,e,n,["assets","stickerSearch"],{request:function(t,e,n){return t.request(26,{type:"STICKER",from:n.marker,count:100,query:e}).then((function(t){return r.fetchMissing(t.stickers).then((function(){return v(v({},t),{result:t.stickers})}))}))}})||this}return g(e,t),e}(tc),Mu=function(t){function e(e,n,r){return t.call(this,e,n,["assets","stickerSetSearch"],{request:function(t,e,n){return t.request(26,{type:"STICKER_SET",from:n.marker,count:100,query:e}).then((function(t){return r.fetchSets(t.stickerSets).then((function(){return v(v({},t),{result:t.stickerSets})}))}))}})||this}return g(e,t),e}(tc),bu=function(){function t(t,e,n){var r=this;this._handleAssetsUpdate=function(t){var e,n,s,i=t.type,o=t.id,a=t.ids,c=t.updateType,u=t.recentEmojiList,d=t.recentsList;if(r._store.getState().assets.loadState)switch(c){case"ADDED":(null===(e=u)||void 0===e?void 0:e.length)?r.updateRecentEmoji(u):(null===(n=d)||void 0===n?void 0:n.length)?r.updateRecents(d):r.update(i);break;case"UPDATED":case"MOVED":r.update(i);break;case"REMOVED":var h=(null===(s=d)||void 0===s?void 0:s.length)?d.map((function(t){return t.stickerId||t.id})):a||[o];r.remove(i,h,!0);break;case"LIST_UPDATED":"FAVORITE_STICKER"===i?r.clearFavorites(!0):"RECENT"===i&&r.clearRecent(!0)}},this._store=t,this._api=e,this._stickerSearch=new Cu(t,e,this),this._stickerSetSearch=new Mu(t,e,this),this._stats=n,this.fillSuggestions=Z(this.fillSuggestions.bind(this),250,{leading:!1,trailing:!0}),this._api.on(150,this._handleAssetsUpdate)}return t.prototype.updateList=function(t){this._store.dispatch({type:co,stickers:t})},t.prototype.updatePostcards=function(t){this._store.dispatch({type:po,stickers:t})},t.prototype.add=function(t,e){var n="FAVORITE_STICKER_SET"===t?"STICKER_SET":"STICKER";return this._stats.action(n+"_ADD_TO_FAVORITE"),this._store.dispatch({type:yo,assetType:t,id:e}),this._api.request(29,{type:t,id:e})},t.prototype.remove=function(t,e,n){switch(t){case"RECENT":this._stats.action("STICKER_RECENTS_REMOVE");break;case"FAVORITE_STICKER":this._stats.action("STICKER_REMOVE_FROM_FAVORITE");break;case"FAVORITE_STICKER_SET":this._stats.action("STICKER_SET_REMOVE_FROM_FAVORITE")}this._store.dispatch({type:Io,assetType:t,ids:e}),n||this._api.request(259,{type:t,ids:e})},t.prototype.move=function(t,e,n){var r="FAVORITE_STICKER_SET"===t?"STICKER_SET":"STICKER";return this._stats.action(r+"_MOVE"),this._store.dispatch({type:_o,assetType:t,id:e,position:n}),this._api.request(260,{type:t,id:e,position:n})},t.prototype.clearRecent=function(t){if(this._stats.action("STICKER_RECENTS_CLEAR"),this._store.dispatch({type:ko}),!t)return this._api.request(261,{type:"RECENT",ids:[]})},t.prototype.clearFavorites=function(t){if(this._stats.action("STICKER_FAVORITES_CLEAR"),this._store.dispatch({type:Eo}),!t)return this._api.request(261,{type:"FAVORITE_STICKER",ids:[]})},t.prototype.storeMissing=function(t){if(t.length){var e=this._store.getState().stickers,n=t.filter((function(t){return!e.has(t.stickerId)}));this.updateList(n)}},t.prototype.fetch=function(t,e){var n=this;t=t.filter(nt);for(var r=[],s=0;s<t.length;)r.push(this._api.request(28,{type:"STICKER",ids:t.slice(s,s+100)})),s+=100;return Promise.all(r).then((function(t){var r=t.reduce((function(t,e){return t.concat(e.stickers)}),[]);return"POSTCARDS"===e?n.updatePostcards(r):n.updateList(r),r}))},t.prototype.fetchSets=function(t,e){for(var n=this,r=[],i=this._store.getState().stickerSets||new s,o=t.filter(nt).filter((function(t){return e||!i.has(t)})),a=0;a<o.length;)r.push(this._api.request(28,{type:"STICKER_SET",ids:o.slice(a,a+100)})),a+=100;return Promise.all(r).then((function(t){if(t.length){var e=t.reduce((function(t,e){return t.concat(e.stickerSets)}),[]),r=e.reduce((function(t,e){return t.concat(e.stickers)}),[]);return n._store.dispatch({type:mo,sets:e}),n.fetchMissing(r)}})).then((function(){var e=new s;return t.map((function(t){return e.set(t,i.get(t))})),e}))},t.prototype.fetchStickerSuggestions=function(t){var e=this;return this._api.request(194,{stickerId:t}).then((function(t){return e.fetchMissing(t.stickers),t.stickers}))},t.prototype.fetchPostcards=function(t){return this.fetch(t,"POSTCARDS")},t.prototype.fetchMissing=function(t){if(!t.length)return Promise.resolve([]);var e=this._store.getState().stickers,n=t.filter(nt).filter((function(t){return!e.has(t)}));return n.length?this.fetch(n):Promise.resolve([])},t.prototype.update=function(t){var e,n,r=this;void 0===t&&(t="STICKER");var i="STICKER"===t?null===(e=this._store.getState().assets)||void 0===e?void 0:e.recentSync:null===(n=this._store.getState().assets)||void 0===n?void 0:n.favoritesSync;return i||this._store.dispatch({type:go,data:so}),this._api.request(27,{type:t,sync:i||0}).then((function(e){var n=new s,i=e.sections.map((function(t){return"STICKERS"===t.type?(n.set(t.id,v(v({},t),{result:t.stickers})),t.stickers):"STICKER_SETS"===t.type?(n.set(t.id,v(v({},t),{result:t.stickerSets})),r.fetchSets(t.stickerSets).then((function(){return[]}))):"RECENTS"===t.type?(n.set(t.id,v(v({},t),{result:t.recentsList.map((function(t){return t.gif?v({id:t.id},t.gif):t.id}))})),t.recentsList.filter((function(t){return"STICKER"===t.type})).map((function(t){return t.stickerId}))):void 0}));return Promise.all(i).then((function(t){var e=t.reduce((function(t,e){return t.concat(e)}),[]);return r.fetchMissing(e)})).then((function(){return r.fetchUpdatedSets(e.stickersSetsUpdates)})).then((function(){return r.fetchUpdatedStickers(e.stickersUpdates)})).then((function(){r._store.dispatch({type:go,data:ro}),r._store.dispatch({type:vo,syncType:t,sync:e.sync}),r._store.dispatch({type:ao,sectionsOrder:e.stickersOrder,sections:n})}))}))},t.prototype.updateRecents=function(t){var e,n;if(null===(n=null===(e=this._store.getState().assets)||void 0===e?void 0:e.stickerSections)||void 0===n?void 0:n.RECENT){var r=t.map((function(t){return t.gif?v(v({},t.gif),{id:t.id}):t}));this._store.dispatch({type:lo,recents:r})}},t.prototype.loadNext=function(t){var e=this;void 0===t&&(t="STICKER");var n="assets.stickerSections."+("STICKER"===t?"NEW":"NEW_STICKER_SETS"),r=new Qa(this._store.getState()).get(n);return r.loadState!==so&&this._store.dispatch({type:go,data:so}),r&&r.marker&&r.loadState!==so?(this._store.dispatch({key:n,type:to}),this._api.request(26,{type:t,from:r.marker}).then((function(r){return r.stickerSets?e.fetchSets(r.stickerSets):r.stickers&&e.fetchMissing(r.stickers),e._store.dispatch({key:n,type:$i,data:v(v({},r),{result:"STICKER_SET"===t?r.stickerSets:r.stickers,loadState:ro})}),e._store.dispatch({type:go,data:ro}),r}))):Promise.resolve(null)},t.prototype.search=function(t){return this._stickerSearch.query(t)},t.prototype.searchSet=function(t){return this._stickerSetSearch.query(t)},t.prototype.searchMore=function(t){return"STICKER_SET"===t?this._stickerSetSearch.loadNext():this._stickerSearch.loadNext()},t.prototype.resetSearch=function(){this._stickerSearch.reset(),this._stickerSetSearch.reset()},t.prototype.suggest=function(t){this.fillSuggestions(t)},t.prototype.fillSuggestions=function(t){var e=this._store.getState(),n=e.assets,r=e.config,i=n.stickerSuggestions;if(!i||!i.has(t)){var o=n.stickerSections,a=r.server["stickers-suggestion"],c=new s;o&&a&&a.forEach((function(e){if(o[e]&&c.size<2){var n=o[e].result;n&&n.forEach((function(e){return function(t,e){c.size<2&&t.tags&&-1!==t.tags.indexOf(e)&&c.set(t.id,t)}(e,t)}))}})),c.size<2?this._loadSuggestions(t,new s(c)):this._store.dispatch({type:uo,query:t,suggestion:c})}},t.prototype.updateRecentStickers=function(t){this._store.dispatch({type:fo,stickerId:t})},t.prototype.updateRecentEmoji=function(t){var e,n;(null===(n=null===(e=this._store.getState().assets)||void 0===e?void 0:e.stickerSections)||void 0===n?void 0:n.RECENT)&&this._store.dispatch({type:ho,emoji:t})},t.prototype.get=function(t){return this._api.request(26,t)},t.prototype.getStickers=function(t){var e=this;return void 0===t&&(t={}),this.get(v({type:"STICKER"},t)).then((function(t){var n=t.stickers;return e.fetchMissing(n).then((function(){var t=e._store.getState().stickers;return n.map((function(e){return t.get(e)}))}))}))},t.prototype.fetchUpdatedStickers=function(t){var e;if(null===(e=t)||void 0===e?void 0:e.size){var n=this._store.getState().stickers,r=[];return t.forEach((function(t,e){var s,i;((null===(i=null===(s=n)||void 0===s?void 0:s.get(e))||void 0===i?void 0:i.localUpdateTime)||0<t)&&r.push(e)})),this.fetch(r)}return Promise.resolve()},t.prototype.fetchUpdatedSets=function(t){var e;if(null===(e=t)||void 0===e?void 0:e.size){var n=this._store.getState().stickerSets,r=[];return t.forEach((function(t,e){var s,i;((null===(i=null===(s=n)||void 0===s?void 0:s.get(e))||void 0===i?void 0:i.updateTime)||0<t)&&r.push(e)})),this.fetchSets(r,!0)}return Promise.resolve()},t.prototype._loadSuggestions=function(t,e){var n=this;this.get({type:"STICKER",from:0,count:2,query:t}).then((function(t){return n.fetchMissing(t.stickers).then((function(){return t}))})).then((function(r){var s=n._store.getState().stickers;return r.stickers.forEach((function(t){e.size<2&&e.set(t,s.get(t))})),n._store.dispatch({type:uo,query:t,suggestion:e}),r}))},t}(),Tu={mixed:["PHOTO","VIDEO"],audio:["AUDIO"],file:["FILE"],share:["SHARE"],music:["MUSIC"]},Ou=100,Au=function(){function t(t,e){this.store=t,this.api=e}return t.prototype.selectSection=function(t,e){var n,r=cc(this.store,t);if(r){var s=null===(n=r.media)||void 0===n?void 0:n.get(e);s&&!s.selected&&(this.dispatch({type:"ChatMedia.SelectSection",chatId:t,sectionId:e}),this.prefetch(t,e))}},t.prototype.selectItem=function(t,n,r){this.dispatch({type:"ChatMedia.SelectItem",chatId:t,sectionId:n,ptr:r});var s=cc(this.store,t);if(s){var i=s.media.get(n),o=i.items,a=i.current;if(-1!==a&&i.loadState!==e.LoadState.loading){for(var c=o[a],u={},d=a,h=-1,f=-1,l=Math.min(o.length,d+10),p=Math.max(-1,d-10);d<l;){if(Ht(o[d])){f=d;break}d++}for(d=a;d>p;){if(Ht(o[d])){h=d;break}d--}if(-1!==h&&-1!==f)u.messageId=c.messageId,u.backward=Ou,u.forward=Ou;else if(-1!==h){var g=o[h+1]||c;u.messageId=g.messageId,u.forward=Ou}else if(-1!==f){g=o[f-1]||c;u.messageId=g.messageId,u.backward=Ou}(u.forward||u.backward)&&this.request(t,n,u)}}},t.prototype.clearSelectedItem=function(t,e){this.dispatch({type:"ChatMedia.ClearSelectedItem",chatId:t,sectionId:e})},t.prototype.prefetch=function(t,n){var r;void 0===n&&(n="mixed");var s=cc(this.store,t);if(s){var i=null===(r=s.media)||void 0===r?void 0:r.get(n);if(i.loadState!==e.LoadState.idle)return;var o=i.items[0];if(!Xt(i)||o&&Ht(o))return this.request(t,n,{backward:Ou})}},t.prototype.loadNext=function(t,n,r,s){var i,o,a,c=cc(this.store,t);if(c){var u=null===(o=c.media)||void 0===o?void 0:o.get(n);if(!u||u.loadState===e.LoadState.loading)return;var d=u.items[r];if(d&&Ht(d)){var h="backward"===s?u.items[r-1]:u.items[r+1];this.request(t,n,((i={messageId:null===(a=h)||void 0===a?void 0:a.messageId})[s]=Ou,i))}}},t.prototype.uncensor=function(t,e){this.dispatch({type:"ChatMedia.Uncensor",userId:t,mediaId:e})},t.prototype.removeFromWhiteList=function(t){this.dispatch({type:"ChatMedia.RemoveFromWhiteList",userId:t})},t.prototype.request=function(t,n,r){var s=this;this.setLoadState(t,n,e.LoadState.loading);var i=v({chatId:t,attachTypes:Tu[n],fileAttachmentTypes:"music"===n||"mixed"===n?Tu[n]:void 0},r);return this.api.request(51,i).then((function(r){return s.dispatch({type:"ChatMedia.AddToList",chatId:t,sectionId:n,resp:r,req:i}),s.setLoadState(t,n,e.LoadState.idle),r})).catch((function(r){throw s.setLoadState(t,n,e.LoadState.idle),r}))},t.prototype.setLoadState=function(t,e,n){this.dispatch({type:"ChatMedia.SetLoadState",chatId:t,sectionId:e,loadState:n})},t.prototype.dispatch=function(t){this.store.dispatch(t)},t}(),Ru=function(){function t(t,e,n,r){var s=this;this._handleNotif=function(t){var e=t.chatId,n=t.messageId,r=t.totalCount,i=t.counters;s.updateReaction(e,n,void 0,i,r)},this._handleYourReactionNotif=function(t){var e=t.chatId,n=t.messageId,r=t.reactionInfo;s.updateReaction(e,n,r)},this._store=t,this._api=e,this._chat=n,this._contacts=r,this._api.on(155,this._handleNotif),this._api.on(156,this._handleYourReactionNotif)}return t.prototype.react=function(t,e,n){var r=this;if(!this.isRemoved(t)&&e){var s={reactionType:"EMOJI",id:n};return this._api.request(178,{chatId:t,messageId:e,reaction:s}).then((function(n){return r.updateReaction(t,e,n.reactionInfo),n}))}},t.prototype.unreact=function(t,e){var n=this;if(!this.isRemoved(t)&&e)return this._api.request(179,{chatId:t,messageId:e}).then((function(r){return n.updateReaction(t,e,r.reactionInfo),r}))},t.prototype.fetchReactions=function(t,e){var n=this;if(e&&e.length&&!this.isRemoved(t)){e=e.filter(Boolean);for(var r,s,i,o,a=(r=this._store.getState(),(o=null===(i=null===(s=r)||void 0===s?void 0:s.config)||void 0===i?void 0:i.server)&&o["msg-get-reactions-page-size"]||40),c=0;c<e.length;){var u=e.slice(c,c+a);c+=a,this._api.request(180,{chatId:t,messageIds:u}).then((function(e){var r,s=null===(r=e)||void 0===r?void 0:r.messagesReactions;s&&n._store.dispatch({type:qo,chatId:t,messagesReactions:s})}))}}},t.prototype.messageGetDetailedReactions=function(t,e,n,r,s,i){var o=this;if(!this.isRemoved(t))return this.setLoading(t,e,n),this._api.request(181,{chatId:t,messageId:e,reaction:n,marker:r,count:s}).then((function(r){var s,a,c=(null===(a=null===(s=r)||void 0===s?void 0:s.reactions)||void 0===a?void 0:a.map((function(t){return t.userId})))||[];o._contacts.fetchMissing(c).then((function(){o._store.dispatch({type:Uo,chatId:t,messageId:e,reaction:n,resetInconsistency:i,reactions:r.reactions,reactionInfo:r.reactionInfo,yourReaction:r.yourReaction,marker:r.marker})}))}))},t.prototype.updateReactionMark=function(t,e,n){return this._chat.updateReadMark(t,e,n,!1,"READ_REACTION")},t.prototype.updateReaction=function(t,e,n,r,s){this._store.dispatch({type:Do,chatId:t,messageId:e,reactions:n,counters:r,totalCount:s})},t.prototype.setLoading=function(t,n,r){this._store.dispatch({type:jo,chatId:t,messageId:n,reaction:r,loadState:e.LoadState.loading})},t.prototype.isRemoved=function(t){var e=cc(this._store,t);return!e||ye(e,this._getCurrentUser())},t.prototype._getCurrentUser=function(){var t=this._store.getState().auth;return t&&t.profile&&t.profile.id},t}();var Pu,Lu={count:20,userCongratsCount:5,loadMore:!1},Nu=function(){function t(t,e,n,r){var s=this;this._store=t,this._api=e,this._stickers=n,this._contacts=r,this._loadState="idle",this._api.on(145,(function(t){t.holidayId===s._getHolidayId()?s._store.dispatch({type:Qo,data:t}):s.getCongratsList()}))}return t.prototype.getCongratsInfo=function(){var t=this;this._api.request(120,{count:0,userCongratsCount:0}).then((function(e){t._store.dispatch({type:Wo,data:e.info})}))},t.prototype.getCongratsList=function(t){var e=this,n=v(v({},Lu),t),r=n.count,s=n.userCongratsCount,i=n.loadMore;i&&!this.hasMoreCongrats()||"idle"!==this._loadState||(this._loadState="loading",this._api.request(120,{count:r,userCongratsCount:s,userIds:i?this._getUserIds():null}).then((function(t){var n=e._getStickerIds(t.list);Promise.all([e._stickers.fetchMissing(n),e._contacts.fetchMissing(t.list.userIds)]).then((function(){e._loadState="idle",i?e._store.dispatch({type:Yo,data:t.list}):e._store.dispatch({type:Jo,data:t})}))})).catch((function(t){return e._loadState="idle"})))},t.prototype.getMoreStickers=function(t,e){var n=this;this._api.request(122,{userId:t,count:5,marker:e,holidayId:this._getHolidayId()}).then((function(t){var e=new i(t.list.list.map((function(t){return t.stickerId})));n._stickers.fetchMissing(Array.from(e)).then((function(){n._store.dispatch({type:Xo,data:t.list})}))}))},t.prototype.processCongratulation=function(t){var e=this;return this._api.request(121,{userId:t,status:!0,holidayId:this._getHolidayId()}).then((function(n){e._store.dispatch({type:$o,data:v({userId:t},n)})}))},t.prototype.hasMoreCongrats=function(){var t,e;return null===(e=null===(t=this._store.getState().congrats)||void 0===t?void 0:t.list)||void 0===e?void 0:e.hasMore},t.prototype._getStickerIds=function(t){var e=new i;return t.list.forEach((function(t){t.list.forEach((function(t){return e.add(t.stickerId)}))})),Array.from(e)},t.prototype._getUserIds=function(){var t,e;return null===(e=null===(t=this._store.getState().congrats)||void 0===t?void 0:t.list)||void 0===e?void 0:e.userIds},t.prototype._getHolidayId=function(){var t,e;return null===(e=null===(t=this._store.getState().congrats)||void 0===t?void 0:t.info)||void 0===e?void 0:e.holidayId},t}();function Du(t){return"animoji-"+t}e.AnimojiSectionType=void 0,(Pu=e.AnimojiSectionType||(e.AnimojiSectionType={})).ANIMOJIS="ANIMOJIS",Pu.ANIMOJI_SETS="ANIMOJI_SETS";var Uu=function(){function t(t,e){var n=this;this._handleAssetsUpdate=function(t){var e,r=t.updateType,s=t.recentEmojiList;if("ADDED"===r&&(null===(e=s)||void 0===e?void 0:e.length)){var i=s.reduce((function(t,e){return"ANIMOJI"===e.type?(t.push(e.id),t):t}),[]);n.fetchMissing(i)}},this._store=t,this._api=e,this._api.on(150,this._handleAssetsUpdate)}return t.prototype.storeList=function(t){this._store.dispatch({type:Zo,animoji:t})},t.prototype.fetch=function(t){var e=this;return t=t.filter(nt),this._api.request(28,{type:"ANIMOJI",ids:t}).then((function(t){var n,r=(null===(n=t.animojis)||void 0===n?void 0:n.map((function(t){return v(v({},t),{cid:Du(t.id)})})))||[];return e.storeList(r),r}))},t.prototype.fetchMissing=function(t){var e;if(!t.length)return Promise.resolve([]);var n=null===(e=this._store.getState().animojis)||void 0===e?void 0:e.animoji,r=t.filter(nt).filter((function(t){var e;return!(null===(e=n)||void 0===e?void 0:e.has(t))}));return r.length?this.fetch(r):Promise.resolve([])},t.prototype.fetchSets=function(t,e){for(var n,r=this,i=[],o=(null===(n=this._store.getState().animojis)||void 0===n?void 0:n.animojiSets)||new s,a=t.filter(nt).filter((function(t){return e||!o.has(t)})),c=0;c<a.length;){var u={type:"ANIMOJI_SET",ids:a.slice(c,c+100)};i.push(this._api.request(28,u)),c+=100}return Promise.all(i).then((function(t){if(t.length){var e=t.reduce((function(t,e){return t.concat(e.animojiSets||[])}),[]),n=e.reduce((function(t,e){return t.concat(e.animojiIds)}),[]);return r._store.dispatch({type:ta,animojiSets:e}),r.fetchMissing(n)}})).then((function(){var e=new s;return t.map((function(t){return e.set(t,o.get(t))})),e}))},t.prototype.updateAndFetchAnimoji=function(t){var e,n;if(null===(e=t)||void 0===e?void 0:e.size){var r=null===(n=this._store.getState().animojis)||void 0===n?void 0:n.animoji,s=[];return t.forEach((function(t,e){var n,i;((null===(i=null===(n=r)||void 0===n?void 0:n.get(e))||void 0===i?void 0:i.updateTime)||0<t)&&s.push(e)})),this.fetch(s)}return Promise.resolve()},t.prototype.updateAndFetchAnimojiSets=function(t){var e,n;if(null===(e=t)||void 0===e?void 0:e.size){var r=null===(n=this._store.getState().animojis)||void 0===n?void 0:n.animojiSets,s=[];return t.forEach((function(t,e){var n,i;((null===(i=null===(n=r)||void 0===n?void 0:n.get(e))||void 0===i?void 0:i.updateTime)||0<t)&&s.push(e)})),this.fetchSets(s,!0)}return Promise.resolve()},t.prototype.update=function(){var t,n=this,r=null===(t=this._store.getState().animojis)||void 0===t?void 0:t.sync;return this._api.request(27,{type:"ANIMOJI",sync:r||0}).then((function(t){var r=t.sections.reduce((function(t,n){switch(n.type){case e.AnimojiSectionType.ANIMOJI_SETS:return t.push(v(v({},n),{animojiSetIds:n.animojiSetIds.filter(nt)})),t;case e.AnimojiSectionType.ANIMOJIS:default:return t}}),[]);r.length&&n._store.dispatch({type:ea,animojiSections:r}),Promise.all(r.map((function(t){return n.fetchSets(t.animojiSetIds)}))).then((function(){return n.updateAndFetchAnimoji(t.animojiUpdates)})).then((function(){return n.updateAndFetchAnimojiSets(t.animojiSetUpdates)})).then((function(){n._store.dispatch({type:na,sync:t.sync})}))}))},t}(),xu={deviceType:"WEB",appVersion:"1.0.0",osVersion:"",locale:"ru",deviceName:"",screen:"1024x768 2.0x",headerUserAgent:null},ju=Qc;function qu(t,e,n){var r=Object.assign({},xu,n.userAgent),s=fu(v({userAgent:r.deviceType},e),da,n),i=function(t,e){if("string"==typeof t)return/^wss?:/.test(t)?new mu(t,e):new yu(t,e);if(t instanceof WebSocket)return new mu(t,e);return new wu(t.ws,t.lp,e)}(t,n),o=new ku(i,{maxRequests:54}),a=new ku(i,{maxRequests:10});o.pause();var c=new Gc(s,a,r),u=new yc(s,o),d=new Sa(s,o),h=new Hc(s,o,c),f=new kc(s,o),l=new bc(s,a,c,r,n.deviceId),p=new bu(s,o,c),g=new Uu(s,o),m=new Pc(s,o),y=new ac(s,o,h,d,f,c,u,m,p),_=new Ru(s,o,y,d),I=new Sc(s,o),k=new Ic(s,o),E=new Au(s,o),S=new wc(s,o),w=new Nu(s,o,p,d),C=N(o,s,5e3);return l.on("authorize",(function(t,e){o.resume(),S.leftColAdditionalInfo(),S.onboardingAdditionalInfo(),Cc(s,{chat:y,contacts:d,groups:f},t).then((function(){l.start();var r=600===n.minFirstChats;if(400===n.minFirstChats||500===n.minFirstChats||r)if(s.getState().oldestChatLoaded||!t.chatMarker&&!r)t.chatMarker&&e.chatsSync&&(y.resetInternalChatMarker(),y.loadAllChats(t.chatMarker,e.chatsSync));else{y.resetInternalChatMarker();var i=t.chatMarker||Date.now();y.loadAllChats(i,0)}else t.chatMarker&&e.chatsSync&&300===n.minFirstChats&&(y.resetInternalChatMarker(),y.loadAllChats(t.chatMarker,e.chatsSync));g.update()}))})).on("deauthorize",(function(){o.pause()})),function(t,e){var n=function(t){return 5===t.command&&Fu++>10};t.on("request-error",(function(t){var r,s=null===(r=t.getStatus())||void 0===r?void 0:r.value;if(s instanceof Error){var i=String(s.code||"");if((-1!==i.indexOf("proto.payload")||-1!==s.message.indexOf("proto.payload"))&&1!==t.command&&!n(t)){var o=["Request: "+t.payload(),"Error code: "+i,"Error message: "+s.message];e.log.error("INVALID_REQUEST",o.join("\n"))}}}))}(o,c),{stats:c,chat:y,participants:m,message:I,groups:f,contacts:d,config:u,ping:C,download:k,session:l,userAgent:r,stickers:p,animoji:g,reactions:_,media:E,okWeb:S,transport:i,congrats:w,getState:function(){return s.getState()},subscribe:function(t){return s.subscribe(t)},dispatch:function(t){return s.dispatch(t)},stop:function(){C.dispose(),y.destroy(),f.destroy(),o.end(),a.end(),i.close()},serialize:function(){return ha(s.getState())}}}var Fu=0;var Hu=["major","minor","patch"];function Vu(t){return t.split(".").map(Number)}function Gu(){var t=navigator.userAgent;if(-1!==t.indexOf("Opera"))return"Opera";if(-1!==t.indexOf("MSIE"))return"Microsoft Internet Explorer";if(-1!==t.indexOf("Chrome"))return"Chrome";if(-1!==t.indexOf("Safari"))return"Safari";if(-1!==t.indexOf("Firefox"))return"Firefox";var e=t.lastIndexOf(" ")+1,n=t.lastIndexOf("/");return e<n?t.substring(e,n):navigator.appName}function Ku(){var t=window.navigator.userAgent,e=window.navigator.platform;return-1!==["Macintosh","MacIntel","MacPPC","Mac68K"].indexOf(e)?"Mac OS":-1!==["iPhone","iPad","iPod"].indexOf(e)?"iOS":-1!==["Win32","Win64","Windows","WinCE"].indexOf(e)?"Windows":/Android/.test(t)?"Android":/Linux/.test(e)?"Linux":"Unknown"}function Bu(t,e){var n=navigator.userAgent;return Object.assign({},{deviceType:e?"OK_MOB_WEB":"OKWEB",osVersion:Ku(),deviceName:Gu(),headerUserAgent:n},t)}function zu(t,e,n){var r,s;void 0===n&&(n={});var i=null,o=0,a=function(){o=!1===n.leading?0:Date.now(),i=null,s=t.apply(void 0,r),i||(r=null)};return function(){for(var c=arguments,u=[],d=0;d<arguments.length;d++)u[d]=c[d];var h=Date.now();o||!1!==n.leading||(o=h);var f=e-(h-o);return r=u,f<=0||f>e?(i&&(clearTimeout(i),i=null),o=h,s=t.apply(void 0,r),i||(r=null)):i||!1===n.trailing||(i=setTimeout(a,f)),s}}function Wu(t){var e=Yu(),n=!1;return function(){n||(n=!0,Xu(t,Yu()-e))}}var Ju,Yu=function(){return Date.now()};function Xu(t,e){var n,r;(null===(n=null===OK||void 0===OK?void 0:OK.logger)||void 0===n?void 0:n.durationScalar)?null===(r=OK.logger)||void 0===r||r.durationScalar("messagesLayer","tt.init."+t,e):console.info("%s time: %fms",t,e)}function Qu(t){"undefined"!=typeof OK&&OK.logger?OK.logger.success("messagesLayer","tt-ui-state2",t):console.log("%c[MSG]: %c%s","font-weight: bold;","",t)}function $u(t,e,n){}var Zu=3e3;function td(t,e){Qu(e?"".concat(t,".").concat(e):t)}function ed(t){var e=t.transport;return e&&"tamtam"===e.type&&(e=e.active),e&&e.type}function nd(t){return"long-polling"===ed(t)}function rd(t,e){void 0===e&&(e=!1);try{var n=JSON.parse(t);return Object.keys(n).map((function(t){if("ver"!==t){if("opcode"===t)return"".concat(t,"=").concat(n[t].toString(16).toUpperCase());if("payload"===t){var r=n[t];null!=r&&"object"==typeof r&&(19===n.opcode&&1===n.cmd?r={chats:sd(r.chats),chatMarker:r.chatMarker,messages:sd(r.messages),presence:sd(r.presence),contacts:sd(r.contacts)}:Object.keys(r).forEach((function(t){Array.isArray(r[t])&&(r[t]="(".concat(r[t].length,")"))})));var s=JSON.stringify(r);return e&&s.length>200&&(s=s.slice(0,200)+"..."),"".concat(t,"=").concat(s)}return"".concat(t,"=").concat(n[t])}})).filter(Boolean).join(", ")}catch(e){return t}}function sd(t){return Array.isArray(t)?t.length:null!=t&&"object"==typeof t?Object.keys(t).length:-1}var id={__proto__:null,default:function(t){if(Ju)return Ju;var e={fallbackTimer:null,uiTimer:null,cssTimer:null};return Ju=new Promise((function(t,e){if(td("init"),window.location.search.indexOf("fallback")>-1)return td("param"),e("param");t()})).then((function(){return d(t.uid).catch((function(){return td("cache-fail")}))}),(function(){return td("start-fail")})).then((function(r){return function(t,e,r){return new Promise((function(s,i){td("prepare");var o,a,c,d,f=(r=n.__assign({wsProbeTimeout:7e3,fallbackTimeout:9e4,uiTimeout:12e4},r)).isMobile,l=function(t){var e=t.socketUrl,n=t.longPollingUrl;if(e&&n)return{ws:e,lp:n};return e||n}(r),p={fakeChats:!1,userAgent:Bu({appVersion:r.version},f),probeTimeout:r.wsProbeTimeout,version:r.version,minFirstChats:r.minFirstChats,deviceId:r.deviceId,isMobile:f};if(r.socketUrl instanceof WebSocket&&!r.longPollingUrl){var g=r.socketUrl;if(g.readyState===WebSocket.CLOSING||g.readyState===WebSocket.CLOSED)return td("quick-fallback"),i("quick-fallback")}var v=function(){clearTimeout(e.uiTimer),clearTimeout(e.fallbackTimer),o&&(o.session.off("authStart",_),o.session.off("authFail",I),o.session.off("authorize",k),o.session.off("start",E))},m=function(t,e){v(),td(t),"string"==typeof e?(td(t,e),"".concat(t,".").concat(e),r.uid):r.uid;var n="".concat(t,".").concat(ed(o),".").concat(function(t){if(t){if("string"==typeof t)return t;var e=[];return["type","code","wasClean","reason","message","name","stack"].forEach((function(n){n in t&&e.push("".concat(n,": ").concat(t[n]))})),e.join(", ")}return null}(e));"undefined"!=typeof OK&&OK.logger.success("messagesLayer","flbck-transport",n),c&&c(),o&&o.stop(),i(n),d&&("string"==typeof e&&d.push("Fail due to error ".concat(e,", session state: ").concat(o.session.state)),t&&d.push("Failed at state ".concat(t)),d.dispose(!0))},y=function(){v(),td("show"),r.uid,c=function(t,e){void 0===e&&(e=3e3);var n,r,s=function(){null==n||Date.now()-n>2*e&&t.ping(),n=Date.now(),r=setTimeout(s,e)};return s(),function(){clearTimeout(r)}}(o,nd(o)?7e3:3e3),s(o),d&&d.dispose()},_=function(){clearTimeout(e.fallbackTimer),td("authorize-start"),d&&d.push("Auth start")},I=function(t){d&&d.push("Auth fail"),m("authorize-fail",t.code)},k=function(){clearTimeout(e.uiTimer),clearTimeout(e.fallbackTimer),td("authorize"),d&&d.push("Authorized")},E=function(){td("frame-ready"),y()},S=!1,w=Wu("app-start");try{var C=function(t,e,r){if(r||function(t){if(-1!==location.hash.indexOf("hard-reset"))return!0;if(t&&t.version!==ju){var e=function(t,e){if(t!==e)for(var n=Vu(t),r=Vu(e),s=0;s<Hu.length;s++)if(n[s]!==r[s])return Hu[s];return null}(t.version,ju);if("major"===e||"minor"===e)return!0;if(t.chatList.length>Zu)return!0}return!1}(t)||e.hardReset){var s=t&&t.auth;if(s){var i=e.isMobile;t={auth:s,config:t.config?n.__assign(n.__assign({},t.config),{hash:null}):null,version:t.version,userAgent:Bu({appVersion:e.version},i).deviceType,isMobile:i}}else t=null}return t}(t,r),M=(o=qu(l,C,p)).getState().chatList;S=!!M&&M.length>0}catch(t){a=t,t&&r.uid,console.warn("Ошибка при восстановлении приложения",t)}if(!o)try{o=qu(l,null,p),a&&(o.stats.log.error("STATE_RESTORE",a.message),o.stats.action("STATE_RESTORE"))}catch(t){return w(),m("model-error",t)}if(w(),d=function(t,e){var n,r=[],s=Date.now(),i=!1,o=!1,a=function(t,e){if(!i&&null!=t&&r.length<1e3){var n=Date.now();e||(t+=" +".concat(((n-s)/1e3).toFixed(2),"s")),r.push(String(t)),s=n}};a("UID: ".concat(e.uid),!0),a("Version: ".concat(e.version),!0),a("Initial transport: ".concat(ed(t)),!0);var c=t.transport,u=t.session,d=function(){return a("Connection opened")},h=function(){return a("Stream connected")},f=function(){return a("Stream disconnected")},l=function(){return a("Connection closed")},p=function(t){a("OUT: ".concat(rd(t)));try{var e=JSON.parse(t);19===e.opcode&&(n&&n(),n=_(e.payload.token))}catch(t){}},g=function(t){if(a("IN: ".concat(rd(t,!0))),n)try{19===JSON.parse(t).opcode&&(n(),n=null)}catch(t){}},v=function(t){return a("ERROR: ".concat(t?t.message||t.code:t))},m=function(t,e){"use-longpolling"===e?a("Set transport to Long Polling"):"use-websocket"===e&&a("Set transport to Web Sockets"),"long-polling"===t&&e&&e.url&&a("XHR ".concat(e.cmd).concat(e.status?" ("+e.status+")":"",": ").concat(e.url))},y=function(t){o=!0,a("No login response, retry ".concat(t))},_=function(e,n){void 0===n&&(n=4e3);var r,s=!1,i=function(){"websocket"===ed(t)&&t.transport.connected&&(t.transport.send("PING ".concat(e," ").concat(Date.now())),s||(r=setTimeout(i,n)))};return i(),function(){s=!0,clearTimeout(r)}};return c.on("open",d),c.on("close",l),c.on("connect",h),c.on("disconnect",f),c.on("send",p),c.on("message",g),c.on("error",v),c.on("log",m),u.on("retry",y),{push:a,dispose:function(s){if(i=!0,s||o){var a=r.join("\n"),_=s?"MSG_TRANSPORT_LOG":"MSG_RETRY_LOG";t.stats.log.error(_,a),e.uid}r.length=0,n&&n(),c.off("open",d),c.off("close",l),c.off("connect",h),c.off("disconnect",f),c.off("send",p),c.off("message",g),c.off("error",v),c.off("log",m),u.off("retry",y)}}}(o,r),o.session.stream.once("connect",(function(){return clearTimeout(e.fallbackTimer)})),o.session.once("authStart",_),o.session.once("authFail",I),o.session.on("authorize",k),o.session.once("start",E),o.transport.on("log",(function(t,e){return function(t,e,n,r){if("use-websocket"===n)td("use-websocket");else if("use-longpolling"===n)td("use-longpolling");else if("long-polling"===e&&n&&"object"==typeof n){var s=n.message;if("reset-session"===s||"reset-session.no-internet"===s)td("reset-session"),"reset-session.no-internet"===s&&td("reset-session.no-internet"),"MESSENGER_LONG_POLLING: Reset session\\nConnection ID: ".concat(n.connectionId,"\\nUID: ").concat(r.uid),r.uid,null!=n.ops&&Xu("lp-ops",n.ops);else if("host-changed"===s)td("host-changed"),"MESSENGER_LONG_POLLING: Host changed from ".concat(n.prev," to ").concat(n.next,"\\nConnection ID: ").concat(n.connectionId,"\\nUID: ").concat(r.uid),r.uid,t.stats.log.error("LP_HOST","Long-polling host changed from ".concat(n.prev," to ").concat(n.next,"\\nConnection ID: ").concat(n.connectionId,"\\nUID: ").concat(r.uid));else if("handshake-fail"===s&&n.attempt<5){var i="a".concat(n.attempt);n.err&&n.err.code&&(i+="e".concat(n.err.code)),td("handshake-fail",i);var o=n.err&&n.err.code||"none",a=n.err&&n.err.message||"none";"HANDSHAKE_FAIL: Unable to handshake with Long Polling server\\nAttempt: ".concat(n.attempt,"\\nError code: ").concat(o,"\\nError message: ").concat(a,"\\nUID: ").concat(r.uid),r.uid}}}(o,t,e,r)})),o.transport.on("connect",(function(t){t&&Xu("connect-".concat(ed(o)),t)})),o.session.once("authorize",Wu("authorize")),u()){var b=o.getState().config.server,T=b&&b["instant-model-save"];o.subscribe(zu((function(){var t=o.getState().chatList;if((null==t?void 0:t.length)>Zu)h(r.uid,null);else{var e=o.serialize();e.selectedChat=void 0,e.version=ju,h(r.uid,e)}}),3e3,{leading:T}))}if(td("app-ready"),S&&r.quickStart)td("quick-start"),d&&d.push("Quick start"),y();else{var O=r.fallbackTimeout,A=r.uiTimeout;O>0&&(e.fallbackTimer=setTimeout((function(){e.fallbackTimer=null,m("fallback",o&&o.session.state),nd(o)&&td("fallback-lp")}),O)),A>0&&(e.uiTimer=setTimeout((function(){e.uiTimer=null,m("fail",o&&o.session.state)}),A))}}))}(r,e,t)})).catch((function(n){throw clearTimeout(e.fallbackTimer),clearTimeout(e.uiTimer),n&&"string"!=typeof n&&(td("js-error"),n.message&&(n.message,t.uid)),n}))}};e.FILTER_ALL=No,e.cache=l,e.clob=$u,e.createAnimojiCid=Du,e.debounce=function(t,e,n){var r;return void 0===e&&(e=50),void 0===n&&(n={}),function(){for(var s=arguments,i=[],o=0;o<arguments.length;o++)i[o]=s[o];var a=this,c=n.isImmediate&&void 0===r;void 0!==r&&clearTimeout(r),r=setTimeout((function(){r=void 0,n.isImmediate||t.apply(a,i)}),e),c&&t.apply(a,i)}},e.getCurrentUserQuarter=function(t){var e=function(t){return 255&t.store.get().auth.profile.id}(t);return Math.floor(e/64)+1},e.getDeviceName=Gu,e.getOSVersion=Ku,e.invoke=sc,e.isDesktopVersion=function(t){void 0===t&&(t="1.0.0");var e=navigator.userAgent.match(/^TamTam App (\d+\.\d+\.\d+)/);return e&&-1!==function(t,e){if(t!==e)for(var n=Vu(t),r=Vu(e),s=0,i=void 0,o=void 0;s<3;s++)if((i=n[s]||0)!==(o=r[s]||0))return i<o?-1:1;return 0}(e[1],t)},e.isEmptyEdit=us,e.isEmptyPosting=cs,e.log=Qu,e.logTime=Wu,e.model=id,e.supportsCache=u,e.throttle=zu,e.userAgent=Bu,e.xor64=tt}));
//# sourceMappingURL=model_8c0b0872.js.map
